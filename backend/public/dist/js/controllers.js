
var ML=null;(function($a){'use strict';ML=$a.module('ML',['ngRoute','ngAnimate','ngSanitize','ngCkeditor','ui.bootstrap','LocalStorageModule','ML.filters','ML.services','ML.directives','ML.controllers','markdown','ngClipboard','ngPrettyJson','cfp.hotkeys','colorpicker.module']);ML.config(function($routeProvider,$locationProvider,$compileProvider,$tooltipProvider,localStorageServiceProvider){$routeProvider.when('/landing',{templateUrl:'/partials/landing_page/index.html',controller:'landingpage'}).when('/emails',{templateUrl:'/partials/emails/index.html',controller:'emails'}).when('/users/info',{templateUrl:'/partials/info/index.html',controller:'info'}).when('/messages',{templateUrl:'/partials/messages/index.html',controller:'messages'}).when('/messages/report',{templateUrl:'/partials/messages/report.html',controller:'pushMessageReport'}).when('/clientkey',{templateUrl:'/partials/client_key/index.html',controller:'clientKey'}).when('/events',{templateUrl:'/partials/events/index.html',controller:'events'}).when('/currency',{templateUrl:'/partials/currency/index.html',controller:'currency'}).when('/icons',{templateUrl:'/partials/icons/index.html',controller:'icons'}).when('/icons/info-maker',{templateUrl:'/partials/icons/info_maker.html',controller:'iconsInfoMaker'}).when('/bank',{templateUrl:'/partials/bank/index.html',controller:'bank'}).when('/users',{templateUrl:'/partials/users/index.html',controller:'users'}).when('/stats/:status',{templateUrl:'/partials/stats/index.html',controller:'Stats'}).when('/userbankmsg',{templateUrl:'/partials/userbankmsg/index.html',controller:'userbankmsg'}).when('/bonus',{templateUrl:'/partials/bonus/index.html',controller:'bonus'}).when('/find',{templateUrl:'/partials/find/index.html',controller:'find'}).when('/admin',{templateUrl:'/partials/admin/index.html',controller:'admin'}).when('/purchaselog',{templateUrl:'/partials/purchaselog/index.html',controller:'purchaselog'}).when('/premiumlog',{templateUrl:'/partials/premiumlog/index.html',controller:'premiumlog'}).when('/wallet-stats',{templateUrl:'/partials/walletstats/index.html',controller:'walletstats'}).when('/send-premium-code',{templateUrl:'/partials/users/send-code-active-email.html',controller:'sendpremiumcode'}).when('/user-tag-manager',{templateUrl:'/partials/tags/index.html',controller:'userTagManager'}).when('/server-setting',{templateUrl:'/partials/setting/index.html',controller:'serverSetting'}).when('/helpdesk/issue',{templateUrl:'/partials/helpdesk/issue/index.html',controller:'helpdeskIssue'}).when('/helpdesk/issue_details/:issue_id',{templateUrl:'/partials/helpdesk/issue/issue_details.html',controller:'helpdeskIssueDetails'}).when('/helpdesk/section',{templateUrl:'/partials/helpdesk/section/index.html',controller:'helpDeskFaqSection'}).when('/helpdesk/faq',{templateUrl:'/partials/helpdesk/faq/index.html',controller:'helpdeskFaq'}).when('/helpdesk/faq/create',{templateUrl:'/partials/helpdesk/faq/faq_details.html',controller:'helpdeskFaqDetail'}).when('/helpdesk/faq/edit/:faq_id',{templateUrl:'/partials/helpdesk/faq/faq_details.html',controller:'helpdeskFaqDetail'}).when('/helpdesk/stats',{templateUrl:'/partials/helpdesk/stats/index.html',controller:'helpdeskStats'}).when('/helpdesk/edit-auto-reply-messages',{templateUrl:'/partials/helpdesk/setting/edit-auto-reply-messages.html',controller:'helpdeskEditAutoReplyMessages'}).when('/sync-fail-log',{templateUrl:'/partials/sync_fail_log/index.html',controller:'SyncFailLog'}).when('/sync-fail-log/:id',{templateUrl:'/partials/sync_fail_log/detail.html',controller:'SyncFailDetail'}).when('/lucky',{templateUrl:'/partials/lucky/index.html',controller:'lucky'}).when('/mac-beta',{templateUrl:'/partials/mac-beta/index.html',controller:'macBeta'}).when('/subscription-products',{templateUrl:'/partials/subscription-product/index.html',controller:'subscriptionProduct'}).when('/subscription-log',{templateUrl:'/partials/subscription-log/index.html',controller:'subscriptionLog'}).when('/subscription-stats',{templateUrl:'/partials/subscription-stats/index.html',controller:'subscriptionStats'}).when('/subscription-code',{templateUrl:'/partials/subscription-code/index.html',controller:'subscriptionCode'}).when('/logsync',{templateUrl:'/partials/log_sync/index.html',controller:'LogSync'}).when('/logsync/:id',{templateUrl:'/partials/log_sync/detail.html',controller:'LogSyncDetail'}).when('/coupon',{templateUrl:'/partials/coupon/index.html',controller:'coupon'}).when('/remote-wallet/service',{templateUrl:'/partials/rw-provider/index.html',controller:'rwProvider'}).when('/remote-wallet/request',{templateUrl:'/partials/rw-provider/request.html',controller:'rwRequest'}).when('/remote-wallet/list',{templateUrl:'/partials/info/remote-wallet-list.html',controller:'rwList'}).when('/test-shoeboxed',{templateUrl:'/partials/shoeboxed/index.html',controller:'shoeboxed'}).when('/systems-info',{templateUrl:'/partials/setting/systems-info.html',controller:'systemsinfo'}).when('/wallet-diagnosis',{templateUrl:'/partials/info/wallet_diagnosis.html',controller:'walletDiagnosis'}).when('/devices',{templateUrl:'/partials/device/devices.html',controller:'user_devices'}).when('/changelog',{templateUrl:'/partials/setting/changelog.html',controller:'changelog'}).when('/change-email',{templateUrl:'/partials/change_email/index.html',controller:'change_email'}).when('/search-query',{templateUrl:'/partials/search_query/index.html',controller:'searchQuery'}).when('/search-query/details',{templateUrl:'/partials/search_query/details.html',controller:'searchQueryDetails'}).when('/image-manager',{templateUrl:'/partials/images/index.html',controller:'images'}).when('/push-notification-request',{templateUrl:'/partials/push_notification_request/index.html',controller:'pnRequest'}).when('/milestone',{templateUrl:'/partials/setting/milestone.html',controller:'mileStone'}).when('/query-compare',{templateUrl:'/partials/query_compare/index.html',controller:'queryCompare'}).when('/notification-fail',{templateUrl:'/partials/dashboard/notification_log.html',controller:'NotificationFail'}).when('/partners',{templateUrl:'/partials/partners/index.html',controller:'Partners'}).when('/active',{templateUrl:'/partials/active/index.html',controller:'ActiveUsers'}).when('/receipt',{templateUrl:'/partials/receipt/receipt-list.html',controller:'receiptList'}).when('/receipt/ranking',{templateUrl:'/partials/receipt/ranking.html',controller:'receiptRanking'}).when('/classification-log',{templateUrl:'/partials/classification_logs/list.html',controller:'classification_logs'}).when('/receipt/details/:id',{templateUrl:'/partials/receipt/receipt-detail.html',controller:'receiptDetails'}).when('/use-credits',{templateUrl:'/partials/use_credit/index.html',controller:'UseCredit'}).when('/uncategorized-transaction',{templateUrl:'/partials/uncategorized_transaction/index.html',controller:'UncategorizedTransaction'}).when('/premium-products',{templateUrl:'/partials/premium_products/index.html',controller:'PremiumProducts'}).when('/item-log',{templateUrl:'/partials/item_log/index.html',controller:'ItemLog'}).when('/item-chart',{templateUrl:'/partials/item_chart/index.html',controller:'ItemChart'}).when('/transaction',{templateUrl:'/partials/transaction/index.html',controller:'Transaction'}).when('/check-purchase-bill',{templateUrl:'/partials/check_purchase_bill/index.html',controller:'checkPurchaseBill'}).when('/dashboard/users',{templateUrl:'/partials/dashboard/user_detail.html',controller:'dashboardUser'}).when('/dashboard/linked-wallet',{templateUrl:'/partials/dashboard/linked_wallet_detail.html',controller:'dashboardLinkedWallet'}).when('/dashboard/premium',{templateUrl:'/partials/dashboard/premium_detail.html',controller:'dashboardPremium'}).when('/dashboard/platform',{templateUrl:'/partials/dashboard/platform_detail.html',controller:'dashboardPlatform'}).when('/dashboard/transaction',{templateUrl:'/partials/dashboard/transaction_detail.html',controller:'dashboardTransaction'}).when('/dashboard/wallet',{templateUrl:'/partials/dashboard/wallet_detail.html',controller:'dashboardWallet'}).when('/tags',{templateUrl:'/partials/tags/index.html',controller:'tags'}).when('/provider-country-code',{templateUrl:'/partials/file_provider/index.html',controller:'provider'}).when('/provider-country-code/category/:provider',{templateUrl:'/partials/file_provider/pick_category.html',controller:'providerCategory'}).when('/provider-country-code/provider/:categoryId/:country',{templateUrl:'/partials/file_provider/provider_list.html',controller:'providerData'}).when('/gift',{templateUrl:'/partials/gift/index.html',controller:'Gift'}).when('/exception',{templateUrl:'/partials/exception/index.html',controller:'exception'}).when('/email_push_automation',{templateUrl:'/partials/email_push_automation/index_new.html',controller:'email_push_automation'}).when('/register_dev_ml',{templateUrl:'/partials/open_api/register_partner.html',controller:'register_dev_ml'}).when('/automation_log',{templateUrl:'/partials/email_push_automation/log.html',controller:'automation_log'}).when('/discount',{templateUrl:'/partials/discount/index.html',controller:'discountController'}).when('/subscription_renew_log',{templateUrl:'/partials/renewable_log/index.html',controller:'subscriptionRenewLogController'}).when('/campaign',{templateUrl:'/partials/campaign/index.html',controller:'campaignMarketingCtrl'}).when('/group',{templateUrl:'/partials/group/index.html',controller:'groupMarketingCtrl'}).when('/',{templateUrl:'/partials/dashboard/index.html',controller:'dashboard'}).otherwise({redirectTo:'/'});localStorageServiceProvider.setPrefix('ML.Backend');$locationProvider.html5Mode(true);$tooltipProvider.options({appendToBody:true});});ML.run(['$rootScope','$templateCache','Page','MoneyLover','notificationService','$http',function($rootScope,$templateCache,Page,MoneyLover,notificationService,$http){$rootScope.MLTitle=((env!=='production')?'['+env.toUpperCase()+']':'')+'Money Lover Headquarter';$rootScope.$watch(function(){return notificationService.getNotification();},function(newValue){$rootScope.MLTitle=((env!=='production')?'['+env.toUpperCase()+']':'')+((newValue)?"("+newValue+")":"")+" Money Lover Headquarter";});$rootScope.MLPageDetail='Dashboard';$rootScope.MLAuthor=Page.author;$rootScope.MLDescription=Page.description;$rootScope.MLKeyword=Page.keyword;$rootScope.tabSelect=1;$rootScope.$on('$viewContentLoaded',function(){loadPermission();});function loadPermission(){$http.post('/permission/load').success(function(data){$rootScope.$broadcast('adminPermission',data);}).error(function(){alert("Error From Server");});};$rootScope.editorOptions={language:'vi',height:230,forcePasteAsPlainText:true,toolbar:[{name:'document',groups:['mode','document','doctools'],items:['Source','-','Save','NewPage','Preview','Print','-','Templates']},{name:'clipboard',groups:['clipboard','undo'],items:['Cut','Copy','Paste','PasteText','PasteFromWord','-','Undo','Redo']},{name:'editing',groups:['find','selection','spellchecker'],items:['Find','Replace','-','SelectAll','-','Scayt']},{name:'forms',items:['Form','Checkbox','Radio','TextField','Textarea','Select','Button','ImageButton','HiddenField']},'/',{name:'basicstyles',groups:['basicstyles','cleanup'],items:['Bold','Italic','Underline','Strike','Subscript','Superscript','-','RemoveFormat']},{name:'paragraph',groups:['list','indent','blocks','align','bidi'],items:['NumberedList','BulletedList','-','Outdent','Indent','-','Blockquote','CreateDiv','-','JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock','-','BidiLtr','BidiRtl','Language']},{name:'links',items:['Link','Unlink','Anchor']},{name:'insert',items:['Image','Flash','Table','HorizontalRule','Smiley','SpecialChar','PageBreak','Iframe']},'/',{name:'styles',items:['Styles','Format','Font','FontSize']},{name:'colors',items:['TextColor','BGColor']},{name:'tools',items:['Maximize','ShowBlocks']},{name:'others',items:['-']}],toolbarGroups:[{name:'document',groups:['mode','document','doctools']},{name:'clipboard',groups:['clipboard','undo']},{name:'editing',groups:['find','selection','spellchecker']},{name:'forms'},'/',{name:'basicstyles',groups:['basicstyles','cleanup']},{name:'paragraph',groups:['list','indent','blocks','align','bidi']},{name:'links'},{name:'insert'},'/',{name:'styles'},{name:'colors'},{name:'tools'},{name:'others'}]};}]);}(angular));(function($a){'use strict';$a.module('ML.controllers',[])}(angular));(function($a){'use strict';var MLdirectives=$a.module('ML.directives',[]);MLdirectives.directive('appVersion',['version',function(version){return function(scope,elm,attrs){elm.text(version);};}]);MLdirectives.directive('autoFillableField',function(){return{restrict:"A",require:"?ngModel",link:function(scope,element,attrs,ngModel){setInterval(function(){var prev_val='';if(!angular.isUndefined(attrs.xAutoFillPrevVal)){prev_val=attrs.xAutoFillPrevVal;}
if(element.val()!=prev_val){if(!angular.isUndefined(ngModel)){if(!(element.val()==''&&ngModel.$pristine)){attrs.xAutoFillPrevVal=element.val();scope.$apply(function(){ngModel.$setViewValue(element.val());});}}else{element.trigger('input');element.trigger('change');element.trigger('keyup');attrs.xAutoFillPrevVal=element.val();}}},300);}};});MLdirectives.directive('mlMsg',function($compile){return{restrict:'E',link:function(scope,element,attrs){scope.$watch(function(scope){return scope.$eval(attrs.mlBindContent);},function(value){element.html(value);$compile(element.contents())(scope);});}};});MLdirectives.directive('setElementInView',function($window){var $win=angular.element($window);return{restrict:'A',link:function(scope,element,attrs){var inView=attrs.setElementInView,offsetTop=element.offset().top;$win.on('scroll',function(e){if($win.scrollTop()>=offsetTop){element.css({"position":"fixed","top":"10px",'right':"0",'padding':'0 20px 0 38px'});}else{element.css({"position":"inherit",'padding':'0 15px'});}});}};});MLdirectives.directive('mlAlert',function($compile){return{restrict:'E',link:function(scope,element,attrs){scope.$watch(function(scope){});}};});MLdirectives.directive('mlPreviewIframe',function($compile){return{restrict:'E',templateUrl:'/partials/emails/template.html',link:function(scope,element,attrs){scope.$watch(attrs.content,function(value){scope.contentMailPreview=value;var now=new Date();scope.year=now.getFullYear().toString();});}};});MLdirectives.directive('fileModel',function($parse){return{restrict:'A',link:function(scope,element,attrs){var model=$parse(attrs.fileModel);var modelSetter=model.assign;element.bind('change',function(){scope.$apply(function(){modelSetter(scope,element[0].files[0]);});});}};});MLdirectives.directive('uploadIcon',function($parse,$http){return{restrict:'A',link:function(scope,element,attrs){var packages=attrs.uploadIcon;var oldValue=attrs.oldValue;var uploadType=attrs.uploadType;var model=$parse(attrs.packageModel);var refeshModel=model.assign;element.on('change',function(){var fd=new FormData();fd.append('filedata',element[0].files[0]);fd.append('uploadtype',uploadType);fd.append('packagename',packages);fd.append('oldvalue',oldValue);$http.post('/icons/upload',fd,{headers:{'Content-Type':undefined},transformRequest:$a.identity}).success(function(data,status){if(data.s){refeshModel(scope,data.d);}else{alert('Error');}}).error(function(){alert('Error');});});}};});MLdirectives.directive('uploadLogo',function($parse,$http){return{restrict:'A',link:function(scope,element,attrs){var img=attrs.uploadLogo;var oldValue=attrs.oldValue;var model=$parse(attrs.packageModel);var refeshModel=model.assign;element.on('change',function(){var fd=new FormData();fd.append('filedata',element[0].files[0]);fd.append('oldvalue',oldValue);$http.post('/sponsored/upload-logo',fd,{headers:{'Content-Type':undefined},transformRequest:$a.identity}).success(function(data,status){if(data.s){refeshModel(scope,data.d);}else{alert('Error');}}).error(function(){alert('Error');});});}};});MLdirectives.directive('autoComplete',function($http){return{restrict:'AE',scope:{selectedTags:'=model',tags:'@taginit'},templateUrl:'/partials/users/tagAutoComplete.html',link:function(scope,elem,attrs){if(scope.tags){scope.tags=JSON.parse(scope.tags);}
scope.suggestions=[];scope.selectedTags=scope.tags||[];scope.selectedIndex=-1;scope.removeTag=function(index){scope.selectedTags.splice(index,1);};scope.search=function(){$http.get(attrs.url+'?term='+scope.searchText).success(function(data){if(data.indexOf(scope.searchText)===-1){data.unshift(scope.searchText);}
scope.suggestions=data;scope.selectedIndex=-1;});};scope.addToSelectedTags=function(index){if(scope.selectedTags.indexOf(scope.suggestions[index])===-1){scope.selectedTags.push(scope.suggestions[index]);scope.searchText='';scope.suggestions=[];}};scope.checkKeyDown=function(event){if(event.keyCode===40){event.preventDefault();if(scope.selectedIndex+1!==scope.suggestions.length){scope.selectedIndex++;}}
else if(event.keyCode===38){event.preventDefault();if(scope.selectedIndex-1!==-1){scope.selectedIndex--;}}
else if(event.keyCode===13){scope.addToSelectedTags(scope.selectedIndex);}};scope.$watch('selectedIndex',function(val){if(val!==-1){scope.searchText=scope.suggestions[scope.selectedIndex];}});}}});MLdirectives.directive('notificationCard',function(){return{restrict:'E',scope:{data:'=data',index:'@',onCloseNotify:'&onClose'},templateUrl:'/partials/global/notification-card.html',link:function(scope,element,attribute,ctrl){scope.close=scope.onCloseNotify;}}});MLdirectives.directive('loading',function(){return{restrict:'E',template:'<div class="text-center"><img src="/images/loading-pacman.gif" /><br />Loading</div>'}});MLdirectives.directive('autofocus',function(){return{restrict:'A',link(scope,elm,attr,ctrl){setTimeout(function(){elm[0].focus();},1000);}};});}(angular));(function($a){'use strict';var deviceOS=[{id:1,name:'Android',device:[{name:'Kitkat',version:'4.4 - 4.4.2',api:19},{name:'Jelly Bean',version:'4.3.x',api:18},{name:'Jelly Bean',version:'4.2.x',api:17},{name:'Jelly Bean',version:'4.1.x',api:16},{name:'Ice Cream Sandwich',version:'4.0.3 - 4.0.4',api:15},{name:'Ice Cream Sandwich',version:'4.0.1 - 4.0.2',api:14},{name:'Honeycomb',version:'3.2.x',api:13},{name:'Honeycomb',version:'3.1',api:12},{name:'Honeycomb',version:'3.0',api:11}]},{id:2,name:'iOS',device:[{name:'Okemo',version:'8.0',api:8.0},{name:'Sochi',version:'7.1',api:7.1},{name:'Innsbruck',version:'7.0',api:7.0},{name:'Brighton',version:'6.1',api:6.1},{name:'Sundance',version:'6.0',api:6.0},{name:'Hoodoo',version:'5.1',api:5.1},{name:'Telluride',version:'5.0',api:5.0}]},{id:3,name:'Winphone'}];var currencies=[{"c":"USD","s":"$","n":"United States Dollar","t":0,"i":1},{"c":"GBP","s":"£","n":"Pound","t":0,"i":2},{"c":"EUR","s":"€","n":"Euro","t":0,"i":3},{"c":"VND","s":"₫","n":"Việt Nam Đồng","t":1,"i":4},{"c":"CNY","s":"¥","n":"Yuan Renminbi","t":0,"i":5},{"c":"JPY","s":"¥","n":"Yen","t":0,"i":6},{"c":"BRL","s":"R$","n":"Reais","t":0,"i":7},{"c":"RUB","s":"руб","n":"Rubles","t":0,"i":8},{"c":"KRW","s":"₩","n":"Won","t":0,"i":9},{"c":"THB","s":"฿","n":"Baht","t":0,"i":10},{"c":"INR","s":"₹","n":"India Rupee","t":0,"i":11},{"c":"CHF","s":"Fr.","n":"Francs","t":0,"i":12},{"c":"DKK","s":"Kr","n":"Kroner","t":0,"i":13},{"c":"SEK","s":"kr","n":"Sweden Krona","t":0,"i":14},{"c":"PLN","s":"zł","n":"Poland Zlotych","t":0,"i":15},{"c":"HUF","s":"Ft","n":"Hungary Forint","t":0,"i":16},{"c":"NOK","s":"kr","n":"Norwegian krone","t":0,"i":17},{"c":"BYR","s":"BYR","n":"Belarusian ruble","t":0,"i":18},{"c":"DZD","s":"DZD","n":"Algerian Dinar","t":0,"i":19},{"c":"AUD","s":"$","n":"Australia Dollars","t":0,"i":20},{"c":"AZN","s":"ман","n":"Azerbaijan New Manats","t":0,"i":21},{"c":"ARS","s":"$","n":"Argentina Pesos","t":0,"i":22},{"c":"BDT","s":"BDT","n":"Bangladeshi taka","t":0,"i":23},{"c":"BOB","s":"$b","n":"Bolivianos","t":0,"i":24},{"c":"BGN","s":"лв","n":"Bulgarian lev","t":0,"i":25},{"c":"CAD","s":"C$","n":"Canada Dollars","t":0,"i":26},{"c":"CRC","s":"₡","n":"Colon","t":0,"i":27},{"c":"HRK","s":"kn","n":"Croatian kuna","t":0,"i":28},{"c":"CLP","s":"$","n":"Chile Pesos","t":0,"i":29},{"c":"COP","s":"$","n":"Colombia Pesos","t":0,"i":30},{"c":"CZK","s":"Kč","n":"Česká koruna","t":0,"i":31},{"c":"MNT","s":"₮","n":"Tugriks","t":0,"i":32},{"c":"HNL","s":"L","n":"Lempiras","t":0,"i":33},{"c":"MAD","s":"MAD","n":"Moroccan Dirham","t":0,"i":34},{"c":"MXN","s":"$","n":"Mexico Pesos","t":0,"i":35},{"c":"NGN","s":"₦","n":"Nairas","t":0,"i":36},{"c":"NZD","s":"NZ$","n":"New Zealand Dollars","t":0,"i":37},{"c":"HKD","s":"HK$","n":"Hong Kong Dollars","t":0,"i":38},{"c":"LAK","s":"₭","n":"Lao kip","t":0,"i":39},{"c":"KES","s":"KSh","n":"Kenya Shilling","t":0,"i":40},{"c":"DOP","s":"RD$","n":"Dominican Republic Pesos","t":0,"i":41},{"c":"GHS","s":"GH₵","n":"Ghana Cedi","t":0,"i":42},{"c":"ILS","s":"₪","n":"Israel New Shekels","t":0,"i":43},{"c":"IDR","s":"Rp","n":"Indonesia Rupiah","t":0,"i":44},{"c":"IRR","s":"IRR","n":"Iranian Rial","t":0,"i":45},{"c":"JOD","s":"JOD","n":"Jordanian dinar","t":0,"i":46},{"c":"KGS","s":"лв","n":"Kyrgyzstan Soms","t":0,"i":47},{"c":"LVL","s":"Ls","n":"Latvia Lati","t":0,"i":48},{"c":"LTL","s":"Lt","n":"Lithuania Litai","t":0,"i":49},{"c":"MKD","s":"ден","n":"Macedonia Denars","t":0,"i":50},{"c":"MZN","s":"MT","n":"Mozambique Meticais","t":0,"i":51},{"c":"MYR","s":"RM","n":"Malaysia Ringgits","t":0,"i":52},{"c":"ANG","s":"NAƒ","n":"Netherlands Antilles Guilders","t":0,"i":53},{"c":"TWD","s":"NT$","n":"New Taiwan Dollar","t":0,"i":54},{"c":"NIO","s":"C$","n":"Nicaragua Cordobas","t":0,"i":55},{"c":"NPR","s":"NRs","n":"Nepalese Rupee","t":0,"i":56},{"c":"OMR","s":"﷼","n":"Oman Rials","t":0,"i":57},{"c":"PAB","s":"B/.","n":"Panama Balboa","t":0,"i":58},{"c":"PHP","s":"₱","n":"Philippines Pesos","t":0,"i":59},{"c":"PYG","s":"Gs","n":"Paraguay Guarani","t":0,"i":60},{"c":"PEN","s":"S/.","n":"Peru Nuevos Soles","t":0,"i":61},{"c":"QAR","s":"QR","n":"Qatar riyal","t":0,"i":62},{"c":"RON","s":"lei","n":"Romanian Leu","t":0,"i":63},{"c":"TTD","s":"TT$","n":"Trinidad and Tobago Dollars","t":0,"i":64},{"c":"TRY","s":"TL.","n":"Turkish Liras","t":0,"i":65},{"c":"TND","s":"DT","n":"Tunisian dinar","t":0,"i":66},{"c":"UAH","s":"₴","n":"Ukraine Hryvnia","t":0,"i":67},{"c":"UYU","s":"$U","n":"Uruguay Pesos","t":0,"i":68},{"c":"AED","s":"AED","n":"United Arab Emirates dirham","t":0,"i":69},{"c":"VEF","s":"Bs","n":"Venezuela Bolivares Fuertes","t":0,"i":70},{"c":"KZT","s":"T","n":"Kazakhstani tenge","t":0,"i":71},{"c":"RSD","s":"din.","n":"Serbia Dinar","t":0,"i":72},{"c":"SAR","s":"SR","n":"Saudi Arabian Riyal","t":0,"i":73},{"c":"SKK","s":"SKK","n":"Slovak crown","t":0,"i":74},{"c":"ZAR","s":"R","n":"South African rand","t":0,"i":75},{"c":"SGD","s":"S$","n":"Singapore Dollars","t":0,"i":76},{"c":"LKR","s":"Rs","n":"Sri Lanka rupee","t":0,"i":77},{"c":"ZMK","s":"ZK","n":"Zambian kwacha","t":0,"i":78},{"c":"LBP","s":"LBP","n":"Lebanese Pound","t":0,"i":79},{"c":"KWD","s":"K.D","n":"Kuwaiti Dinar","t":0,"i":80},{"t":0,"n":"Afghan afghani","s":"AFN","c":"AFN","i":81},{"t":0,"s":"ALL","c":"ALL","n":"Albanian lek","i":82},{"t":0,"n":"Angolan kwanza","s":"AOA","c":"AOA","i":83},{"t":0,"s":"EC$","c":"XCD","n":"East Caribbean dollar","i":84},{"t":0,"s":"AMD","c":"AMD","n":"Armenian dram","i":85},{"t":0,"s":"ƒ","c":"AWG","n":"Aruban florin","i":86},{"t":0,"s":"B$","c":"BSD","n":"Bahamian dollar","i":87},{"t":0,"s":"BHD","c":"BHD","n":"Bahraini dinar","i":88},{"t":0,"s":"Bds","c":"BBD","n":"Barbadian dollar","i":89},{"t":0,"s":"BZ$","c":"BZD","n":"Belize dollar","i":90},{"t":0,"s":"XOF","c":"CFA","n":"West African CFA franc","i":91},{"t":0,"s":"BD$","c":"BMD","n":"Bermudian dollar","i":92},{"t":0,"s":"Nu.","c":"BTN","n":"Bhutanese ngultrum","i":93},{"t":0,"s":"KM","c":"BAM","n":"Bosnia and Herzegovina konvertibilna marka","i":94},{"t":0,"s":"P","c":"BWP","n":"Botswana pula","i":95},{"t":0,"s":"B$","n":"Brunei dollar","c":"BND","i":96},{"t":0,"s":"FBu","c":"BIF","n":"Burundi franc","i":97},{"t":0,"s":"KHR","n":"Khmer riel","c":"KHR","i":98},{"t":0,"s":"Esc","c":"CVE","n":"Cape Verdean escudo","i":99},{"t":0,"s":"KY$","c":"KYD","n":"Cayman Islands dollar","i":100},{"t":0,"s":"KMF","c":"KMF","n":"Comorian franc","i":101},{"t":0,"s":"F","c":"CDF","n":"Congolese franc","i":102},{"t":0,"n":"Cuban peso","c":"CUC","s":"$","i":103},{"t":0,"c":"DJF","s":"Fdj","n":"Djiboutian franc","i":104},{"t":0,"c":"EGP","s":"£","n":"Egyptian pound","i":105},{"t":0,"c":"GQE","s":"CFA","n":"Central African CFA franc","i":106},{"t":0,"c":"ERN","s":"Nfa","n":"Eritrean nakfa","i":107},{"t":0,"c":"EEK","s":"KR","n":"Estonian kroon","i":108},{"t":0,"c":"ETB","s":"Br","n":"Ethiopian birr","i":109},{"t":0,"c":"FKP","s":"£","n":"Falkland Islands pound","i":110},{"t":0,"c":"FJD","s":"FJ$","n":"Fijian dollar","i":111},{"t":0,"c":"XPF","s":"F","n":"CFP franc","i":112},{"t":0,"c":"XAF","s":"CFA","n":"Central African CFA franc","i":113},{"t":0,"c":"GMD","s":"D","n":"Gambian dalasi","i":114},{"t":0,"c":"GEL","s":"GEL","n":"Georgian lari","i":115},{"t":0,"c":"GIP","s":"£","n":"Gibraltar pound","i":116},{"t":0,"c":"GTQ","s":"Q","n":"Guatemalan quetzal","i":117},{"t":0,"c":"GNF","s":"FG","n":"Guinean franc","i":118},{"t":0,"c":"GYD","s":"GY$","n":"Guyanese dollar","i":119},{"t":0,"c":"HTG","s":"G","n":"Haitian gourde","i":120},{"t":0,"c":"ISK","s":"kr","n":"Icelandic króna","i":121},{"t":0,"c":"XDR","s":"SDR","n":"Special Drawing Rights","i":122},{"t":0,"c":"IQD","s":"IQD","n":"Iraqi dinar","i":123},{"t":0,"c":"JMD","s":"J$","n":"Jamaican dollar","i":124},{"t":0,"c":"KPW","n":"Korean won","s":"W","i":125},{"t":0,"c":"LSL","n":"Lesotho loti","s":"M","i":126},{"t":0,"c":"LRD","s":"L$","n":"Liberian dollar","i":127},{"t":0,"c":"LYD","s":"LD","n":"Libyan dinar","i":128},{"t":0,"c":"MOP","s":"P","n":"Macanese pataca","i":129},{"t":0,"c":"MGA","s":"FMG","n":"Malagasy ariary","i":130},{"t":0,"c":"MWK","s":"MK","n":"Malawian kwacha","i":131},{"t":0,"c":"MVR","s":"Rf","n":"Maldivian rufiyaa","i":132},{"t":0,"c":"MRO","s":"UM","n":"Mauritanian ouguiya","i":133},{"t":0,"c":"MUR","s":"Rs","n":"Mauritian rupee","i":134},{"t":0,"c":"MDL","n":"Moldovan leu","s":"MDL","i":135},{"t":0,"c":"MNT","n":"Mongolian tugrik","s":"₮","i":136},{"t":0,"c":"MZM","s":"MTn","n":"Mozambican metical","i":137},{"t":0,"c":"MMK","n":"Myanma kyat","s":"K","i":138},{"t":0,"c":"PKR","s":"Rs.","n":"Pakistani rupee","i":139},{"t":0,"c":"PGK","s":"K","n":"Papua New Guinean kina","i":140},{"t":0,"c":"RWF","s":"RF","n":"Rwandan franc","i":141},{"t":0,"c":"STD","s":"Db","n":"São Tomé and Príncipe dobra","i":142},{"t":0,"c":"SCR","s":"SR","n":"Seychellois rupee","i":143},{"t":0,"c":"SLL","n":"Sierra Leonean leone","s":"Le","i":144},{"t":0,"c":"SBD","s":"SI$","n":"Solomon Islands dollar","i":145},{"t":0,"c":"SOS","s":"Sh.","n":"Somali shilling","i":146},{"t":0,"c":"SHP","s":"£","n":"Saint Helena pound","i":147},{"t":0,"c":"SDG","s":"SDG","n":"Sudanese pound","i":148},{"t":0,"c":"SRD","n":"Surinamese dollar","s":"$","i":149},{"t":0,"c":"SZL","n":"Swazi lilangeni","s":"E","i":150},{"t":0,"c":"SYP","s":"SYP","n":"Syrian pound","i":151},{"t":0,"c":"TJS","s":"TJS","n":"Tajikistani somoni","i":152},{"t":0,"c":"TZS","s":"TZS","n":"Tanzanian shilling","i":153},{"t":0,"c":"TMT","n":"Turkmen manat","s":"m","i":154},{"t":0,"c":"UGX","s":"USh","n":"Ugandan shilling","i":155},{"t":0,"c":"UZS","s":"UZS","n":"Uzbekistani som","i":156},{"t":0,"c":"VUV","s":"VT","n":"Vanuatu vatu","i":157},{"t":0,"c":"VEB","s":"Bs","n":"Venezuelan bolivar","i":158},{"t":0,"c":"WST","s":"WS$","n":"Samoan tala","i":159},{"t":0,"c":"YER","s":"YER","n":"Yemeni rial","i":160},{"t":0,"c":"ZWR","s":"Z$","n":"Zimbabwean dollar","i":161},{"t":0,"c":"BTC","n":"Bitcoin","s":"฿","i":162},{"t":0,"c":"LTC","n":"Litecoin","s":"Ł","i":163}];var ITEM_TYPE={1:'Icon',2:'Subscription',3:'Credit',5:'Premium',6:'Semi Premium'};var COUNTRY_MAP={"AF":"Afghanistan","AX":"Aland Islands","AL":"Albania","DZ":"Algeria","AS":"American Samoa","AD":"Andorra","AO":"Angola","AI":"Anguilla","AQ":"Antarctica","AG":"Antigua And Barbuda","AR":"Argentina","AM":"Armenia","AW":"Aruba","AU":"Australia","AT":"Austria","AZ":"Azerbaijan","BS":"Bahamas","BH":"Bahrain","BD":"Bangladesh","BB":"Barbados","BY":"Belarus","BE":"Belgium","BZ":"Belize","BJ":"Benin","BM":"Bermuda","BT":"Bhutan","BO":"Bolivia","BA":"Bosnia And Herzegovina","BW":"Botswana","BV":"Bouvet Island","BR":"Brazil","IO":"British Indian Ocean Territory","BN":"Brunei Darussalam","BG":"Bulgaria","BF":"Burkina Faso","BI":"Burundi","KH":"Cambodia","CM":"Cameroon","CA":"Canada","CV":"Cape Verde","KY":"Cayman Islands","CF":"Central African Republic","TD":"Chad","CL":"Chile","CN":"China","CX":"Christmas Island","CC":"Cocos (Keeling) Islands","CO":"Colombia","KM":"Comoros","CG":"Congo","CD":"Congo, Democratic Republic","CK":"Cook Islands","CR":"Costa Rica","CI":"Cote D'Ivoire","HR":"Croatia","CU":"Cuba","CY":"Cyprus","CZ":"Czech Republic","DK":"Denmark","DJ":"Djibouti","DM":"Dominica","DO":"Dominican Republic","EC":"Ecuador","EG":"Egypt","SV":"El Salvador","GQ":"Equatorial Guinea","ER":"Eritrea","EE":"Estonia","ET":"Ethiopia","FK":"Falkland Islands (Malvinas)","FO":"Faroe Islands","FJ":"Fiji","FI":"Finland","FR":"France","GF":"French Guiana","PF":"French Polynesia","TF":"French Southern Territories","GA":"Gabon","GM":"Gambia","GE":"Georgia","DE":"Germany","GH":"Ghana","GI":"Gibraltar","GR":"Greece","GL":"Greenland","GD":"Grenada","GP":"Guadeloupe","GU":"Guam","GT":"Guatemala","GG":"Guernsey","GN":"Guinea","GW":"Guinea-Bissau","GY":"Guyana","HT":"Haiti","HM":"Heard Island & Mcdonald Islands","VA":"Holy See (Vatican City State)","HN":"Honduras","HK":"Hong Kong","HU":"Hungary","IS":"Iceland","IN":"India","ID":"Indonesia","IR":"Iran, Islamic Republic Of","IQ":"Iraq","IE":"Ireland","IM":"Isle Of Man","IL":"Israel","IT":"Italy","JM":"Jamaica","JP":"Japan","JE":"Jersey","JO":"Jordan","KZ":"Kazakhstan","KE":"Kenya","KI":"Kiribati","KR":"Korea","KW":"Kuwait","KG":"Kyrgyzstan","LA":"Lao People's Democratic Republic","LV":"Latvia","LB":"Lebanon","LS":"Lesotho","LR":"Liberia","LY":"Libyan Arab Jamahiriya","LI":"Liechtenstein","LT":"Lithuania","LU":"Luxembourg","MO":"Macao","MK":"Macedonia","MG":"Madagascar","MW":"Malawi","MY":"Malaysia","MV":"Maldives","ML":"Mali","MT":"Malta","MH":"Marshall Islands","MQ":"Martinique","MR":"Mauritania","MU":"Mauritius","YT":"Mayotte","MX":"Mexico","FM":"Micronesia, Federated States Of","MD":"Moldova","MC":"Monaco","MN":"Mongolia","ME":"Montenegro","MS":"Montserrat","MA":"Morocco","MZ":"Mozambique","MM":"Myanmar","NA":"Namibia","NR":"Nauru","NP":"Nepal","NL":"Netherlands","AN":"Netherlands Antilles","NC":"New Caledonia","NZ":"New Zealand","NI":"Nicaragua","NE":"Niger","NG":"Nigeria","NU":"Niue","NF":"Norfolk Island","MP":"Northern Mariana Islands","NO":"Norway","OM":"Oman","PK":"Pakistan","PW":"Palau","PS":"Palestinian Territory, Occupied","PA":"Panama","PG":"Papua New Guinea","PY":"Paraguay","PE":"Peru","PH":"Philippines","PN":"Pitcairn","PL":"Poland","PT":"Portugal","PR":"Puerto Rico","QA":"Qatar","RE":"Reunion","RO":"Romania","RU":"Russian Federation","RW":"Rwanda","BL":"Saint Barthelemy","SH":"Saint Helena","KN":"Saint Kitts And Nevis","LC":"Saint Lucia","MF":"Saint Martin","PM":"Saint Pierre And Miquelon","VC":"Saint Vincent And Grenadines","WS":"Samoa","SM":"San Marino","ST":"Sao Tome And Principe","SA":"Saudi Arabia","SN":"Senegal","RS":"Serbia","SC":"Seychelles","SL":"Sierra Leone","SG":"Singapore","SK":"Slovakia","SI":"Slovenia","SB":"Solomon Islands","SO":"Somalia","ZA":"South Africa","GS":"South Georgia And Sandwich Isl.","ES":"Spain","LK":"Sri Lanka","SD":"Sudan","SR":"Suriname","SJ":"Svalbard And Jan Mayen","SZ":"Swaziland","SE":"Sweden","CH":"Switzerland","SY":"Syrian Arab Republic","TW":"Taiwan","TJ":"Tajikistan","TZ":"Tanzania","TH":"Thailand","TL":"Timor-Leste","TG":"Togo","TK":"Tokelau","TO":"Tonga","TT":"Trinidad And Tobago","TN":"Tunisia","TR":"Turkey","TM":"Turkmenistan","TC":"Turks And Caicos Islands","TV":"Tuvalu","UG":"Uganda","UA":"Ukraine","AE":"United Arab Emirates","GB":"United Kingdom","US":"United States","UM":"United States Outlying Islands","UY":"Uruguay","UZ":"Uzbekistan","VU":"Vanuatu","VE":"Venezuela","VN":"Viet Nam","VG":"Virgin Islands, British","VI":"Virgin Islands, U.S.","WF":"Wallis And Futuna","EH":"Western Sahara","YE":"Yemen","ZM":"Zambia","ZW":"Zimbabwe"};$a.module('ML.filters',[]).filter('selectMenu',function(){return function(tabSelect,value){return tabSelect===value;};}).filter('truncate',function(){return function(string,len,replace){if(string){len=len||50;replace=replace||'...';string=string.substring(0,len);if(string.length<len)return string;else return string+replace;}};}).filter('filterAction',function(){return function(action){if(!action)return false;else if(action==="1"||action==="4"||action==="13")return true;else return false;};}).filter('keyName',function(){return function(key,obj){if(!key)return;obj.forEach(function(item){if(item.key==key)return'item';});};}).filter('otherLang',function(){return function(listLang,objLang){var tmpLang=[];if(listLang){listLang.forEach(function(lang){tmpLang.push(lang.lang);});objLang.forEach(function(langItem){var ids=tmpLang.indexOf(langItem.key);if(ids>-1){}});}
return tmpLang.toString().replace(/"/,'').replace('[','').replace(']','');};}).filter('arrayToText',function(){return function(array){if(array)return array.toString().replace(/"/,'').replace('[','').replace(']','');else return;};}).filter('filterDevice',function(){return function(deviceId){if(deviceId===1)return'Android';else if(deviceId===2)return'iOS';else if(deviceId===3)return'Winphone';else return'';};}).filter('parseVersion',function(){return function(version,deviceId){var getOS=function(deviceId){var tmpDevice=null;deviceOS.forEach(function(item){if(item.id===deviceId)tmpDevice=item.device;});return tmpDevice;};var getVersion=function(version){var getlistDevice=getOS(deviceId);var deviceV=null;getlistDevice.forEach(function(item){if(item.api===version)deviceV=item.version;});return deviceV;};return getVersion(version);};}).filter('dateTimeFromNow',function(){return function(value){var date=moment(value).fromNow();return date;};}).filter('checkDateTime',function(){return function(value){var date=moment(value);if(date.toISOString()===value){return date.format("DD/MM/YYYY HH:mm");}else return value;};}).filter('checkDateTimeSeconds',function(){return function(value){var date=moment(value);if(date.toISOString()===value){return date.format("DD/MM/YYYY HH:mm:ss");}else return value;};}).filter('checkDateTimeDateOnly',function(){return function(value){var date=moment(value);if(date.toISOString()===value){return date.format("DD/MM/YYYY");}else return value;};}).filter('dataUnit',function(){return function(value){if(!value){return 0;}else{var newVal=0,unit="";if(value>=(1024*1024*1024)){newVal=value/(1024*1024*1024);unit="GB";}else if(value>=(1024*1024)){newVal=value/(1024*1024);unit="MB";}else if(value>=1024){newVal=value/1024;unit="KB";}else{newVal=value;unit="B";}
return newVal.toFixed(2).toString()+" "+unit;}};}).filter('displayArrayAsString',function(){return function(arrayRaw){var str="";for(var i=0;i<arrayRaw.length;i++){if(i!==(arrayRaw.length-1)){str+=arrayRaw[i]+", ";}else{str+=arrayRaw[i];}}
return str;};}).filter('millSecondsToTimeString',function(){return function(millseconds){var seconds=Math.floor(millseconds/1000);var days=Math.floor(seconds/86400);var hours=Math.floor((seconds%86400)/3600);var minutes=Math.floor(((seconds%86400)%3600)/60);var timeString='';if(days>0)timeString+=(days>1)?(days+" days "):(days+" day ");if(hours>0)timeString+=(hours>1)?(hours+" hours "):(hours+" hour ");if(minutes>=0)timeString+=(minutes>1)?(minutes+" minutes "):(minutes+" minute ");return timeString;};}).filter('millSecondsToTimeStringMobile',function(){return function(millseconds){var seconds=Math.floor(millseconds/1000);var days=Math.floor(seconds/86400);var hours=Math.floor((seconds%86400)/3600);var minutes=Math.floor(((seconds%86400)%3600)/60);var timeString='';if(days>0)timeString+=(days+"d ");if(hours>0)timeString+=(hours+"h ");if(minutes>=0)timeString+=(hours>0)?(minutes+""):(minutes+"m ");return timeString;};}).filter('secondsToTimeString',function(){return function(seconds){var days=Math.floor(seconds/86400);var hours=Math.floor((seconds%86400)/3600);var minutes=Math.floor(((seconds%86400)%3600)/60);var timeString='';if(days>0)timeString+=(days>1)?(days+" days "):(days+" day ");if(hours>0)timeString+=(hours>1)?(hours+" hours "):(hours+" hour ");if(minutes>=0)timeString+=(minutes>1)?(minutes+" minutes "):(minutes+" minute ");return timeString;};}).filter('currency',function(){return function(value){if(!value)return"N/A";if(value==currencies[value].i){return currencies[value].c;}
if(value>currencies[value].i){for(var index=value+1;index<currencies.length;index++){if(value==currencies[index].i){return currencies[index].c+' ('+currencies[index].n+')';}}}
for(var index=value-1;index<currencies.length;index++){if(value==currencies[index].i){return currencies[index].c+' ('+currencies[index].n+')';}}};}).filter('walletIconLink',function(){return function(icon){var splitedIcon=icon.split('/');var iconName=splitedIcon[splitedIcon.length-1];return'https://static.moneylover.me/img/icon/'+iconName+'.png';};}).filter('displayTrueTime',function(){return function(value){var date=moment(value);if(date.toISOString()!=value){return value;}
var now=moment();var n=now.format("YYYY-MM-DD");var d=date.format("YYYY-MM-DD");if(n===d){return"today, "+date.format("HH:mm");}
if(now.diff(date,"days")===1){return"yesterday, "+date.format("HH:mm");}
return date.format("DD/MM/YYYY HH:mm");};}).filter('walletType',function(){return function(value){if(!value)return'Local';if(value===1)return'SaltEdge';return'Finsify';};}).filter('itemType',function(){return function(value){if(!value)return'-----';return ITEM_TYPE[value]||'------';};}).filter('countryCode',function(){return function(code){if(!code)return'Unknown';return COUNTRY_MAP[code.toUpperCase()]||'Unknown';}});}(angular));(function($a){'use strict';var MLservices=$a.module('ML.services',[]);MLservices.service('MoneyLover',function($http,$rootScope,localStorageService,Page){});MLservices.factory('Page',function($rootScope,$location,$http,localStorageService){var defaultPage={title:'Money Lover AdminCP',author:'ZooStudio',description:'Money Lover Admin control panel',keyword:'Money Lover',version:'0.1',homePage:'http://nsfw.moneylover.me'};return{homepage:defaultPage.homePage,author:defaultPage.author,description:defaultPage.description,keyword:defaultPage.keyword,version:defaultPage.version,title:function(){$rootScope.MLTitle=defaultPage.title;},setTitle:function(newTitle){$rootScope.MLTitle=newTitle+' - '+defaultPage.title;$rootScope.MLPageDetail=newTitle;},resetTitle:function(){$rootScope.MLTitle=defaultPage.title;},menuSelect:function(id){id=id||1;$rootScope.tabSelect=id;}};});var ML=$a.module('ML');ML.service('notificationService',function(){var newNoti=0;var updateNotification=function(newNotiNumber){newNoti+=newNotiNumber;};var getNotification=function(){return newNoti;};var clearNotification=function(){newNoti=0;};return{updateNotification:updateNotification,getNotification:getNotification,clearNotification:clearNotification}});}(angular));(function($a,moment,async){'use strict';$a.module('ML').controller('ActiveUsers',function($scope,$rootScope,$http,$modal){$rootScope.MLPageDetail='Active Users';$rootScope.tabSelect=1;$scope.numbers={};$scope.rates={};$scope.isLoading=false;var limit=15;$scope.endDate=moment().valueOf();$scope.startDate=moment().subtract(limit,'day').startOf('day').valueOf();$scope.days=[1,7,30,100];$scope.viewMode='Total';var chartData={};var charts=[];var LoyalUserCode={oneWeek:{total:1810,android:1811,ios:1812,windowsdesktop:1813,windowsmobile:1814,},oneMonth:{total:1820,android:1821,ios:1822,windowsdesktop:1823,windowsmobile:1824},threeMonth:{total:1830,android:1831,ios:1832,windowsdesktop:1833,windowsmobile:1834},sixMonth:{total:1850,android:1851,ios:1852,windowsdesktop:1853,windowsmobile:1854},oneYear:{total:1860,android:1861,ios:1862,windowsdesktop:1863,windowsmobile:1864},longTime:{total:1840,android:1841,ios:1842,windowsdesktop:1843,windowsmobile:1844}};var isoCountries={'AF':'Afghanistan','AX':'Aland Islands','AL':'Albania','DZ':'Algeria','AS':'American Samoa','AD':'Andorra','AO':'Angola','AI':'Anguilla','AQ':'Antarctica','AG':'Antigua And Barbuda','AR':'Argentina','AM':'Armenia','AW':'Aruba','AU':'Australia','AT':'Austria','AZ':'Azerbaijan','BS':'Bahamas','BH':'Bahrain','BD':'Bangladesh','BB':'Barbados','BY':'Belarus','BE':'Belgium','BZ':'Belize','BJ':'Benin','BM':'Bermuda','BT':'Bhutan','BO':'Bolivia','BA':'Bosnia And Herzegovina','BW':'Botswana','BV':'Bouvet Island','BR':'Brazil','IO':'British Indian Ocean Territory','BN':'Brunei Darussalam','BG':'Bulgaria','BF':'Burkina Faso','BI':'Burundi','KH':'Cambodia','CM':'Cameroon','CA':'Canada','CV':'Cape Verde','KY':'Cayman Islands','CF':'Central African Republic','TD':'Chad','CL':'Chile','CN':'China','CX':'Christmas Island','CC':'Cocos (Keeling) Islands','CO':'Colombia','KM':'Comoros','CG':'Congo','CD':'Congo, Democratic Republic','CK':'Cook Islands','CR':'Costa Rica','CI':'Cote D\'Ivoire','HR':'Croatia','CU':'Cuba','CY':'Cyprus','CZ':'Czech Republic','DK':'Denmark','DJ':'Djibouti','DM':'Dominica','DO':'Dominican Republic','EC':'Ecuador','EG':'Egypt','SV':'El Salvador','GQ':'Equatorial Guinea','ER':'Eritrea','EE':'Estonia','ET':'Ethiopia','FK':'Falkland Islands (Malvinas)','FO':'Faroe Islands','FJ':'Fiji','FI':'Finland','FR':'France','GF':'French Guiana','PF':'French Polynesia','TF':'French Southern Territories','GA':'Gabon','GM':'Gambia','GE':'Georgia','DE':'Germany','GH':'Ghana','GI':'Gibraltar','GR':'Greece','GL':'Greenland','GD':'Grenada','GP':'Guadeloupe','GU':'Guam','GT':'Guatemala','GG':'Guernsey','GN':'Guinea','GW':'Guinea-Bissau','GY':'Guyana','HT':'Haiti','HM':'Heard Island & Mcdonald Islands','VA':'Holy See (Vatican City State)','HN':'Honduras','HK':'Hong Kong','HU':'Hungary','IS':'Iceland','IN':'India','ID':'Indonesia','IR':'Iran, Islamic Republic Of','IQ':'Iraq','IE':'Ireland','IM':'Isle Of Man','IL':'Israel','IT':'Italy','JM':'Jamaica','JP':'Japan','JE':'Jersey','JO':'Jordan','KZ':'Kazakhstan','KE':'Kenya','KI':'Kiribati','KR':'Korea','KW':'Kuwait','KG':'Kyrgyzstan','LA':'Lao People\'s Democratic Republic','LV':'Latvia','LB':'Lebanon','LS':'Lesotho','LR':'Liberia','LY':'Libyan Arab Jamahiriya','LI':'Liechtenstein','LT':'Lithuania','LU':'Luxembourg','MO':'Macao','MK':'Macedonia','MG':'Madagascar','MW':'Malawi','MY':'Malaysia','MV':'Maldives','ML':'Mali','MT':'Malta','MH':'Marshall Islands','MQ':'Martinique','MR':'Mauritania','MU':'Mauritius','YT':'Mayotte','MX':'Mexico','FM':'Micronesia, Federated States Of','MD':'Moldova','MC':'Monaco','MN':'Mongolia','ME':'Montenegro','MS':'Montserrat','MA':'Morocco','MZ':'Mozambique','MM':'Myanmar','NA':'Namibia','NR':'Nauru','NP':'Nepal','NL':'Netherlands','AN':'Netherlands Antilles','NC':'New Caledonia','NZ':'New Zealand','NI':'Nicaragua','NE':'Niger','NG':'Nigeria','NU':'Niue','NF':'Norfolk Island','MP':'Northern Mariana Islands','NO':'Norway','OM':'Oman','PK':'Pakistan','PW':'Palau','PS':'Palestinian Territory, Occupied','PA':'Panama','PG':'Papua New Guinea','PY':'Paraguay','PE':'Peru','PH':'Philippines','PN':'Pitcairn','PL':'Poland','PT':'Portugal','PR':'Puerto Rico','QA':'Qatar','RE':'Reunion','RO':'Romania','RU':'Russian Federation','RW':'Rwanda','BL':'Saint Barthelemy','SH':'Saint Helena','KN':'Saint Kitts And Nevis','LC':'Saint Lucia','MF':'Saint Martin','PM':'Saint Pierre And Miquelon','VC':'Saint Vincent And Grenadines','WS':'Samoa','SM':'San Marino','ST':'Sao Tome And Principe','SA':'Saudi Arabia','SN':'Senegal','RS':'Serbia','SC':'Seychelles','SL':'Sierra Leone','SG':'Singapore','SK':'Slovakia','SI':'Slovenia','SB':'Solomon Islands','SO':'Somalia','ZA':'South Africa','GS':'South Georgia And Sandwich Isl.','ES':'Spain','LK':'Sri Lanka','SD':'Sudan','SR':'Suriname','SJ':'Svalbard And Jan Mayen','SZ':'Swaziland','SE':'Sweden','CH':'Switzerland','SY':'Syrian Arab Republic','TW':'Taiwan','TJ':'Tajikistan','TZ':'Tanzania','TH':'Thailand','TL':'Timor-Leste','TG':'Togo','TK':'Tokelau','TO':'Tonga','TT':'Trinidad And Tobago','TN':'Tunisia','TR':'Turkey','TM':'Turkmenistan','TC':'Turks And Caicos Islands','TV':'Tuvalu','UG':'Uganda','UA':'Ukraine','AE':'United Arab Emirates','GB':'United Kingdom','US':'United States','UM':'United States Outlying Islands','UY':'Uruguay','UZ':'Uzbekistan','VU':'Vanuatu','VE':'Venezuela','VN':'Viet Nam','VG':'Virgin Islands, British','VI':'Virgin Islands, U.S.','WF':'Wallis And Futuna','EH':'Western Sahara','YE':'Yemen','ZM':'Zambia','ZW':'Zimbabwe'};function count(){$scope.isLoading=true;$http.post('/active/count',{}).success(function(result){if(!result.s){return alert("Get stats failed");}
$scope.numbers=result.d;$scope.rates=percentFilter($scope.numbers);}).error(function(){alert("Error From Server");});}
function clearSpaceAndLowerCase(str){var output=str.replace(' ','');output=output.toLowerCase();return output;}
function clearSpace(str){var output=str.replace(' ','');return output;}
function percentFilter(numbers){var result={};var days=Object.keys(numbers);days.forEach(function(day){if(day!='total'){result[day]=((numbers[day]/numbers.total)*100).toFixed(2);}});return result;}
function getDataChart(table,callback){$http.post('/stats',{table:table,types:1,start:$scope.startDate,end:$scope.endDate,limit:limit}).success(function(data){if(!data.s)return callback('Fail');callback(null,data.d);}).error(function(){callback('Server Error');});}
function formatData(data){if(data.length>0){data=_(data).sortBy(function(d){return d.createAt;});var newData=[];data.forEach(function(stat){if(stat&&stat.createAt){var newCreateTime=moment(stat.createAt).subtract(1,'minutes').subtract(7,'hours').format('DD/MM');var info={rate:stat.counter,createAt:newCreateTime};if(stat.metadata){info.counter=stat.metadata.active||0;info.total=stat.metadata.total||0;}else{info.counter=0;info.total=0;}
newData.push(info);}});return newData;}else{return[];}}
function formatLoyalData(data){if(!data)return[];if(data.length===0)return[];data.sort(function(a,b){var timestampA=moment(a.createAt).valueOf();var timestampB=moment(b.createAt).valueOf();return timestampA-timestampB;});var newData=[];for(var i=0;i<data.length;i++){var stat=data[i];if(stat&&stat.createAt){var newCreateTime;newCreateTime=moment(stat.createAt).subtract(8,'hours').format('DD/MM');newData.push({counter:stat.counter,createAt:newCreateTime});}}
return newData;}
function renderRateChart(element,data){return new Morris.Area({element:element,data:data,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['rate'],labels:['Active rate'],lineColors:['#379ca8']});}
function renderCountChart(element,data){return new Morris.Area({element:element,data:data,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['counter'],labels:['Active count'],lineColors:['#379ac8']});}
function renderCombineChart(element,data){charts[element]=null;if(!charts[element]){return new Morris.Bar({element:element,data:data,parseTime:false,fillOpacity:0.7,xkey:'createAt',ykeys:['oneWeek','oneMonth','threeMonth','sixMonth','oneYear','longTime'],labels:['< 1 week','>= 1 week and < 1 month',' >= 1 month and < 3 months','>= 3 months and < 6 months','>= 6 months and < 1 year','>= 1 year']});}}
function renderChart(tableCode,data,mode){var element=tableCode+mode;if(!charts[element]){switch(mode){case'count':charts[element]=renderCountChart(element,data);break;case'rate':charts[element]=renderRateChart(element,data);break;default:break;}}else{charts[element].setData(data);}}
function getStatByTableCode(table,callback){var tableCode=parseInt(table,10);getDataChart(tableCode,function(err,data){if(err)return callback(err);var newData=formatData(data);renderChart(tableCode,newData,'rate');renderChart(tableCode,newData,'count');callback();});}
function getLoyalDataByUserType(type,days,callback){var keyTasks=Object.keys(LoyalUserCode);var tasks={};var mode;switch(days){case 7:mode=1;break;case 30:mode=2;break;case 100:mode=3;break;case 1:mode=4;break;default:break;}
keyTasks.forEach(function(keyTask){var tableCode=(LoyalUserCode[keyTask][type]*10)+mode;tasks[keyTask]=function(cb){getDataChart(tableCode,cb);}});async.series(tasks,function(err,results){if(err)return callback(err);results=formatLoyalDataSet(results);results=mergeLoyalData(results);callback(null,results);});}
function formatLoyalDataSet(data){var keys=Object.keys(data);var newSet={};keys.forEach(function(key){var recordList=formatLoyalData(data[key]);newSet[key]=recordList;});return newSet;}
function mergeLoyalData(data){var newSet=[];var keys=Object.keys(data);var maxArray=getMaxArray(data);for(var i=0;i<maxArray.length;i++){var item={createAt:data[maxArray.key][i].createAt};item[maxArray.key]=data[maxArray.key][i].counter;keys.forEach(function(key){if(key!==maxArray.key){var counter=0;data[key].forEach(function(record){if(record.createAt===item.createAt){counter=record.counter;}});item[key]=counter;}});newSet.push(item);}
return newSet;}
function getMaxArray(data){var maxLength=0;var maxKey;var keys=Object.keys(data);keys.forEach(function(key){if(data[key].length>maxLength){maxLength=data[key].length;maxKey=key;}});return{length:maxLength,key:maxKey};}
function mergeData(object){var newData=[];var total=object.total.d;var objSize=Object.keys(object).length;var objKeys=Object.keys(object);total.forEach(function(data,index){var info={createAt:data.createAt};for(var i=0;i<objSize;i++){var counter=object[objKeys[i]].d[index]||0;if(counter===0){info[objKeys[i]]=counter;}else{info[objKeys[i]]=counter.counter;}}
newData.push(info);});return newData;}
function getStats(){$scope.isLoading=true;async.eachSeries($scope.days,function(day,cb){var key=clearSpace($scope.viewMode)+day.toString();var chartId='loyal'+clearSpace($scope.viewMode)+day.toString();if(chartData[key]){renderCombineChart(chartId,chartData[key]);return cb();}
getLoyalDataByUserType(clearSpaceAndLowerCase($scope.viewMode),day,function(err,result){if(err)return cb(err);chartData[key]=result;renderCombineChart(chartId,chartData[key]);cb();});},function(err){$scope.isLoading=false;if(err){alert('Get chart data due to error');}});}
function sortDataDesc(data){for(var i=0;i<data.length-1;i++){var max=data[i].value;for(var j=i+1;j<data.length;j++){if(data[j].value>max){max=data[j].value;var temp=data[i];data[i]=data[j];data[j]=temp;}}}
return data;}
function groupOtherData(data){var other={label:'Others',value:0};for(var i=10;i<data.length;i++){other.value+=data[i].value;}
var result=data.slice(0,10);result.push(other);return result;}
function countryParser(data){for(var i=0;i<data.length-1;i++){data[i].label=isoCountries[data[i].label.split(':')[1].toUpperCase()]||'Unknown';}
return data;}
function handleReportData(raw_data){if(!raw_data)return[];if(!raw_data.metadata)return[];var data=[];var keys=Object.keys(raw_data.metadata);keys.forEach(function(key){data.push({label:key,value:raw_data.metadata[key]});});data=sortDataDesc(data);data=groupOtherData(data);return countryParser(data);}
function getReport(day){var modalInstance=$modal.open({templateUrl:'/partials/active/modal_detail.html',controller:ctrlReport,resolve:{day:function(){return day;}}});}
function ctrlReport($scope,$modalInstance,day){var donutChart;function renderDonutChart(data){if(donutChart){return donutChart.setData(data);}
donutChart=new Morris.Donut({element:'donut-chart',data:data});}
function GetReportData(){$http.post('/active/user-by-country',{day:day}).success(function(result){if(result.s){$scope.dataResult=result.d;renderDonutChart(handleReportData(result.d));}else{alert("Failed to get report data");}}).error(function(){alert("Error From Server");});}
GetReportData();$scope.close=function(){$modalInstance.dismiss('cancel');};}
getStats();$scope.selectView=function(viewMode){if($scope.viewMode===viewMode){return 0;}
$scope.viewMode=viewMode;setTimeout(function(){getStats();},500);}});}(angular,moment,async));(function($a){'use strict';$a.module('ML').controller('admin',function($scope,$rootScope,$modal,$routeParams,$http){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Admins';$scope.isFirstPage=true;$scope.isLastPage=true;function listAdmin(){$http.post('/admin/list',{}).success(function(data,stt){if(data.error){alert(data.msg);}else{$scope.listAdmin=data.data;}}).error(function(){alert("Error From Server");});}
$scope.getListAdmin=function(){listAdmin();};$scope.search=function(){};$scope.edit=function(admin){var modalInstance=$modal.open({templateUrl:'/partials/admin/edit.html',controller:roleController,resolve:{admin:function(){return admin;}}});};var roleController=function(admin,$scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.admin=admin;$scope.updateAdmin=function(adminInfo){$http.post('/admin/update',{adminId:admin._id,updates:{permission:adminInfo.permission}}).success(function(data){if(data.error){alert('Update failed');}else{listAdmin();$scope.cancel();}}).error(function(){alert("Error from Server");})}};$scope.delete=function(admin){var s=confirm("Are you sure?");if(s){$http.post('/admin/delete',{adminInfo:admin}).success(function(data){if(!data.error){listAdmin();}else{alert(data.msg);}}).error(function(){alert('Error from server :(');});}};$scope.showSearchAdminMobile=function(){var modalInstance=$modal.open({templateUrl:'/partials/admin/searchMobile.html',controller:modalController,});};var modalController=function($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.search=function(){$scope.cancel();};};$scope.changePermission=function(adminInfo){var s=confirm('Are you sure?');if(s){adminInfo.isAdminSystem=!adminInfo.isAdminSystem;$http.post('/admin/update',{adminId:adminInfo._id,updates:{isAdminSystem:adminInfo.isAdminSystem}}).success(function(data){if(data.error)alert('Update failed');}).error(function(){alert('Error From Server');})}};$scope.add=function(){var modalInstance=$modal.open({templateUrl:'/partials/admin/info.html',controller:ctrlAdd,resolve:{}});modalInstance.result.then(function(){});};var ctrlAdd=function($http,$scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.addAdmin=function(adminInfo){if(!adminInfo||!adminInfo.username||adminInfo.username===""||!adminInfo.password||adminInfo.password===""){$scope.errorMsg="Please fill all the field below";}else{$http.post('/admin/add',{adminInfo:adminInfo}).success(function(data){if(data.error){$scope.errorMsg=data.msg;}else{listAdmin();$scope.cancel();}}).error(function(){alert("Error from Server");})}}};})}(angular));(function($a){'use strict';$a.module('ML').controller('automation_log',function($scope,$rootScope,$modal,$routeParams,$http){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Automation Log';$scope.page=1;var limit=40;$scope.automation_log={};$scope.noContent=false;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.$on('$viewContentLoaded',function(){loadContent($scope.page);});$scope.nextPage=function(num){$scope.page+=num;loadContent($scope.page);};function excutePage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.automation_log.length<limit;};function loadContent(page){var url='/api/automation_log/browse';var skip=limit*(page-1);var params={offset:skip,limit:limit};$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.automation_log=response.data.data;if($scope.automation_log.length<1){$scope.noContent=true;}else{$scope.noContent=false;}
excutePage();}else{alert('Get list email push automation error');}}},function errorCallback(response){alert(response.status);});};$scope.clearLog=function(){var ok=confirm("You will clear log, are you sure?");if(ok){var url='/api/automation_log/clear';$http({method:'POST',url:url}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadContent($scope.page);}else{alert(response.data.message);}}},function errorCallback(response){alert(response.status);});};}
function analysisStatus(){}})}(angular));(function($a){'use strict';var initQuest='Bạn thực sự muốn thực hiện thao tác này?';$a.module('ML').controller('bank',function($scope,$rootScope,$http,$modal,$routeParams,localStorageService){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Bank';$scope.listBank=[];function saveBank(listBank,callback){$http.post('/bank/update',{listBank:listBank}).success(function(data,err){callback(data);}).error(function(data,err){alert('Error');callback();});}
function updateBank(listBank){var newTime=parseInt(new Date().getTime()/1000,10);var newList={t:newTime,data:listBank};localStorageService.add('bankList',JSON.stringify(newList));$scope.lastUpdate=moment(newTime*1000).format();$scope.listBank=listBank;}
var btnStatus=function(status){switch(status){case 1:$scope.okCheck=true;$scope.sendUpload=false;$scope.sendOk=false;break;case 2:$scope.okCheck=false;$scope.sendUpload=true;$scope.sendOk=false;break;case 3:$scope.okCheck=false;$scope.sendUpload=false;$scope.sendOk=true;break;default:$scope.okCheck=true;$scope.sendUpload=false;$scope.sendOk=false;}};$scope.getList=function(status){if(status){$http.post('/bank/get').success(function(data,err){localStorageService.add('bankList',JSON.stringify(data.data));$scope.lastUpdate=moment(data.data.t*1000).format();$scope.listBank=data.data.data;}).error(function(data,err){alert('Error');});}else{var listBank=localStorageService.get('bankList');if(listBank){$scope.lastUpdate=moment(listBank.t*1000).format();$scope.listBank=listBank.data;}else{$scope.getList(1);}}};$scope.generate=function(){var s=confirm(initQuest);if(s){btnStatus(2);var tmpListBank=[];$scope.listBank.forEach(function(bank,index){delete bank.tmp;tmpListBank.push(bank);});saveBank(tmpListBank,function(data){updateBank(tmpListBank);btnStatus(3);setTimeout(btnStatus(1),3000);});}};$scope.delete=function(bank){$scope.listBank.forEach(function(bankInfo,key){if(bankInfo===bank){$scope.listBank.splice(key,1);}});updateBank($scope.listBank);};$scope.edit=function(bank){var modalInstance=$modal.open({templateUrl:'/partials/bank/info.html',controller:ctrlEdit,resolve:{bankMsg:function(){return bank;}}});modalInstance.result.then(function(){updateBank($scope.listBank);});};$scope.addNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/bank/info.html',controller:ctrlAdd,resolve:{bankMsg:function(){return{t:1};},listBank:function(){return $scope.listBank;}}});modalInstance.result.then(function(lstBank){updateBank(lstBank);},function(){});};var ctrlAdd=function($scope,Page,$modalInstance,bankMsg,listBank){$scope.bankMsg=bankMsg;$scope.errorMsg=null;$scope.saveBankMsg=function(bank){bank.tmp=true;listBank.push(bank);$modalInstance.close(listBank);};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};var ctrlEdit=function($scope,Page,$modalInstance,bankMsg){var tmpBankMsg=bankMsg;$scope.bankMsg=bankMsg;$scope.saveBankMsg=function(){$modalInstance.close($scope.bankMsg);};$scope.cancel=function(){$scope.bankMsg=tmpBankMsg;$modalInstance.dismiss('cancel');};};});}(angular));(function($a){'use strict';$a.module('ML').controller('bonus',function($scope,$rootScope,$http,$routeParams){$rootScope.tabSelect=2;$rootScope.MLPageDetail='Check Wallet Permission';$scope.selectedType='email';$scope.checkPermission=function(){if($scope.walletId&&($scope.email||$scope.token)){$http.post('/bonus/check-wallet-permission',{walletId:$scope.walletId,email:$scope.email,tokenDevice:$scope.token}).success(function(data){if(data.s)
alert("Read Permission: "+data.d.readPermission+", WritePermission: "+data.d.writePermission);else
alert("Check Permission Error");}).error(function(){alert('Error from server');});}}})}(angular));(function($a){'use strict';$a.module('ML').controller('campaignCreateModal',function($scope,$rootScope,$modal,$modalInstance,$routeParams,$http){$scope.$on('$viewContentLoaded',function(){$scope.campaignFeild={}});$scope.create=function(campaign){var url='/api/campaign-marketing/create';var param={name:campaign.name,type:campaign.type}
$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){$modalInstance.close(response.data.data);}else{if(response.data.message=='exists'){alert('campaign name exists!');}else{alert('Save campaign-marketing error');}}}},function errorCallback(response){alert(response.status);});}
$scope.cancel=function(){$modalInstance.dismiss('cancel');}})}(angular));(function($a){'use strict';$a.module('ML').controller('campaignMarketingCtrl',function($scope,$rootScope,$modal,$routeParams,$http){$scope.campaigns=[];$scope.page=1;$scope.noContent;var limit=20;$scope.$on('$viewContentLoaded',function(){console.log('campaignMarketingCtrl');loadContent($scope.page);});function loadContent(page){var url='/api/campaign-marketing/browse';var skip=limit*(page-1);var param={skip:skip,limit:limit,page:page};$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.campaigns=response.data.data;if($scope.campaigns.length<1){$scope.noContent=true;}else{$scope.noContent=false;}
excutePage(response.data);}else{alert('Get list group error');}}},function errorCallback(response){alert(response.status);});}
$scope.nextPage=function(num){$scope.page+=num;loadContent($scope.page);};function excutePage(scope){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.campaigns.length<limit;};$scope.changeDisabled=function(campaign){alert('Chưa có, coming soon !');}})}(angular));(function($a){'use strict';$a.module('ML').controller('change_email',function($scope,$rootScope,$http){$rootScope.MLPageDetail='Change Email';$rootScope.tabSelect=7;$scope.changeLoad=false;$scope.acceptChange=function(){var confirmAccept=confirm("Are you really want to change?");if(confirmAccept){var self=this;this.errorMessage="";this.successMessage="";$scope.changeLoad=true;$http.post('/change-email',{old:this.email.old,new:this.email.new}).success(function(result){$scope.changeLoad=false;if(result.s)self.successMessage="Success";else self.errorMessage=result.m;}).error(function(){$scope.changeLoad=false;self.errorMessage="Error from server";});}};});}(angular));(function($a){'use strict';$a.module('ML').controller('changelog',function($scope,$rootScope,$http){$rootScope.MLPageDetail='Changelogs';$rootScope.tabSelect=3;$rootScope.currentVersion="2.0.0";var loadContent=function(){$http.get("/changelog.txt").success(function(response){$scope.contentLoaded=response;}).error(function(){alert("Error load changelog");});};loadContent();});}(angular));(function($a){'use strict';String.prototype.addString=function(idx,rem,str){return this.slice(0,idx)+str+this.slice(idx+Math.abs(rem));};$a.module('ML').controller('checkPurchaseBill',function($scope,$rootScope,$http){$rootScope.tabSelect=7;$rootScope.MLPageDetail='Check purchase bill';$scope.processing=false;function handleSplitedObject(text){var ngoacNhonMoIndex=text.indexOf('{');var ngoacKepKeyMoIndex=(ngoacNhonMoIndex===0)?1:0;text=text.addString(ngoacKepKeyMoIndex,0,'"');var haiChamIndex=text.indexOf(':');var ngoacKepKeyDongIndex=haiChamIndex;text=text.addString(ngoacKepKeyDongIndex,0,'"');var temp=text.split(':');if(temp[0].indexOf('purchaseTime')===-1&&temp[0].indexOf('purchaseState')===-1){haiChamIndex=text.indexOf(':');var ngoacKepValueMoIndex=haiChamIndex+1;text=text.addString(ngoacKepValueMoIndex,0,'"');var ngoacNhonDongIndex=text.indexOf('}');var ngoacKepValueDongIndex=(ngoacNhonDongIndex!==-1)?ngoacNhonDongIndex:text.length;text=text.addString(ngoacKepValueDongIndex,0,'"');}
return text;}
function makePostData(line){var tmp=line.split(',');var tmpPartOne=tmp.slice(0,tmp.length-2);tmpPartOne.forEach(function(str,index){tmpPartOne[index]=handleSplitedObject(str);});tmpPartOne=tmpPartOne.join();return{receiptData:tmpPartOne,signature:tmp[tmp.length-2],email:tmp[tmp.length-1]||'Unknown email'};}
function checkBill(receiptData,signature,callback){var postData={receipt_data:{data:receiptData,signature:signature},};$http.post('/check-purchase-bill',postData).success(function(result){if(result.s)return callback(null,result.d);callback(result.e);}).error(function(){callback('Error from server');});}
$scope.check=function(){var file=document.getElementById('csv_input').files[0];if(!file)return alert('Please select csv file');$scope.processing=true;var reader=new FileReader();$a.element('#result_list li').remove();reader.readAsText(file);reader.onload=function(event){var lines=event.target.result.replace(/"/g,"").replace(/\r/g,"").split('\n');var count=0;async.eachSeries(lines,function(line,cb){if(line.indexOf('Signature')!==-1)return cb();var info=makePostData(line);count++;checkBill(info.receiptData,info.signature,function(err,data){if(data){$a.element('#result_list').append('<li>'
+'<span style="text-warning">'
+count+'. '
+'</span>'
+'<span style="font-weight: bold;">'
+info.email+': '
+'</span>'
+'<span class="text-success">'
+'Success'
+'</span>'
+'</li>');}else{$a.element('#result_list').append('<li>'
+'<span style="text-warning">'
+count+'. '
+'</span>'
+'<span style="font-weight: bold;">'
+info.email+': '
+'</span>'
+'<span class="text-error">'
+err
+'</span>'
+'</li>');}
cb();});},function(error){$scope.processing=false;});};};$scope.checkSingleBill=function(info){checkBill(info.receipt,info.signature,function(result){if(result.s)return alert('Last purchase: '+result.d);alert('false');});};});}(angular));(function($a){'use strict';$a.module('ML').controller('classification_logs',function($scope,$rootScope,$http,$modal,$routeParams){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Classification logs';$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.isLoading=false;var limit=50;$scope.logs=[];$scope.total_changelog=0;init();function init(){getList(0,limit);$http.post('/classification-log/total-category',{}).success(function(result){if(result.s){$scope.total_changelog=result.d;}else{alert('Count total due to failed');}}).error(function(){alert('Error From Server');})}
function getList(skip,limit){$http.post('/classification-log/list',{skip:skip,limit:limit}).success(function(result){if(result.s){$scope.logs=result.d;checkPage();}}).error(function(){alert("Error From Server");});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.logs.length<limit;$scope.noResult=$scope.logs.length===0;}
$scope.nextPage=function(value){$scope.page+=value;var skip=limit*($scope.page-1);$routeParams.page=$scope.page;getList(skip,limit);};$scope.delUserCate=function(log,index){var ok=confirm("Are you sure?");if(!ok){return;}
$http.post('/classification-log/delete',{id:log._id}).success(function(result){if(!result.s){return alert("Delete log due to failed");}
$scope.logs.splice(index,1);}).error(function(){alert("Error From Server");});};$scope.editUserCate=function(log){var modalInstance=$modal.open({templateUrl:'/partials/classification_logs/modalChangeCate.html',controller:changeCateCtrl,resolve:{old_category:function(){return log.old_category;},current_category:function(){return log.new_category;}}});modalInstance.result.then(function(new_category){$http.post('/classification-log/change-category',{id:log._id,new_category:new_category}).success(function(result){if(result.s){log.new_category=new_category;}else{alert('Change category due to failed');}}).error(function(){alert('Error From Server');});});};var changeCateCtrl=function($scope,$modalInstance,old_category,current_category){$scope.old_category=old_category;$scope.current_category=current_category;var list_metadata={};$scope.select_list=[];getCategoryList();function getCategoryList(){$http.post('/classification-log/get-default-categories',{}).success(function(result){if(result.s){list_metadata=result.d;if(list_metadata['expense'].indexOf($scope.old_category)!=-1){$scope.select_list=list_metadata['expense'];}else{$scope.select_list=list_metadata['income'];}
$scope.select_list.sort();}else{alert("Get metadata list due to failed");}}).error(function(){alert("Error From Server");});}
$scope.save=function(){if(!this.new_category){return alert("Please select new category!");}
if(this.new_category===this.current_category){return alert("New category and old category should not the same")}
$modalInstance.close(this.new_category);};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.showTransaction=function(transaction){var modalInstance=$modal.open({templateUrl:'/partials/classification_logs/transaction.html',controller:ctrlShowTransaction,resolve:{transaction:function(){return transaction;}}});};var ctrlShowTransaction=function($scope,$modalInstance,transaction){$scope.transaction=transaction;$scope.close=function(){$modalInstance.dismiss('cancel');}};});}(angular));(function($a){'use strict';$a.module('ML').controller('clientKey',function($scope,$rootScope,$routeParams,$http,$modal){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Client Key';$scope.listCK=[];$scope.isLoading=false;$scope.getList=function(rule){$scope.isLoading=true;$http.post('/clientkey/get',{rule:rule}).success(function(data){$scope.isLoading=false;if(data.s){return $scope.listCK=data.d;}
if(data.e){alert(data.e);}}).error(function(){$scope.isLoading=false;alert('error');});};$scope.delete=function(clientkey,index){var ok=confirm('Do you really want to delete a clientKey named "'+clientkey.clientName+'"?');if(!ok){return}
$http.post('/clientkey/delete',{ckid:clientkey._id}).success(function(data){$scope.listCK.splice(index);}).error(function(data){alert("Delete Error");});};$scope.disable=function(key){var ok=confirm('Are you sure?');if(!ok){return;}
$http.post('/clientkey/disable',{clientId:key._id}).success(function(result){$scope.isLoading=false;if(!result.s)alert('Disable client key due to error');else key.isDisabled=true;}).error(function(){alert("Error From Server");});};$scope.enable=function(key){var ok=confirm('Are you sure?');if(!ok){return;}
$http.post('/clientkey/enable',{clientId:key._id}).success(function(result){$scope.isLoading=false;if(!result.s)alert('Enable client key due to error');else key.isDisabled=false;}).error(function(){alert("Error From Server");});};$scope.showSecret=function(key){key.showSecret=true;};$scope.hideSecret=function(key){key.showSecret=false;};$scope.setInternal=function(ck){$http.post('/clientkey/change-internal',{id:ck._id,status:!ck.internal}).success(function(result){if(!result.s)return alert('Change internal status failed');ck.internal=!ck.internal;}).error(function(){alert('Error from server');});};$scope.addNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/client_key/info.html',controller:ctrlAdd,resolve:{lstCK:function(){return $scope.listCK}}});modalInstance.result.then(function(){},function(){});};var ctrlAdd=function($scope,Page,$modalInstance,lstCK){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.saveCk=function(ck){if(!ck)return;if(!ck.clientName)return alert('Please type name of key');if(!ck.rule)return alert('Please select type of key');ck.rule=parseInt(ck.rule);$http.post('/clientkey/save',ck).success(function(data){if(!data.s){alert("Add new key due to error");}else{lstCK.push(data.d);$modalInstance.dismiss('cancel');}}).error(function(){alert("Can't save new client key");});}};$scope.editInfo=function(key){var modalInstance=$modal.open({templateUrl:'/partials/client_key/info.html',controller:ctrlEdit,resolve:{info:function(){return key;}}});modalInstance.result.then(function(info){key=info;});};var ctrlEdit=function($scope,$modalInstance,info){$scope.ckinfo=info;$scope.saveCk=function(key){$http.post('/clientkey/edit',{clientId:key._id,name:key.clientName,platform:key.platform}).success(function(result){if(!result.s)alert("Edit client key due to error");else $modalInstance.close(key);}).error(function(){alert("Error From Server");});};$scope.cancel=function(){$modalInstance.dismiss('cancel');}};$scope.regenSecret=function(key,index){var ok=confirm('Are you sure?');if(!ok)return;$http.post('/clientkey/regenerate-secret',{clientId:key._id}).success(function(result){if(result.s)$scope.listCK[index]=result.d;else alert('Regenerate secret due to error');}).error(function(){alert("Error From Server");});};$scope.changeDisabledStatus=function(client){client.isDisabled=!client.isDisabled;};})}(angular));(function($a){'use strict';$a.module('ML').controller('coupon',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Coupon Manager';$scope.selectedTab='enabled';$scope.listCoupon=[];function getCoupon(){var option={};option.enabled=$scope.selectedTab==='enabled';$http.post('/coupon/get-all',{option:option}).success(function(data){if(data.s){$scope.listCoupon=data.d;}else{alert("Add new coupon due to error");}}).error(function(){alert("Error From Server");});}
getCoupon();function validate(item){$scope.requireName=false;$scope.requireProvider=false;$scope.requireDescription=false;$scope.requireLocation=false;$scope.requireAmount=false;if(!item||!item.name||(item.name&&item.name=="")){$scope.requireName=true;return false;}
if(!item.provider){$scope.requireProvider=true;return false;}
if(!item.description){$scope.requireDescription=true;return false;}
if(!item.location){$scope.requireLocation=true;return false;}
if(!item.amount){$scope.requireAmount=true;return false;}
return true;}
$scope.addNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/coupon/info.html',controller:addCtrl,resolve:{}});modalInstance.result.then(function(){});};$scope.tabSelect=function(tab){if($scope.selectedTab!=tab){$scope.selectedTab=tab;getCoupon();}};var addCtrl=function($scope,$modalInstance){$scope.submit=function(info){var ok=validate(info);if(ok){$http.post('/coupon/new',info).success(function(data){if(data.s){getCoupon();$scope.cancel();}else{alert("Add new coupon due to error");}}).error(function(){alert("Error From Server");});}};$scope.datePicker1=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};$scope.datePicker2=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};$scope.cancel=function(){$modalInstance.dismiss('cancel');}};$scope.edit=function(coupon){var modalInstance=$modal.open({templateUrl:'/partials/coupon/info.html',controller:ctrlEdit,resolve:{couponInfo:function(){return coupon;}}});modalInstance.result.then(function(){});};var ctrlEdit=function($scope,$modalInstance,couponInfo){$scope.info=couponInfo;$scope.submit=function(info){var ok=validate(info);if(ok){$http.post('/coupon/edit',info).success(function(data){if(data.s){getCoupon();$scope.cancel();}else{alert("Add new coupon due to error");}}).error(function(){alert("Error From Server");});}};$scope.datePicker1=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};$scope.datePicker2=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.delete=function(coupon){var ok=confirm('Coupon ['+coupon.name+'] will be remove, are you sure?');if(ok){$http.post('/coupon/delete',{id:coupon._id}).success(function(data){if(data.s){getCoupon();$scope.cancel();}else alert("Delete coupon due to error");}).error(function(){alert("Error From Server");});}};});}(angular));(function($a){'use strict';var initQuest='Bạn thực sự muốn thực hiện thao tác này?';$a.module('ML').controller('currency',function($scope,$rootScope,$http,$modal,$routeParams,localStorageService){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Currency';$scope.listCurrency=[];$scope.lastUpdate=new Date();function saveCurrency(listCurrency,callback){$http.post('/currency/update',{listCurrency:listCurrency}).success(function(data,err){callback(data);}).error(function(data,err){alert('Error');callback();});}
function updateCurrency(listCurrency){var newTime=parseInt(new Date().getTime()/1000,10);var newList={t:newTime,data:listCurrency};localStorageService.add('currencyList',JSON.stringify(newList));$scope.lastUpdate=moment(newTime*1000).format();$scope.listCurrency=listCurrency;}
function validateCurrency(info){if(!info.c||info.c.length<3)return false;if(!info.s||info.s.length===0)return false;if(!info.n||info.n.length>100)return false;if(info.t!==0&&info.t!==1)return false;if(!info.r||info.r.length===0)return false;if(!info.dm)return false;if(!info.gs)return false;return true;}
var btnStatus=function(status){switch(status){case 1:$scope.okCheck=true;$scope.sendUpload=false;$scope.sendOk=false;break;case 2:$scope.okCheck=false;$scope.sendUpload=true;$scope.sendOk=false;break;case 3:$scope.okCheck=false;$scope.sendUpload=false;$scope.sendOk=true;break;default:$scope.okCheck=true;$scope.sendUpload=false;$scope.sendOk=false;}};$scope.generate=function(){var s=confirm(initQuest);if(s){btnStatus(2);var tmpListCurrency=[];var listCurrency=localStorageService.get('currencyList');$scope.listCurrency.forEach(function(currency,index){delete currency.tmp;tmpListCurrency.push(currency);});saveCurrency(tmpListCurrency,function(data){updateCurrency(tmpListCurrency);btnStatus(3);setTimeout(btnStatus(1),3000);});}};function convertArrayToNameArray(arrayObj){var newArray=[];for(var i=0;i<arrayObj.length;i++){newArray[arrayObj[i].n]=arrayObj[i];}
return newArray;}
$scope.getList=function(status){if(status){$http.post('/currency/get').success(function(data,err){localStorageService.add('currencyList',JSON.stringify(data.data));$scope.lastUpdate=moment(data.data.t*1000).format();$scope.listCurrency=data.data.data;}).error(function(data,err){alert('Error');});}else{$scope.getList(1);}};$scope.addNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/currency/info.html',controller:ctrlAdd,resolve:{currencyInfo:function(){return{t:0,r:2};},listCurrency:function(){return $scope.listCurrency;}}});modalInstance.result.then(function(lstCurrency){updateCurrency(lstCurrency);},function(){});};$scope.edit=function(currencyInfo){var modalInstance=$modal.open({templateUrl:'/partials/currency/info.html',controller:ctrlEdit,resolve:{currencyInfo:function(){return currencyInfo;}}});modalInstance.result.then(function(){updateCurrency($scope.listCurrency);});};$scope.delete=function(currency){$scope.listCurrency.forEach(function(currencyInfo,key){if(currencyInfo===currency){$scope.listCurrency.splice(key,1);}});updateCurrency($scope.listCurrency);};var ctrlAdd=function($scope,Page,$modalInstance,currencyInfo,listCurrency){$scope.currencyInfo=currencyInfo;$scope.errorMsg=null;$scope.characters=[{name:'DOT',value:'.'},{name:'COMMA',value:','},{name:'SPACE',value:' '}];$scope.saveCurrency=function(currency){var ok=validateCurrency(currency);if(ok){currency.tmp=true;listCurrency.push(currency);$modalInstance.close(listCurrency);}else{$scope.errorMsg='Hãy kiểm tra lại thông tin tiền tệ.';}};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};var ctrlEdit=function($scope,Page,$modalInstance,currencyInfo){var tmpCurrencyInfo=currencyInfo;$scope.currencyInfo=currencyInfo;$scope.mode='edit';$scope.characters=[{name:'DOT',value:'.'},{name:'COMMA',value:','},{name:'SPACE',value:' '}];$scope.saveCurrency=function(){var ok=validateCurrency($scope.currencyInfo);if(ok)$modalInstance.close($scope.currencyInfo);else $scope.errorMsg='Hãy kiểm tra lại thông tin tiền tệ.';};$scope.cancel=function(){$scope.currencyInfo=tmpCurrencyInfo;$modalInstance.dismiss('cancel');};};})}(angular));(function($a,moment){'use strict';$a.module('ML').controller('dashboard',function($scope,$rootScope,Page,$location,$http,$modal){$rootScope.MLPageDetail='Dashboard';$rootScope.tabSelect=1;$scope.mlNumbers={users:205598,premium:14604,wallets:194687,transactions:13149145,devices:353621,userTotalActiveSync:114372,error:''};$scope.endDate=moment();$scope.startDate=moment().subtract(15,'days');var premium_chart,user_chart;function countUser(startDate,endDate,type,callback){type=type?type:2;startDate=moment(startDate).format('MM-DD-YYYY');endDate=moment(endDate).format('MM-DD-YYYY');$http.post('/user/count',{startDate:startDate,endDate:endDate,type:type}).success(callback).error(function(){alert("Error From Server");});}
var getPremiumStat=function(start,end,callback){$http.post('/user/premium-count',{start:start,end:end}).success(function(data){callback(false,data);}).error(function(data){callback(true,data);});};$scope.userTotal=function(){var that=this;that.userToalValue=0;var startDate='01-01-2000';var endDate=moment().zone("+07:00").format('DD-MM-YYYY').toString();countUser(startDate,endDate,1,function(data){if(!data.err)that.userToalValue=data.data;else that.userToalValue='Error';});};$scope.userTotalOfMonth=function(){var that=this;that.userTotalOfMonthValue=0;var endDate=moment().format('DD-MM-YYYY');var startDate=moment().day(-30).format('DD-MM-YYYY');countUser(startDate,endDate,2,function(data){if(!data.err)that.userTotalOfMonthValue=data.data;else that.userTotalOfMonthValue='Error';});};$scope.dbStats=function(){$http.post('/dbstats',{}).success(function(data){console.log(data);$scope.stats=data.stats;}).error(function(){alert("Loi cmnr");});};$scope.userStats=function(){var addZeroNumber=function(num){if(num<10)return'0'+num;else return num;};var parseData=function(dataStats){var tmpStats=[];dataStats=dataStats.sort(function(obj1,obj2){return obj1._id.month-obj2._id.month;});dataStats=dataStats.sort(function(obj1,obj2){return obj1._id.year-obj2._id.year;});dataStats.forEach(function(itemStats){var newItemStat=itemStats.dailyStats.sort(function(obj1,obj2){return obj1.ngay-obj2.ngay;});newItemStat.forEach(function(dayStats){tmpStats.push({ngay:addZeroNumber(dayStats.ngay)+'/'+addZeroNumber(itemStats._id.month),counter:dayStats.count});});});return tmpStats;};countUser($scope.startDate.valueOf(),$scope.endDate.valueOf(),4,function(data){var newData=data.data;if(newData){var dailyStats=[];dailyStats=parseData(newData);if(user_chart){user_chart.setData(dailyStats);}else{user_chart=new Morris.Area({element:'chart1',data:dailyStats,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'ngay',ykeys:['counter'],labels:['Register'],lineColors:['#379ca8']});}}else $scope.userChartMessage='No data';});};$scope.activeTotalOfMonth=function(){var that=this;var startDate=moment().startOf('month').format('DD-MM-YYYY');var endDate=moment().endOf('month').format('DD-MM-YYYY');that.activeTotalOfMonthValue=0;$http.post('/events/stats',{startDate:startDate,endDate:endDate}).success(function(data){if(!data.error){that.activeTotalOfMonthValue=data.data||0;}else that.activeTotalOfMonthValue='Error';}).error(function(){alert('Error');});};$scope.activeSync=function(){var Dated=new Date();countUser(Dated,Dated,3,function(data){if(!data.err)$scope.mlNumbers.userTotalActiveSync=data.data;else $scope.mlNumbers.userTotalActiveSync='Error';});};$scope.inviteSync=function(){$http.post('/invited/stat',{}).success(function(data){if(data.error)alert(data.msg);else $scope.totalInviteSync=data.data;}).error(function(){alert('Error');});};$scope.counts=function(){$http.post('/stats/count-user-transaction',{}).success(function(data){if(data.error){$scope.mlNumbers.error="Error";}else{$scope.mlNumbers.users=data.data.users;$scope.mlNumbers.premium=data.data.premium;$scope.mlNumbers.transactions=data.data.transactions;$scope.mlNumbers.wallets=data.data.wallets;$scope.mlNumbers.devices=data.data.devices;$scope.mlNumbers.linkedWallets=data.data.linkedWallets;}}).error(function(){alert("Error while counting users & transactions");});};$scope.premiumStats=function(){getPremiumStat($scope.startDate.format('DD/MM/YYYY'),$scope.endDate.format('DD/MM/YYYY'),function(err,data){if(!err){var newData=data.d;if(premium_chart){premium_chart.setData(newData);}else{premium_chart=new Morris.Area({element:'chart2',data:newData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['amount'],labels:['Total'],lineColors:['#379ca8']});}}});};$scope.setDateRange=function(){var modalInstance=$modal.open({templateUrl:'/partials/dashboard/set_date_range.html',controller:datePickerController,resolve:{startDate:function(){return $scope.startDate;},endDate:function(){return $scope.endDate;}}});modalInstance.result.then(function(date){$scope.startDate=moment(date.sd).valueOf();$scope.endDate=moment(date.ed).valueOf();$scope.userStats();$scope.premiumStats();});};var datePickerController=function($scope,$modalInstance,startDate,endDate){$scope.info={sd:startDate,ed:endDate};$scope.done=function(info){var s=new Date(info.sd),e=new Date(info.ed);if(s>e)alert("End Date must greater or equal than Start Date");else $modalInstance.close(info);};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};updateInfo();function updateInfo(){$scope.counts();}
function compare(a,b){if(a.value<b.value)
return 1;if(a.value>b.value)
return-1;return 0;}
$scope.todayCountry=function(){var modalInstance=new $modal.open({templateUrl:'/partials/dashboard/todaycountry.html',controller:ctrlTodayCountry,resolve:{}});};function ctrlTodayCountry($modalInstance,$scope){$scope.isLoading=false;var chart,chartRef;var today=new Date();$scope.date=new Date();displayInfo($scope.date);function handleData(data){var output=[];var others_value=0;data.sort(compare);data.forEach(function(element,index){if(index<10){output.push(element);}else{others_value+=element.value;}});if(others_value!=0){output.push({label:'Others',value:others_value});}
return output;}
function renderChart(element,data){if(element==='chart'){if(chart){chart=null;}
chart=new Morris.Donut({element:'chart',data:data});}else if(element==='chartRef'){if(chartRef){chartRef=null;}
chartRef=new Morris.Donut({element:'chartRef',data:data});}}
function getDataNow(callback){$http.post('/stats/user-country-today',{}).success(function(result){if(result.s){callback(null,result.d);}else{callback("Failed to get chart data");}}).error(function(){callback("Error From Server");});}
function getRefNow(callback){$http.post('/stats/user-ref-today',{}).success(function(result){if(result.s){callback(null,result.d);}else{callback('Failed to get ref data chart');}});}
function getUtmNow(callback){$http.post('/stats/user-utm-today',{}).success(function(result){if(result.s){callback(null,result.d);}else{callback('Failed to get ref data chart');}});}
function getUtmByDay(time,callback){$http.post('/stats/user-utm-by-day',{time:time.valueOf()}).success(function(result){if(result.s){callback(null,result.d);}else{callback('Failed to get ref chart data');}}).error(function(){callback('Error From Server');});}
function getDataByDay(time,callback){$http.post('/stats/user-country-by-day',{time:time.valueOf()}).success(function(result){if(result.s){callback(null,result.d);}else{callback('Failed to get chart data');}}).error(function(){callback('Error From Server');});}
function getRefByDay(time,callback){$http.post('/stats/user-ref-by-day',{time:time.valueOf()}).success(function(result){if(result.s){callback(null,result.d);}else{callback('Failed to get ref chart data');}}).error(function(){callback('Error From Server');});}
function getData(time,callback){if(isToday(time)){getDataNow(callback);}else{getDataByDay(time,callback);}}
function getRefData(time,callback){if(isToday(time)){getUtmNow(callback);}else{getUtmByDay(time,callback);}}
function isToday(time){return(time.getFullYear()===today.getFullYear()&&time.getMonth()===today.getMonth()&&time.getDate()===today.getDate());}
function displayInfo(time){$scope.isLoading=true;getData(time,function(err,data){$scope.isLoading=false;if(err){return alert(err);}
if(!data||data.length===0){$scope.noData=true;}else{$scope.noData=false;renderChart('chart',handleData(data));}});getRefData(time,function(err,data){if(err){return alert(err);}
if(!data||data.length===0){$scope.noRefData=true;}else{$scope.noRefData=false;renderChart('chartRef',handleData(data));}});}
$scope.showStats=function(){displayInfo(this.date);};}
$scope.premiumCharts=function(){var modalInstance=new $modal.open({templateUrl:'/partials/dashboard/premium_charts.html',controller:ctrlPremiumCharts,resolve:{}});};function ctrlPremiumCharts($modalInstance,$scope){$scope.isLoading=false;var countryChart,eventChart;var today=new Date();$scope.date=new Date();displayPremiumInfo($scope.date);function handleData(data){var output=[];var others_value=0;data.sort(compare);data.forEach(function(element,index){if(index<10){output.push(element);}else{others_value+=element.value;}});if(others_value!=0){output.push({label:'Others',value:others_value});}
return output;}
function renderChart(element,data){if(element==='countryChart'){if(countryChart){countryChart=null;}
countryChart=new Morris.Donut({element:'countryChart',data:data});}}
function getData(time,callback){var postData={};if(time){if(!isToday(time)){postData.time=time.valueOf();}}
$http.post('/stats/premium-country',postData).success(function(result){if(result.s){callback(null,result.d);}else{callback("Failed to get chart data");}}).error(function(){callback("Error From Server");});}
function isToday(time){return(time.getFullYear()===today.getFullYear()&&time.getMonth()===today.getMonth()&&time.getDate()===today.getDate());}
function displayPremiumInfo(time){$scope.isLoading=true;getData(time,function(err,data){$scope.isLoading=false;if(err){return alert(err);}
if(!data||data.length===0){$scope.noData=true;}else{$scope.noData=false;renderChart('countryChart',handleData(data));}});}
$scope.showStats=function(){displayPremiumInfo(this.date);};}});}(angular,moment));'use strict';(function($a){$a.module('ML').controller('dashboardLinkedWallet',function($scope,$rootScope,$modal,$http){$rootScope.MLPageDetail='Dashboard Linked Wallet Details';$rootScope.tabSelect=1;$scope.loadingTopService=false;$scope.serviceRanking=[];function showRank(){if($scope.serviceRanking.length===0){$scope.loadingTopService=true;$http.post('/remote-wallet/provider/wallet-amount',{}).success(function(result){$scope.loadingTopService=false;if(!result.status)return alert('Get service ranking failed');$scope.serviceRanking=result.data;$scope.serviceRanking.sort(function(a,b){return b.amount-a.amount;});}).error(function(){$scope.loadingTopService=false;alert('Error from server');});}}
function init(){showRank();}
init();});}(angular));'use strict';(function($a){$a.module('ML').controller('dashboardPlatform',function($scope,$rootScope,$modal,$http){$rootScope.MLPageDetail='Dashboard Platform Details';$rootScope.tabSelect=1;var dailyLimit=31;var monthlyLimit=12;$scope.dailyEnd=moment().startOf('day');$scope.dailyStart=moment().subtract(dailyLimit,'days').startOf('day');$scope.monthlyEnd=moment().startOf('month');$scope.monthlyStart=moment().subtract(monthlyLimit,'months').startOf('month');$scope.totalDesktop=0;$scope.totalWeb=0;$scope.totalDesktopHasMobile=0;$scope.totalWebHasMobile=0;$scope.loadingDeviceDailyChart=false;$scope.loadingDeviceMonthlyChart=false;$scope.loadingMobileDesktop=false;$scope.loadingDesktop=false;$scope.loadingWeb=false;$scope.loadingMobileWeb=false;var platformChart={dailyPlatform:null,monthlyPlatform:null,yearlyPlatform:null};var mobileDesktopChart;var desktopChart;var mobileWebChart;var webChart;var TYPE={DAILY:1,MONTHLY:3};function getStat(table,types,start,end,limit,callback){$http.post('/stats',{table:table,types:types,start:start.valueOf(),end:end.valueOf(),limit:limit}).success(function(data){callback(false,data);}).error(function(data){callback(true,data);});}
function getMobileHasDesktopUser(callback){$scope.loadingMobileDesktop=true;getStat(903,1,$scope.dailyStart,$scope.dailyEnd,dailyLimit,function(err,data){$scope.loadingMobileDesktop=false;if(err)return callback();var chartData=formatData(data.d);chartData=formatData2(chartData);if(!mobileDesktopChart){mobileDesktopChart=new Morris.Area({element:'mobile-desktop',data:chartData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['value'],labels:['New user'],lineColors:['#3EB249']});}else{mobileDesktopChart.setData(chartData);}
callback();});}
function getDesktopUser(callback){$scope.loadingDesktop=true;getStat(904,1,$scope.dailyStart,$scope.dailyEnd,dailyLimit,function(err,data){$scope.loadingDesktop=false;if(err)return callback();var chartData=formatData(data.d);chartData=formatData2(chartData);if(!desktopChart){desktopChart=new Morris.Area({element:'desktop-total',data:chartData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['value'],labels:['New user'],lineColors:['#3EB249']});}else{desktopChart.setData(chartData);}
callback();});}
function getWebUser(callback){$scope.loadingWeb=true;getStat(905,1,$scope.dailyStart,$scope.dailyEnd,dailyLimit,function(err,data){$scope.loadingWeb=false;if(err)return callback();var chartData=formatData(data.d);chartData=formatData2(chartData);if(!webChart){webChart=new Morris.Area({element:'web-total',data:chartData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['value'],labels:['New user'],lineColors:['#3EB249']});}else{webChart.setData(chartData);}
callback();});}
function getMobileHasWebUser(callback){$scope.loadingMobileWeb=true;getStat(906,1,$scope.dailyStart,$scope.dailyEnd,dailyLimit,function(err,data){$scope.loadingMobileWeb=false;if(err)return callback();var chartData=formatData(data.d);chartData=formatData2(chartData);if(!mobileWebChart){mobileWebChart=new Morris.Area({element:'mobile-web',data:chartData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['value'],labels:['New user'],lineColors:['#3EB249']});}else{mobileWebChart.setData(chartData);}
callback();});}
function getTotalDesktop(callback){$http.post('/dashboard/user-desktop',{}).success(function(result){if(!result.status){alert('Get total desktop failed');return callback();}
$scope.totalDesktop=result.total;$scope.totalDesktopHasMobile=result.hasMobile;callback();}).error(function(){alert("Error from server");callback();});}
function getTotalWeb(callback){$http.post('/dashboard/user-web',{}).success(function(result){if(!result.status){alert('Get total web failed');return callback();}
$scope.totalWeb=result.total;$scope.totalWebHasMobile=result.hasMobile;callback();}).error(function(){alert("Error from server");callback();});}
function getDeviceStat(type,element,start,end,limit,callback){$scope.loadingDeviceChart=true;async.parallel({total:function(cb){getStat(1000,type,start,end,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},android:function(cb){getStat(1010,type,start,end,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},ios:function(cb){getStat(1020,type,start,end,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},wp:function(cb){getStat(1034,type,start,end,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},windows:function(cb){getStat(1035,type,start,end,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},mac:function(cb){getStat(1060,type,start,end,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},web:function(cb){getStat(1070,type,start,end,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});}},function(err,results){var newData=mergeData(results);newData=newData.reverse();if(!platformChart[element]){platformChart[element]=new Morris.Area({element:element,data:newData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['android','ios','wp','windows','mac','web'],labels:['android','ios','wp','windows','mac','web'],lineColors:['#3EB249','#F44336','#FFEB3B','#2196F3','#607D8B','#8E24AA']});}else{platformChart[element].setData(newData);}
$scope.loadingDeviceChart=false;callback();});}
function mergeData(object){var newData=[];var total=object.total.d;var objSize=Object.keys(object).length;var objKeys=Object.keys(object);total.forEach(function(data,index){var info={};info.createAt=data.createAt;for(var i=0;i<objSize;i++){var counter=object[objKeys[i]].d[index]||0;if(counter===0)
info[objKeys[i]]=counter;else
info[objKeys[i]]=counter.counter;}
newData.push(info);});return newData;}
function formatData2(data){var result=[];var dataSize=data.length;for(var i=1;i<dataSize;i++){var obj={};obj.createAt=data[i].createAt;obj.value=data[i].counter-data[i-1].counter;result.push(obj);}
return result;}
function formatData(data){if(data.length>0){data.sort(function(a,b){var timestampA=moment(a.createAt).valueOf();var timestampB=moment(b.createAt).valueOf();return timestampA-timestampB;});var newData=[];data.forEach(function(stat){if(stat&&stat.createAt){var newCreateTime;newCreateTime=moment(stat.createAt).subtract(1,'minutes').subtract(7,'hours').format('DD/MM');newData.push({counter:stat.counter,createAt:newCreateTime});}});return newData;}else{return[];}}
function init(){$scope.loadingDeviceDailyChart=true;getDeviceStat(TYPE.DAILY,'dailyPlatform',$scope.dailyStart,$scope.dailyEnd,dailyLimit,function(){$scope.loadingDeviceDailyChart=false;$scope.loadingDeviceMonthlyChart=true;getDeviceStat(TYPE.MONTHLY,'monthlyPlatform',$scope.monthlyStart,$scope.monthlyEnd,monthlyLimit,function(){$scope.loadingDeviceMonthlyChart=false;getMobileHasDesktopUser(function(){getDesktopUser(function(){getWebUser(function(){getMobileHasWebUser(function(){getTotalDesktop(function(){getTotalWeb(function(){});})});});});});});});}
init();});}(angular));'use strict';(function($a){$a.module('ML').controller('dashboardPremium',function($scope,$rootScope,$modal,$http){$rootScope.MLPageDetail='Dashboard Premium Details';$rootScope.tabSelect=1;$scope.dailyEndTime=moment().format('DD/MM/YYYY');$scope.dailyStartTime=moment().subtract(15,'days').format('DD/MM/YYYY');$scope.monthlyEndTime=moment().startOf('month').format('DD/MM/YYYY');$scope.monthlyStartTime=moment().subtract(12,'months').startOf('month').format('DD/MM/YYYY');$scope.yearlyEndTime=moment().startOf('year').format('DD/MM/YYYY');$scope.yearlyStartTime=moment().subtract(5,'years').startOf('year').format('DD/MM/YYYY');$scope.countryEndTime=moment().format('DD/MM/YYYY');$scope.countryStartTime=moment().subtract(15,'days').format('DD/MM/YYYY');var dailyChart;var monthlyChart;var yearlyChart;var countryChart;$scope.userCountryData=[];$scope.isLoadingDaily=false;$scope.isLoadingMonthly=false;$scope.isLoadingYearly=false;$scope.isLoadingCountry=false;function getUserCountryData(startTime,endTime,callback){$scope.isLoadingCountry=true;$http.post('/stats/premium-country-for-dashboard',{start:startTime,end:endTime}).success(function(result){$scope.isLoadingCountry=false;if(!result.status){alert('Get user country data failed');return callback();}
$scope.totalByDateRange=result.total;result.data.sort(function(a,b){return b.value-a.value;});var top15Total=0;var countryRatio=[];var limit=(result.data.length>=15)?15:result.data.length;for(var i=0;i<limit;i++){top15Total+=(result.data[i].value/result.total)*100;countryRatio.push({label:result.data[i].label,value:(result.data[i].value/result.total)*100});}
if(result.data.length>15){countryRatio.push({label:'Other',value:100-top15Total});}
countryRatio.map(function(data){data.value=data.value.toFixed(2);return data;});$scope.userCountryData=result.data;if(countryChart){countryChart.setData(countryRatio);}else{countryChart=new Morris.Donut({element:'countryChart',data:countryRatio});}
callback();}).error(function(){$scope.isLoadingCountry=false;alert("Error from server");callback();});}
function getDailyData(start,end,callback){$scope.isLoadingDaily=true;$http.post('/user/premium-count',{start:start,end:end,mode:'days'}).success(function(result){$scope.isLoadingDaily=false;if(!result.s){alert('Get daily data failed');return callback();}
if(dailyChart){dailyChart.setData(result.d);}else{dailyChart=new Morris.Area({element:'dailyChart',data:result.d,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['amount'],labels:['Total'],lineColors:['#379ca8']});}
callback();}).error(function(){$scope.isLoadingDaily=false;callback();});}
function getMonthlyData(start,end,callback){$scope.isLoadingMonthly=true;$http.post('/user/premium-count',{start:start,end:end,mode:'months'}).success(function(result){$scope.isLoadingMonthly=false;if(!result.s){alert('Get monthly data failed');return callback();}
if(monthlyChart){monthlyChart.setData(result.d);}else{monthlyChart=new Morris.Area({element:'monthlyChart',data:result.d,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['amount'],labels:['Total'],lineColors:['#379ca8']});}
callback();}).error(function(){$scope.isLoadingMonthly=false;callback();});}
function getYearlyData(start,end,callback){$scope.isLoadingYearly=true;$http.post('/user/premium-count',{start:start,end:end,mode:'years'}).success(function(result){$scope.isLoadingYearly=false;if(!result.s){alert('Get yearly data failed');return callback();}
if(yearlyChart){yearlyChart.setData(result.d);}else{yearlyChart=new Morris.Area({element:'yearlyChart',data:result.d,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['amount'],labels:['Total'],lineColors:['#379ca8']});}
callback();}).error(function(){$scope.isLoadingYearly=false;callback();});}
$scope.openDateRangePicker2=function(){var modalInstance=$modal.open({templateUrl:'change-user-daily-date-range.html',controller:datePickerCtrl,resolve:{}});modalInstance.result.then(function(dateRange){$scope.countryStartTime=dateRange.startTime;$scope.countryEndTime=dateRange.endTime;getUserCountryData($scope.countryStartTime,$scope.countryEndTime,function(){});});};function datePickerCtrl($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.pick=function(){if(!this.info||!this.info.sd||!this.info.ed){return alert('Please pick start date and end date');}
var startTime=moment(this.info.sd).format('DD/MM/YYYY');var endTime=moment(this.info.ed).format('DD/MM/YYYY');$modalInstance.close({startTime:startTime,endTime:endTime});}}
function init(){getDailyData($scope.dailyStartTime,$scope.dailyEndTime,function(){getMonthlyData($scope.monthlyStartTime,$scope.monthlyEndTime,function(){getYearlyData($scope.yearlyStartTime,$scope.yearlyEndTime,function(){getUserCountryData($scope.countryStartTime,$scope.countryEndTime,function(){});});});});}
init();});}(angular));'use strict';(function($a){$a.module('ML').controller('dashboardTransaction',function($scope,$rootScope,$http,$modal){$rootScope.MLPageDetail='Dashboard transaction detail';$rootScope.tabSelect=1;$scope.dailyEnd=moment().startOf('day');$scope.dailyStart=moment().subtract(15,'days').startOf('day');$scope.monthlyEnd=moment().startOf('month');$scope.monthlyStart=moment().subtract(12,'months').startOf('month');var monthlyChart;var dailyChart;var dailyLimit=15;var monthlyLimit=12;$scope.isLoadingDaily=false;$scope.isLoadingMonthly=false;function getStat(table,types,start,end,limit,callback){$http.post('/stats',{table:table,types:types,start:start,end:end,limit:limit}).success(function(data){callback(false,data);}).error(function(data){callback(true,data);});}
function getTransactionStat(chart,type,element,start,end,limit,callback){async.parallel({transaction:function(cb){getStat(600,type,start.valueOf(),end.valueOf(),limit,function(err,data){if(err)cb(null,[]);else cb(null,data);});},transactionDelete:function(cb){getStat(603,type,start.valueOf(),end.valueOf(),limit,function(err,data){if(err)cb(null,[]);else cb(null,data);});}},function(err,results){var newTransData=formatData(results.transaction.d);var newTransDelData=formatData(results.transactionDelete.d);var data=mergeTransaction(newTransData,newTransDelData);if(!chart){chart=new Morris.Area({element:element,data:data,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['create','del'],labels:['Create','Delete'],lineColors:['#379ca8','#ed5564']});}else{chart.setData(data);}
callback();});}
function formatData(data){if(data.length>0){data.sort(function(a,b){var timestampA=moment(a.createAt).valueOf();var timestampB=moment(b.createAt).valueOf();return timestampA-timestampB;});var newData=[];data.forEach(function(stat){if(stat&&stat.createAt){var newCreateTime;newCreateTime=moment(stat.createAt).subtract(1,'minutes').subtract(7,'hours').format('DD/MM');newData.push({counter:stat.counter,createAt:newCreateTime});}});return newData;}else{return[];}}
function mergeTransaction(datas1,datas2){var newData=[];datas1.forEach(function(data,index){newData.push({create:data.counter,del:datas2[index].counter,createAt:data.createAt});});return newData;}
function init(){$scope.isLoadingDaily=true;getTransactionStat(dailyChart,1,'dailyChart',$scope.dailyStart,$scope.dailyEnd,dailyLimit,function(){$scope.isLoadingDaily=false;$scope.isLoadngMonthly=true;getTransactionStat(monthlyChart,3,'monthlyChart',$scope.monthlyStart,$scope.monthlyEnd,monthlyLimit,function(){$scope.isLoadingMonthly=false;});});}
init();});}(angular));(function($a){'use strict';$a.module('ML').controller('dashboardUser',function($scope,$rootScope,$modal,$http){$rootScope.MLPageDetail='Dashboard User Details';$rootScope.tabSelect=1;var dailyChart;var monthlyChart;var yearlyChart;$scope.dailyEndTime=moment().format('DD/MM/YYYY');$scope.dailyStartTime=moment().subtract(15,'days').format('DD/MM/YYYY');$scope.monthlyEndTime=moment().startOf('month').format('DD/MM/YYYY');$scope.monthlyStartTime=moment().subtract(12,'months').startOf('month').format('DD/MM/YYYY');$scope.yearlyEndTime=moment().startOf('year').format('DD/MM/YYYY');$scope.yearlyStartTime=moment().subtract(5,'years').startOf('year').format('DD/MM/YYYY');$scope.countryEndTime=moment().format('DD/MM/YYYY');$scope.countryStartTime=moment().subtract(15,'days').format('DD/MM/YYYY');$scope.userCountryData=[];$scope.isLoadingDaily=false;$scope.isLoadingMonthly=false;$scope.isLoadingYearly=false;$scope.isLoadingCountry=false;var countryChart;function setDailyChart(startTime,endTime,callback){$scope.isLoadingDaily=true;$http.post('/dashboard/user-stats',{start_time:startTime,end_time:endTime,mode:1}).success(function(result){$scope.isLoadingDaily=false;if(!result.status){alert('Get daily data failed');return callback();}
if(dailyChart){dailyChart.setData(result.data);}else{dailyChart=new Morris.Area({element:'dailyChart',data:result.data,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['total'],labels:['Total'],lineColors:['#379ca8']});}
callback();}).error(function(){$scope.isLoadingDaily=false;alert("Error from server");callback();});}
function setMonthlyChart(startTime,endTime,callback){$scope.isLoadingMonthly=true;$http.post('/dashboard/user-stats',{start_time:startTime,end_time:endTime,mode:2}).success(function(result){$scope.isLoadingMonthly=false;if(!result.status){alert('Get daily data failed');return callback();}
if(monthlyChart){monthlyChart.setData(result.data);}else{monthlyChart=new Morris.Area({element:'monthlyChart',data:result.data,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['total'],labels:['Total'],lineColors:['#379ca8']});}
callback();}).error(function(){$scope.isLoadingMonthly=false;alert("Error from server");callback();});}
function setYearlyChart(startTime,endTime,callback){$scope.isLoadingYearly=true;$http.post('/dashboard/user-stats',{start_time:startTime,end_time:endTime,mode:3}).success(function(result){$scope.isLoadingYearly=false;if(!result.status){alert('Get yearly data failed');return callback();}
if(yearlyChart){yearlyChart.setData(result.data);}else{yearlyChart=new Morris.Area({element:'yearlyChart',data:result.data,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['total'],labels:['Total'],lineColors:['#379ca8']});}
callback();}).error(function(){$scope.isLoadingYearly=false;alert("Error from server");callback();});}
function getUserCountryData(startTime,endTime,callback){$scope.isLoadingCountry=true;$http.post('/stats/user-country-by-date-range',{start_time:startTime,end_time:endTime}).success(function(result){$scope.isLoadingCountry=false;if(!result.status){alert('Get user country data failed');return callback();}
$scope.totalByDateRange=result.total;result.data.sort(function(a,b){return b.value-a.value;});var top15Total=0;var countryRatio=[];var limit=(result.data.length>=15)?15:result.data.length;for(var i=0;i<limit;i++){top15Total+=(result.data[i].value/result.total)*100;countryRatio.push({label:result.data[i].label,value:(result.data[i].value/result.total)*100});}
if(result.data.length>15){countryRatio.push({label:'Other',value:100-top15Total});}
countryRatio.map(function(data){data.value=data.value.toFixed(2);return data;});$scope.userCountryData=result.data;if(countryChart){countryChart.setData(countryRatio);}else{countryChart=new Morris.Donut({element:'countryChart',data:countryRatio});}
callback();}).error(function(){$scope.isLoadingCountry=false;alert("Error from server");callback();});}
$scope.openDateRangePicker=function(){var modalInstance=$modal.open({templateUrl:'change-user-daily-date-range.html',controller:datePickerCtrl,resolve:{}});modalInstance.result.then(function(dateRange){$scope.dailyStartTime=dateRange.startTime;$scope.dailyEndTime=dateRange.endTime;setDailyChart($scope.dailyStartTime,$scope.dailyEndTime,function(){});});};$scope.openDateRangePicker2=function(){var modalInstance=$modal.open({templateUrl:'change-user-daily-date-range.html',controller:datePickerCtrl,resolve:{}});modalInstance.result.then(function(dateRange){$scope.countryStartTime=dateRange.startTime;$scope.countryEndTime=dateRange.endTime;getUserCountryData($scope.countryStartTime,$scope.countryEndTime,function(){});});};function datePickerCtrl($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.pick=function(){if(!this.info||!this.info.sd||!this.info.ed){return alert('Please pick start date and end date');}
var startTime=moment(this.info.sd).format('DD/MM/YYYY');var endTime=moment(this.info.ed).format('DD/MM/YYYY');$modalInstance.close({startTime:startTime,endTime:endTime});}}
function init(){setDailyChart($scope.dailyStartTime,$scope.dailyEndTime,function(){setMonthlyChart($scope.monthlyStartTime,$scope.monthlyEndTime,function(){setYearlyChart($scope.yearlyStartTime,$scope.yearlyEndTime,function(){getUserCountryData($scope.countryStartTime,$scope.countryEndTime,function(){});});});});}
init();});}(angular));'use strict';(function($a){$a.module('ML').controller('dashboardWallet',function($scope,$rootScope,$modal,$http){$rootScope.tabSelected=1;$rootScope.MlPageDetail='Dashboard wallet';$scope.dailyStart=moment().subtract(15,'days').startOf('days');$scope.dailyEnd=moment().startOf('days');$scope.monthlyStart=moment().subtract(12,'months').startOf('month');$scope.monthlyEnd=moment().startOf('month');$scope.isLoadingDaily=false;$scope.isLoadingMonthly=false;var dailyChart;var monthlyChart;function getStat(table,types,start,end,limit,callback){$http.post('/stats',{table:table,types:types,start:start,end:end,limit:limit}).success(function(data){callback(false,data);}).error(function(data){callback(true,data);});}
function formatData(data){if(data.length>0){data.sort(function(a,b){var timestampA=moment(a.createAt).valueOf();var timestampB=moment(b.createAt).valueOf();return timestampA-timestampB;});var newData=[];data.forEach(function(stat){if(stat&&stat.createAt){var newCreateTime;newCreateTime=moment(stat.createAt).subtract(1,'minutes').subtract(7,'hours').format('DD/MM');newData.push({counter:stat.counter,createAt:newCreateTime});}});return newData;}else{return[];}}
function getDailyChart(callback){$scope.isLoadingDaily=true;getStat(100,1,$scope.dailyStart.valueOf(),$scope.dailyEnd.valueOf(),15,function(err,data){$scope.isLoadingDaily=false;if(err){console.log(err);}else{var newData=formatData(data.d);if(!dailyChart){dailyChart=new Morris.Area({element:'dailyChart',data:newData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['counter'],labels:['Total'],lineColors:['#379ca8']});}else{dailyChart.setData(newData);}}
callback();});}
function getMonthlyChart(callback){$scope.isLoadingMonthly=false;getStat(100,3,$scope.monthlyStart.valueOf(),$scope.monthlyEnd.valueOf(),12,function(err,data){if(err){console.log(err);}else{var newData=formatData(data.d);if(!monthlyChart){monthlyChart=new Morris.Area({element:'monthlyChart',data:newData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['counter'],labels:['Total'],lineColors:['#379ca8']});}else{monthlyChart.setData(newData);}
callback();}});}
function init(){getDailyChart(function(){getMonthlyChart(function(){});});}
init();});}(angular));(function($a){$a.module('ML').controller('discountController',function($scope,$rootScope,$http){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Discount';$scope.send=function(){readFile(function(err,emailList){if(err)return alert(err);$scope.discount.listEmail=emailList;switch($scope.productType){case"99":sendAllDiscount($scope.discount);break;case"1":break;case"2":break;case"4":break;case"3":break;case"5":break;default:break;}});};function sendAllDiscount(discount){var discountInfo={listEmail:discount.listEmail,campaign:discount.campaign,userDiscount:discount.userDiscount,type:$scope.productType};$http.post('/user/update-discount-list-email',{discountInfo:discountInfo}).success(function(data){if(!data.status){return alert('Send discount failed');}
alert('Sent discount to list of user');init();}).error(function(){alert('Error while send icon gift');});}
function getIconList(){if($scope.iconList.length>0){return true;}
$http.post('/icons/get',{}).success(function(data){if(!data.error){$scope.iconList=data.data;}}).error(function(data){alert("Error while get icon list");});}
function getCreditList(){if($scope.creditList.length>0){return true;}
$http.post('/use-credits/list',{}).success(function(result){if(result.s){$scope.creditList=result.d;}else{alert('Get credit list due to failed');}}).error(function(){alert('Error From Server');});}
function getPremiumList(){if($scope.premiumList.length>0){return true;}
$http.post('/premium-products/list',{}).success(function(result){if(!result.s){return alert('Get premium product due to failed');}
$scope.premiumList=result.d;}).error(function(){alert('Error From Server');});}
function getSubscriptionList(){if($scope.subscriptionList.length>0){return true;}
$http.post('/subscription-products/gift',{}).success(function(result){if(!result.s){return alert('Get subscription product due to failed');}
$scope.subscriptionList=result.d;}).error(function(){alert('Error from server');});}
function readFile(callback){var file=document.getElementById("txtFile").files[0];if(!file)return callback('Please select email file');var mailListFromFile=[];var reader=new FileReader();reader.onload=function(e){var text=reader.result.toString();var a=text.split('\n');mailListFromFile=checkNullEmail(a);callback(null,mailListFromFile);};reader.readAsText(file,"utf-8");function checkNullEmail(list){var new_list=[];list.forEach(function(email){if(email!=""){new_list.push(email);}});return new_list;}}
$scope.productTypeSelected=function(){var type=this.productType;switch(type){case'1':getIconList();break;case'2':getSubscriptionList();break;case'3':getCreditList();break;case'4':getSubscriptionList();break;case'5':getPremiumList();break;default:break;}};function init(){$scope.productType="99";$scope.creditList=[];$scope.premiumList=[];$scope.subscriptionList=[];$scope.iconList=[];$scope.discount={};}
init();});}(angular));(function($a){'use strict';$a.module('ML').controller('email_push_automation',function($scope,$rootScope,$modal,$routeParams,$http,$q){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Automation';$scope.page=1;var limit=20;$scope.auto={};$scope.search_queries={};$scope.templates={};$scope.email_push_automation={};$scope.noContent=false;$scope.push_notification={};$scope.autoEdit={};$scope.suggests=[];$scope.isFirstPage=true;$scope.isLastPage=true;$scope.automation_types=[{"name":"Email","value":1},{"name":'Push Notificaiton',"value":2}];$scope.$on('$viewContentLoaded',function(){$q.all([loadContent($scope.page),selectSearchQuery(),selectTemplate(),loadPushNotification(),selectQueryQuick($routeParams),loadCampaigns(),loadGroups()]).then(function(response){var loadContentResolve=response[0];var searchQueryResolve=response[1];var templateResolve=response[2];var pushNotification=response[3];var selectQueryQuickResponse=response[4];var campaigns=response[5];var groups=response[6];$scope.isSearchQueryChoosen=false;$scope.auto={};$scope.email_push_automation=loadContentResolve;$scope.templates=templateResolve;$scope.push_notification=pushNotification;$scope.campaigns=campaigns;$scope.groups=groups;if($routeParams.modal){console.log('gia tri routerParams:',$routeParams.modal)
$scope.search_queries=selectQueryQuickResponse;$scope.search_query=$scope.search_queries[0];$scope.isSearchQueryChoosen=true;$scope.create();}else{$scope.search_queries=searchQueryResolve;}})});$scope.filterItem=function(condition){var url='/api/automation/filter';var param=condition;$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.email_push_automation=response.data.data;if($scope.email_push_automation.length<1){$scope.noContent=true;}else{$scope.noContent=false;}
excutePage(response.data);}else{alert('Get list group error');}}},function errorCallback(response){alert(response.status);});}
function loadGroups(){var deferred=$q.defer();var url='/api/group/browse';var param={skip:0,limit:10000}
$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.groups=response.data.data
deferred.resolve(response.data.data);}else{deferred.reject();alert('Get list group error');}}},function errorCallback(response){deferred.reject();alert(response.status);});return deferred.promise;}
function loadCampaigns(){var deferred=$q.defer();var url='/api/campaign-marketing/browse';var param={skip:0,limit:10000}
$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.campaigns=response.data.data;deferred.resolve(response.data.data);}else{deferred.reject();alert('Get list campaign error');}}},function errorCallback(response){deferred.reject();alert(response.status);});return deferred.promise;}
function selectQueryQuick(routeParams){var deferred=$q.defer();var search_queries=new Array();if(routeParams.modal){if(routeParams.id){var search_query=routeParams.id;findSearchQueryById(search_query).then(function(searchQuery){search_queries.push(searchQuery);deferred.resolve(search_queries);});}else{deferred.resolve(search_queries);}}else{deferred.resolve(search_queries);}
return deferred.promise;}
function findSearchQueryById(searchQueryId){var url='/search-query/get-one';var param={id:searchQueryId}
var deferred=$q.defer();$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.s){deferred.resolve(response.data.d);}else{deferred.reject();alert('Get search query error');}}},function errorCallback(response){deferred.reject();alert(response.status);});return deferred.promise;}
$scope.search=function(keyword,filter){if(keyword){var url='/api/automation/search';var params={keyword:keyword,type:filter.type};$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){if(filter.type==="1"){$scope.campaigns=response.data.data;if($scope.campaigns.length<1){$scope.noContent=true;}else{$scope.noContent=false;}}else if(filter.type==="2"){$scope.groups=response.data.data;if($scope.groups.length<1){$scope.noContent=true;}else{$scope.noContent=false;}}else if(filter.type==="3"){$scope.email_push_automation=response.data.data;if($scope.email_push_automation.length<1){$scope.noContent=true;}else{$scope.noContent=false;}}
excutePage(response.data);}else{alert('Get list email push automation error');}}},function errorCallback(response){alert(response.status);});}}
$scope.choose=function(name){document.getElementById("txtKeyword").value="";document.getElementById("txtKeyword").value=name;$scope.keyword=document.getElementById("txtKeyword").value;document.getElementById("txtKeyword").value="";}
$scope.searchKey=function(event,keyword,filter){if(keyword){var url='/api/automation/liveSearch';var param={keyword:keyword,type:filter.type};if(event.keyCode===13){$scope.search(keyword,filter);}else{$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status){$scope.suggests=response.data.data;}else{alert(response.data.message);}},function errorCallback(response){alert('Error from server');});}}}
$scope.nextPage=function(num){$scope.page+=num;loadContent($scope.page);};function excutePage(scope){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.email_push_automation.length<limit;};function generateTime(){var arrayTime=[];for(var i=0;i<24;i++){var hour=i.toString();if(0<=i&&i<10){hour='0'+i.toString();}
for(var j=0;j<2;j++){var mintute;if(j===0){mintute='00';}else if(j===1){mintute='30';}
var time=hour+':'+mintute;arrayTime.push(time);}}
return arrayTime;}
function loadContent(page){var url='/api/email_push_automation/browse';var skip=limit*(page-1);var params={skip:skip,limit:limit,page:page};var deferred=$q.defer();$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.email_push_automation=response.data.data;if($scope.email_push_automation.length<1){$scope.noContent=true;}else{$scope.noContent=false;}
excutePage(response.data);deferred.resolve(response.data.data);}else{deferred.reject();alert('Get list email push automation error');}}},function errorCallback(response){deferred.reject();alert(response.status);});return deferred.promise;};function selectSearchQuery(){var url='/search-query/get';var params={skip:0,limit:limit};$scope.isLoading=true;var deferred=$q.defer();$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.s){$scope.search_queries=response.data.d;deferred.resolve(response.data.d);}else{deferred.reject();alert('Get list search query error');}}},function errorCallback(response){deferred.reject();alert(response.status);});return deferred.promise;};function selectTemplate(){var url='/api/template/browse';var params={'page':$scope.page,'limit':limit};var deferred=$q.defer();$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.templates=response.data.data.records;deferred.resolve(response.data.data.records);}else{deferred.reject();alert('Get list tempalte error');}}},function errorCallback(response){deferred.reject();alert(response.status);});return deferred.promise;};function loadPushNotification(){var url='/message/get';var deferred=$q.defer();$http({method:'POST',url:url}).then(function successCallback(response){if(response.status==200){if(!response.data.err){$scope.push_notification=response.data.data;deferred.resolve(response.data.data);}else{deferred.reject();alert('Get list push notification error');}}},function errorCallback(response){deferred.reject();alert(response.status);});return deferred.promise;};$scope.changeDisabled=function(automation){var url='/api/email_push_automation/enable';var data={};data._id=automation._id;data.isEnabled=!automation.isEnabled;$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadContent($scope.page);}else{alert('update error');}}},function errorCallback(response){alert(response.status);});};$scope.delete=function(automation){var ok=confirm("You will delete "+automation.name+", are you sure?");if(ok){var url='/api/email_push_automation/delete';var data={};data._id=automation._id;$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadContent($scope.page);}else{alert('update error');}}},function errorCallback(response){alert(response.status);});}};$scope.detail=function(automation){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/detail.html',controller:ctrlDetail,resolve:{scope:function(){return automation;}}});modalInstance.result.then(function(data){});}
function ctrlDetail($scope,$modalInstance,scope){$scope.init=function(){if(scope.type==1){$scope.type='Email';}else if(scope.type==2){$scope.type='Push Notification';}
$scope.autoDetail=scope;$scope.itemDetailName=scope.name;}();$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.edit=function(automation){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/edit.html',controller:ctrlUpdate,resolve:{scope:function(){return automation;},searchQuery:function(){return $scope.search_queries;},template:function(){return $scope.templates;},push_notification:function(){return $scope.push_notification;},automation_types:function(){return $scope.automation_types;}}});modalInstance.result.then(function(data){});};function ctrlUpdate($scope,$modalInstance,scope,searchQuery,template,push_notification,automation_types){$scope.init=function(){$scope.autoEdit=scope;$scope.search_queries=searchQuery;$scope.templates=template;$scope.push_notification=push_notification;$scope.automation_types=automation_types;if(scope.metadata){$scope.autoEdit.push=scope.metadata;}
$scope.time=generateTime();}();$scope.update=function(autoEdit){var url='/api/email_push_automation/update';var data={};data._id=autoEdit._id;if(autoEdit.searchQuery){data.searchQuery=autoEdit.searchQuery;}
if(autoEdit.metadata.template){var templateObject=autoEdit.metadata.template;if(typeof templateObject!=='object'){templateObject=JSON.parse(templateObject);}
if(!templateObject.template_uid||!templateObject.screenshot&&templateObject.name){for(var i=0;i<$scope.templates.length;i++){if($scope.templates[i].name===templateObject.name){templateObject=$scope.templates[i];if(typeof templateObject!=='object'){templateObject=JSON.parse(templateObject);}
data.template={'id':templateObject.template_uid,'name':templateObject.name,'thumbUrl':templateObject.screenshot};}}}else{data.template={'id':templateObject.template_uid,'name':templateObject.name,'thumbUrl':templateObject.screenshot};}}
if(autoEdit.name){data.name=autoEdit.name;}
if(autoEdit.metadata.subject){data.subject=autoEdit.metadata.subject;}
if(autoEdit.metadata.fromEmail){data.fromEmail=autoEdit.metadata.fromEmail;}
if(autoEdit.metadata.fromName){data.fromName=autoEdit.metadata.fromName}
if(autoEdit.metadata.replyTo){data.replyTo=autoEdit.metadata.replyTo;}
if(autoEdit.mode){data.mode=autoEdit.mode;}
if(autoEdit.type){data.type=autoEdit.type;}
if(autoEdit.metadata.hourRun){data.hourRun=autoEdit.metadata.hourRun;}
if(autoEdit.push){data.pushObject=autoEdit.push;}
$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadContent($scope.page);}else{alert('update error');}}},function errorCallback(response){alert(response.status);});$modalInstance.close();}
$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.create=function(){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/create_new.html',controller:ctrlCreate,resolve:{selectSearchQuery:function(){return $scope.search_queries;},selectTemplate:function(){return $scope.templates;},auto:function(){return $scope.auto;},push_notification:function(){return $scope.push_notification;},search_query_choose:function(){return $scope.search_query||{};},campaigns:function(){return $scope.campaigns;},groups:function(){return $scope.groups;},automation_types:function(){return $scope.automation_types;}}});modalInstance.result.then(function(data){});};function ctrlCreate($scope,$modalInstance,selectSearchQuery,selectTemplate,auto,push_notification,search_query_choose,campaigns,groups,automation_types){$scope.init=function(){$scope.search_queries=selectSearchQuery;$scope.templates=selectTemplate;$scope.push_notification=push_notification;$scope.time=generateTime();$scope.initTime=$scope.time[16].toString();$scope.auto=auto;$scope.campaigns=campaigns;$scope.groups=groups;$scope.automation_types=automation_types;if($scope.search_queries.length===1){$scope.search_query=search_query_choose;auto.search_query=$scope.search_query._id;}}();$scope.save=function(auto){var url='/api/email_push_automation/create';if(auto.template){auto.template=JSON.parse(auto.template);}
var params={name:auto.name,search_query:auto.search_query,mode:auto.mode,type:auto.type,hourRun:auto.hourRun||'08:00',campaign:auto.campaign,group:auto.group,tracking:auto.tracking};if(auto.type==1){params.subject=auto.subject;params.fromName=auto.fromName;params.fromEmail=auto.fromEmail;params.replyTo=auto.replyTo;params.template_info={id:auto.template.template_uid,name:auto.template.name,thumb:auto.template.screenshot}}else if(auto.type==2){if(typeof auto.push=='string'){params.pushObject=JSON.parse(auto.push);}else{params.pushObject=auto.push;}}
$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadContent($scope.page);}else{alert('Save automation error');}}},function errorCallback(response){alert(response.status);});$modalInstance.close();}
$scope.createCampaign=function(){var modalInstance=$modal.open({animation:true,templateUrl:'/partials/email_push_automation/create_campaign.html',controller:'campaignCreateModal',resolve:{}});modalInstance.result.then(function(data){auto.campaign=data._id;auto.type=data.type;$scope.campaigns=[];$scope.campaigns.push(data);});}
$scope.createGroup=function(){var modalInstance=$modal.open({animation:true,templateUrl:'/partials/email_push_automation/create_group.html',controller:'groupCreateModal',resolve:{}});modalInstance.result.then(function(data){auto.group=data._id;$scope.groups=[];$scope.groups.push(data);});}
$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.duplicateCampaign=function(camp){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/duplicate_campaign.html',controller:ctrDupCamp,resolve:{campaign:function(){return camp;}}});modalInstance.result.then(function(data){});}
function ctrDupCamp($scope,$modalInstance,campaign){$scope.createCopies=function(duplicate){var url='/api/group/duplicateCampaign'
var param={_id:campaign._id,copies:duplicate.number}
$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadCampaigns();}else{alert('Update error!')}}},function errorCallback(response){alert(response.alert)});$modalInstance.close();}
$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.detailCampaign=function(camp){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/detail_campaign.html',controller:ctrDetailCamp,resolve:{scope:function(){return camp;}}});modalInstance.result.then(function(data){});}
function ctrDetailCamp($scope,$modalInstance,scope){$scope.init=function(){$scope.CampDetail=scope;}();$scope.cancel=function(){$modalInstance.dismiss('cancel')}}
$scope.editCampaign=function(camp){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/edit_campaign.html',controller:ctrUpdateCampaign,resolve:{scope:function(){return camp;}}});modalInstance.result.then(function(data){});}
function ctrUpdateCampaign($scope,$modalInstance,scope){$scope.init=function(){$scope.EditCampaign=scope;}();$scope.updateCampaign=function(EditCampaign){var url='/api/campaign/update';var data={};data._id=EditCampaign._id;if(EditCampaign.name){data.name=EditCampaign.name;}
if(EditCampaign.type){data.type=EditCampaign.type;}
$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadCampaigns();}else{alert('Update error!')}}},function errorCallback(response){alert(response.alert)});$modalInstance.close();};$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.deleteCampaign=function(camp){var ok=confirm("You will delete "+camp.name+" are you sure?");if(ok){var url='/api/campaign/delete';var data={};data._id=camp._id;$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadCampaigns();}else{alert('Delete error!')}}},function errorCallback(response){alert(response.status)})}}
$scope.duplicateGroup=function(group){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/duplicate_group.html',controller:ctrDupGroup,resolve:{group:function(){return group;}}});modalInstance.result.then(function(data){});}
function ctrDupGroup($scope,$modalInstance,group){$scope.createCopies=function(duplicate){var url='/api/group/duplicategroup';var data={};data._id=group._id;data.copies=duplicate.number;$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadGroups();}else{alert('Duplicate Error!')}}},function errorCallback(response){alert(response);});$modalInstance.close();}
$scope.cancel=function(){$modalInstance.dismiss('calcel')}}
$scope.duplicateAuto=function(automation){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/duplicate_auto.html',controller:ctrDupGroup,resolve:{automation:function(){return automation;},campaigns:function(){return $scope.campaigns;},groups:function(){return $scope.groups;}}});modalInstance.result.then(function(data){});}
function ctrDupGroup($scope,$modalInstance,automation,campaigns,groups){$scope.init=function(){$scope.campaigns=campaigns;$scope.groups=groups;}();$scope.createCopies=function(duplicate){var url='/api/automation/duplicate';var param={auto:JSON.stringify(automation),campaign:duplicate.campaign,group:duplicate.group,number:duplicate.number};$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadContent($scope.page);}else{alert('Duplicate Error!')}}},function errorCallback(response){alert(response);});$modalInstance.close();}
$scope.cancel=function(){$modalInstance.dismiss('calcel')}}
$scope.detailGroup=function(group){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/detail_group.html',controller:ctrlDetailGroup,resolve:{scope:function(){return group;}}});modalInstance.result.then(function(data){});}
function ctrlDetailGroup($scope,$modalInstance,scope){$scope.init=function(){$scope.GroupDetail=scope;}();$scope.cancel=function(){$modalInstance.dismiss('calcel')}}
$scope.editGroup=function(group){var modalInstance=$modal.open({templateUrl:'/partials/email_push_automation/edit_group.html',controller:ctrUpdateGroup,resolve:{scope:function(){return group;}}});modalInstance.result.then(function(data){})};function ctrUpdateGroup($scope,$modalInstance,scope){$scope.init=function(){$scope.EditGroup=scope;}();$scope.updateGroup=function(EditGroup){var url='/api/group/update';var data={};data._id=EditGroup._id;if(EditGroup.name){data.name=EditGroup.name;}
if(EditGroup.metadata.devices){data.devices=EditGroup.metadata.devices;}
if(EditGroup.metadata.countries){data.countries=EditGroup.metadata.countries;}
$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadGroups();}else{alert('Update error!');}}},function errorCallback(response){alert(response.status);});$modalInstance.close();}
$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.deleteGroup=function(group){var ok=confirm("You will delete "+group.name+", are you sure?");if(ok){var url='/api/group/delete';var data={};data._id=group._id;$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadGroups()}else{alert("Delete Error !")}}},function errorCallback(response){alert("Loi khong co Data ",response.status)})}}
$scope.changeDisabledCampaign=function(camp){var url='/api/campaign-marketing/enablecampaign';var data={}
data._id=camp._id;data.isDisable=!camp.isDisable
$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadCampaigns()
loadGroups()
loadContent($scope.page)}else{alert('Update Error!')}}},function errorCallback(response){alert('No data '+response.status)})}
$scope.changeDisabledGroup=function(group){var url='/api/group/enablegroup';var data={};data._id=group._id;data.isDisable=!group.isDisable;$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadGroups()
loadContent($scope.page)}else{alert('update error');}}},function errorCallback(response){alert('Loi khong co data'+response.status);});}})}(angular));(function($a){'use strict';var initQuest='Bạn thực sự muốn thực hiện thao tác này?';$a.module('ML').controller('emails',function($scope,$http,$rootScope,$modal){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Email';$scope.addNewMail=true;$scope.listMail=[];$scope.createMail=0;$scope.emailInfo={};$scope.getList=function(){this.searchKeyword='';$scope.createMail=0;$http.post('/emails/list',{}).success(function(data){if(data.err)alert(data.msg);else $scope.listMail=data.data;}).error(function(){alert('Error');});};$scope.openActions=function(mail){var modalInstance=$modal.open({templateUrl:'partials/emails/openActions.html',controller:mobileController,resolve:{email:function(){return mail;}}});};var mobileController=function($scope,$modalInstance,email){$scope.mail=email;$scope.send=function(mail){sendMail(mail);$modalInstance.dismiss('cancel');};$scope.editMail=function(mail,createMail){editEmail(mail,createMail);$modalInstance.dismiss('cancel');};$scope.deleteMail=function(mail){deleteEmail(mail);$modalInstance.dismiss('cancel');}};$scope.send=sendMail;function sendMail(mail){var modalInstance=$modal.open({templateUrl:'/partials/emails/send.html',controller:ctrlSend,resolve:{mailInfo:function(){return mail;}}});modalInstance.result.then(function(){},function(){});}
var ctrlSend=function($scope,Page,$modalInstance,mailInfo){$scope.mailInfo=mailInfo;$scope.mailInfo.condition={};$scope.supportSend=[{name:'Tất cả',keyword:''},{name:'Purchased',keyword:'purchased'}];$scope.isLoading=false;var getQueryList=function(){$http.post('/search-query/get',{skip:0,limit:1000,type:"user"}).success(function(result){if(result.s)$scope.queryList=result.d;else alert("Get query list failed");}).error(function(){alert("Error From Server");})};getQueryList();var sendMail=function(email,list,query){$scope.isLoading=true;$http.post('/emails/send',{email:email,toList:list,query:query}).success(function(data){$scope.isLoading=false;$modalInstance.close();});};var readFile=function(callback){var file=document.getElementById("mailList").files[0];var mailListFromFile=[];var reader=new FileReader();reader.onload=function(e){var text=reader.result.toString();var a=text.split('\n');mailListFromFile=a;callback(mailListFromFile);};reader.readAsText(file,"utf-8");};$scope.send=function(mail,toList,mode,query){var ok=prompt('Type "moneylover" để xác nhận');if(ok!=='moneylover'){return;}
if(mode=='manual'){if(mail&&toList){var newToList=toList.split(",");newToList.forEach(function(elm,index){newToList[index]=elm.trim();});sendMail(mail,newToList,false);}}else if(mode=='file'){if(!mail)return;readFile(function(emailList){sendMail(mail,emailList,false);});}else if(mode=='search_query'){if(mail&&query){sendMail(mail,false,query);}}};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.deleteMail=deleteEmail;function deleteEmail(mail){var s=confirm(initQuest);if(s){$http.post('/emails/delete',{mail:mail}).success(function(data){if(data.err)alert(data.msg);else mail.isDelete=true;});}}
$scope.writeMail=function(){$scope.createMail=1;$scope.addNewMail=true;$scope.emailInfo={};$scope.titleFormMail='Write mail';};$scope.editMail=editEmail;function editEmail(mail){$scope.createMail=1;$scope.addNewMail=false;$scope.emailInfo=mail;$scope.titleFormMail='Edit mail';}
$scope.submitMail=function(emailInfo){if(emailInfo.subject&&emailInfo.content&&emailInfo.name&&emailInfo.from_email&&emailInfo.from_name){$http.post('/emails/submit',{mail:emailInfo,type:$scope.addNewMail}).success(function(data){if(data.err)alert(data.msg);else $scope.getList();});}else alert('Hãy nhập đầy đủ thông tin.');};})}(angular));(function($a){'use strict';$a.module('ML').controller('events',function($scope,$rootScope,$http,$modal,$routeParams,localStorageService,$location){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Events';$scope.listEvent=[];$scope.predicate='createAt';$scope.reverse=true;$scope.sortBy=function(field){if($scope.predicate==field)$scope.reverse=!$scope.reverse;else{$scope.predicate=field;$scope.reverse=true;}};var lang=[{name:'English (EN-US)',key:'en'},{name:'French (FR)',key:'fr'},{name:'Spanish (ES)',key:'es'},{name:'Japan (JP)',key:'ja'},{name:'Italian (IT)',key:'it'},{name:'Portuguese (PT)',key:'pt'},{name:'German (DE)',key:'de'},{name:'Tiếng Việt (VI)',key:'vi'}];$scope.listLanguage=lang;function update(eventInfo,status,callback){$http.post('/events/update',{event:eventInfo,type:status}).success(function(data,err){callback(data);}).error(function(data,err){alert('Error');});}
$scope.getList=function(){$http.post('/events/list').success(function(data,err){if(data.error)alert('Error');else $scope.listEvent=data.data;}).error(function(data,err){alert('Error');});};$scope.delete=function(event){var s=confirm('Bạn thực sự chắc chắn với hành động này?');if(s){$http.post('/events/delete',{event:event}).success(function(data,err){$scope.listEvent.forEach(function(eventItem,index){if(eventItem._id==event._id)$scope.listEvent.splice(index,1);});}).error(function(data,err){alert('Error');});}};$scope.addLang=function(eventInfo){var modalInstance=$modal.open({templateUrl:'/partials/events/lang.html',controller:ctrlAddLang,resolve:{eventInfo:function(){return eventInfo;},lang:function(){return lang;}}});modalInstance.result.then(function(){},function(){});};var ctrlAddLang=function($scope,Page,$modalInstance,eventInfo,lang){$scope.listLanguage=lang;$scope.listLangActive=[];$scope.dataLangs=eventInfo.addLang||[];$scope.langContent={};$scope.isViewLang=false;$scope.dataLangs.forEach(function(dataLang){if(dataLang.lang)$scope.listLangActive.push(dataLang.lang);});$scope.generateLang=function(){$http.post('/events/updatelang',{event:eventInfo._id,language:$scope.dataLangs}).success(function(data,err){eventInfo.addLang=$scope.dataLangs;alert('Generate thành công!');}).error(function(data,err){alert('Error');});};function changeDataLangs(langContent,status){var id=-1;if(status){if($scope.dataLangs.length>0){$scope.dataLangs.forEach(function(dataLang,index){if(dataLang.lang===langContent.lang)id=index;});}
$scope.dataLangs.push(langContent);if(id>-1)$scope.dataLangs.splice(id,1);}else{$scope.dataLangs.forEach(function(dataLang,index){if(dataLang.lang===langContent.lang)id=index;});if(id>-1)$scope.dataLangs.splice(id,1);}}
$scope.toggleSelection=function(lang){var idx=$scope.listLangActive.indexOf(lang.key);if(idx>-1){var s=true;if(s){$scope.listLangActive.splice(idx,1);if(lang.name==$scope.viewLanguage)$scope.isViewLang=false;changeDataLangs({lang:lang.key},false);}}else{$scope.viewLang(lang);$scope.listLangActive.push(lang.key);}};$scope.viewLang=function(language){$scope.langContent={};if(language.name==$scope.viewLanguage)$scope.isViewLang=!$scope.isViewLang;else $scope.isViewLang=true;$scope.viewLanguage=language.name;$scope.langContent.lang=language.key;$scope.dataLangs.forEach(function(langContent){if(langContent.lang===language.key)$scope.langContent=langContent;});};$scope.save=function(langContent){if(langContent.lang&&langContent.title&&langContent.description&&langContent.link_icon&&langContent.link){changeDataLangs(langContent,true);}else alert('Hãy nhập đầy đủ thông tin.');};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.genCodeModal=function(event){var modalInstance=$modal.open({templateUrl:'/partials/events/gencode.html',controller:ctrlGenCode,resolve:{event:function(){return event;},codeInfo:function(){return{l:10,n:20}}}});modalInstance.result.then(function(){},function(){});};var ctrlGenCode=function($scope,$modalInstance,event,codeInfo){$scope.event=event;$scope.codeInfo=codeInfo;$scope.genCodeResult="";$scope.hasNoDash=false;$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.generate=function(){$scope.codeInfo.eventid=event._id;var postData={codeInfo:$scope.codeInfo,hasNoDash:this.hasNoDash};postData.codeInfo.product=event.product;$http.post('/events/gencode',postData).success(function(data,err){$scope.genCodeResult=data.codes;}).error(function(data,err){alert('Gencode error');});}};$scope.showCode=function(event){var modalInstance=$modal.open({templateUrl:'/partials/events/codelist.html',controller:ctrlCode,resolve:{event:function(){return event;}}});modalInstance.result.then(function(){},function(){});};var ctrlCode=function($scope,$modalInstance,event){$scope.event=event;$scope.codeList=[];$scope.unusedCodes=false;$scope.total=0;$scope.usedCodeAmount=0;var limit=20;var offset=0;$scope.pageNo=1;$scope.totalPage=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.cancel=function(){$modalInstance.dismiss('cancel');};function getCodeList(){var conditions={eventid:$scope.event._id,limit:limit,offset:offset};$http.post('/events/codelist',{conditions:conditions}).success(function(data,err){if(data.err){alert('Error');}else{$scope.codeList=data.data;}}).error(function(){alert("Lỗi trong khi get code list từ server");});}
getListCodeInfo();getCodeList();$scope.switchPage=function(status){if(status==='next'){$scope.pageNo++;offset+=limit;}else{$scope.pageNo--;offset-=limit;}
checkPage();getCodeList();};function getListCodeInfo(){$http.post('/events/getCodeListInfo',{eventid:$scope.event._id}).success(function(data,err){if(data.err){alert('Server: '+data.msg);}else{$scope.total=data.totalCode;$scope.usedCodeAmount=data.usedCodeAmount;if(($scope.total%limit)<(limit/2)&&($scope.total%limit)>0){$scope.totalPage=Math.round($scope.total/limit)+1;}else $scope.totalPage=Math.round($scope.total/limit);checkPage();}}).error(function(err,data){alert("Error");});}
function checkPage(){if($scope.pageNo==1)$scope.isFirstPage=true;else $scope.isFirstPage=false;if($scope.pageNo==$scope.totalPage)$scope.isLastPage=true;else $scope.isLastPage=false;}
$scope.exportCode=function(){var ename=$scope.event.name,eid=$scope.event._id,isAll=!$scope.unusedCodes;location.href='/events/codeexport?ename='+ename+'&eid='+eid+'&isAll='+isAll;};$scope.checkUnusedCodes=function(){if($scope.unusedCodes===false)$scope.unusedCodes=true;else $scope.unusedCodes=false;};$scope.changeCodeStt=function(code){if(code.status===false)code.status=true;else code.status=false;$http.post('/events/codeupdate',{code:code}).success(function(data,err){console.log(err);if(data.err){alert(data.msg);}else{}}).error(function(data,err){alert('Code updating failed');})}};$scope.addNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/events/info.html',controller:ctrlAdd,resolve:{eventInfo:function(){return{link:"https://moneylover.me",link_icon:"https://scontent-a-sjc.xx.fbcdn.net/hphotos-xfa1/v/t1.0-9/10152419_286769251478858_504375317_n.png?oh=ee1ea9ee2b5e83ba461acf654099c788&oe=545A7F4E",type:1};},listEvent:function(){return $scope.listEvent;},lang:function(){return lang;}}});modalInstance.result.then(function(){},function(){});};var ctrlAdd=function($scope,Page,$modalInstance,eventInfo,listEvent,lang){$scope.eventInfo=eventInfo;$scope.listEvent=listEvent;$scope.errorMsg=null;$scope.language=lang;$scope.eventInfo.isUnlimited=false;$scope.productType=['premium','subscription','credit','icon'];$scope.selectedProductType=$scope.productType[0];$scope.eventInfo.selectedProductType=$scope.productType.indexOf($scope.selectedProductType);$scope.productList={};getProduct($scope.selectedProductType);$scope.getProduct=function(){getProduct(this.selectedProductType);$scope.selectedProductType=this.selectedProductType;$scope.eventInfo.selectedProductType=$scope.productType.indexOf($scope.selectedProductType);};function getProduct(productType){var url;switch(productType){case $scope.productType[0]:url='/premium-products/list';break;case $scope.productType[1]:url='/subscription-products/gift';break;case $scope.productType[2]:url='/use-credits/list';break;case $scope.productType[3]:url='/icons/get';break;default:break;}
if(!url)return 0;if($scope.productList[productType])return 0;$http.post(url,{skip:0,limit:50}).success(function(result){if(!result.s){if(result.error===undefined)return alert("Can not get product list");if(result.error)return alert("Can not get product list");}
$scope.productList[productType]=result.d||result.data;}).error(function(){alert('Error from server');});}
$scope.save=function(){if(this.eventInfo.codeRemain){this.eventInfo.codeRemain=parseInt(eventInfo.codeRemain);if(isNaN(this.eventInfo.codeRemain))return alert('Amount must be number');if(this.eventInfo.codeRemain===0)return alert('Amount = 0? Are you kidding?');}
update(this.eventInfo,1,function(data){if(data.error)return $scope.errorMsg='Error';$scope.listEvent.push(data.data);$modalInstance.close();});};$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.dateOptions={'starting-day':1};$scope.datePicker1=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};$scope.datePicker2=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};};$scope.edit=function(eventInfo){var modalInstance=$modal.open({templateUrl:'/partials/events/info.html',controller:ctrlEdit,resolve:{eventInfo:function(){return eventInfo;},lang:function(){return lang;}}});modalInstance.result.then(function(lstCurrency){updateCurrency(lstCurrency);},function(){});};var ctrlEdit=function($scope,Page,$modalInstance,eventInfo,lang){var tmpEventInfo=eventInfo;$scope.eventInfo=eventInfo;$scope.language=lang;$scope.selectedLang=eventInfo.lang;function validateEventInfo(eventInfo,callback){if(eventInfo.codeRemain){var number=parseInt(eventInfo.codeRemain);if(isNaN(number))callback({s:false,e:'Amount must be number'});else{if(number==0)callback({s:false,e:'Amount = 0? Are you kidding?'});else callback({s:true});}}else callback({s:true});}
$scope.save=function(){validateEventInfo($scope.eventInfo,function(result){if(!result.s)alert(result.e);else{update($scope.eventInfo,0,function(data){if(data.error)$scope.errorMsg='Error';else $modalInstance.close();});}});};$scope.cancel=function(){$scope.eventInfo=tmpEventInfo;$modalInstance.dismiss('cancel');};$scope.dateOptions={'starting-day':1};$scope.datePicker1=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};$scope.datePicker2=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};};$scope.showRedeemInfo=function(e){var modalInstance=$modal.open({templateUrl:'/partials/events/redeem-info.html',controller:ctrlRedeem,resolve:{event:function(){return e;}}});modalInstance.result.then(function(){},function(){});};var ctrlRedeem=function($scope,$modalInstance,event){var limit=4,offset=0;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.pageNo=1;$scope.totalPage=1;$scope.eventInfo=event;$scope.redeemEmailList=[];$scope.totalEmail=0;$scope.registedEmail=0;getEmailList();getRedeemInfo();$scope.cancel=function(){$modalInstance.dismiss('cancel');};function getEmailList(){var conditions={eventid:$scope.eventInfo._id,limit:limit,offset:offset};$http.post('/redeem/getemaillist',{conditions:conditions}).success(function(data,err){if(!data.err){$scope.redeemEmailList=data.emailList;}else{alert(data.msg);}}).error(function(data,status){alert('Error');});}
function checkPage(){if($scope.pageNo==1){$scope.isFirstPage=true;}else{$scope.isFirstPage=false;}
if($scope.pageNo<$scope.totalPage){$scope.isLastPage=false;}else{$scope.isLastPage=true;}}
function getRedeemInfo(){$http.post('/redeem/getredeeminfo',{eventid:$scope.eventInfo._id}).success(function(data,err){if(data.err){alert('Server: '+data.msg);}else{$scope.totalEmail=data.totalEmail;$scope.registedEmail=data.registedEmail;if(($scope.totalEmail%limit)<(limit/2)&&($scope.totalEmail%limit)>0){$scope.totalPage=Math.round($scope.totalEmail/limit)+1;}else{$scope.totalPage=Math.round($scope.totalEmail/limit);}
checkPage();}}).error(function(data,errr){alert("Counting Error");});}
$scope.switchPage=function(status){if(status==="next"){$scope.pageNo++;offset+=limit;getEmailList();}else{$scope.pageNo--;offset-=limit;getEmailList();}
checkPage();};$scope.exportEmailList=function(){var eventid=$scope.eventInfo._id;var eventname=$scope.eventInfo.name;location.href='/redeem/emaillistexport?eventid='+eventid+'&eventname='+eventname;}}})}(angular));(function($a){"use strict";$a.module('ML').controller('exception',function($scope,$rootScope,$http,$modal){$rootScope.MLPageDetail="Sync Exception";$rootScope.tabSelect=1;$scope.isLoading=false;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;var LIMIT=20;$scope.platform=0;var platforms={'Android':1,'Ios':2,'Windows':3,'Winphone':3,'Osx':6,'Web':7};$scope.exceptionList=[];$scope.nextPage=function(value){$scope.page+=value;$scope.filter($scope.platform);};$scope.detail=function(listIndex){$modal.open({templateUrl:'/partials/exception/detail.html',controller:ctrlExceptionDetail,resolve:{exception:function(){return $scope.exceptionList[listIndex];}}});};function ctrlExceptionDetail($scope,$modalInstance,exception){$scope.detail=exception;$scope.close=function(){$modalInstance.dismiss('cancel');}}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.exceptionList.length<LIMIT;}
function getList(){getListAPI(function(err,data){if(err){return alert(err);}
$scope.exceptionList=data;checkPage();});}
function getListAPI(callback){var skip=LIMIT*($scope.page-1);$scope.isLoading=true;$http.post('/exception/list',{skip:skip,limit:LIMIT}).success(function(result){$scope.isLoading=false;if(!result.status){return callback('Get exception list failed');}
callback(null,result.data);}).error(function(){$scope.isLoading=false;callback('Error from server');});}
$scope.searchKey=function(event,keyWord){if(event.keyCode==13){var skip=LIMIT*($scope.page-1);$scope.isLoading=true;var email=keyWord;$http.post('/api/exception/search',{email:email,skip:skip}).success(function(result){$scope.isLoading=false;$scope.exceptionList=result.data;}).error(function(){alert('Error from server');});}};$scope.search=function(keyWord){var skip=LIMIT*($scope.page-1);$scope.isLoading=true;var email=keyWord;$http.post('/api/exception/search',{email:email,skip:skip}).success(function(result){$scope.isLoading=false;$scope.exceptionList=result.data;}).error(function(){alert('Error from server');});};$scope.filter=function(platform){$scope.platform=platform;if(platform!=0){var skip=LIMIT*($scope.page-1);$scope.isLoading=true;$http.post('/api/exception/filter',{platform:$scope.platform,skip:skip}).success(function(result){$scope.isLoading=false;$scope.exceptionList=result.data;}).error(function(){alert('Error from server');});}else{getList();}}
function init(){getList();}
init();});}(angular));(function($a){'use strict';$a.module('ML').controller('find',function($scope,$rootScope,$http){$rootScope.MLPageDetail='Find Category, Transaction, Wallet by ID';$scope.result={};})}(angular));(function($a){$a.module('ML').controller('Gift',function($scope,$rootScope,$http){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Gift';$scope.send=function(){if(!this.gift.reason){return alert('Please type your reason');}
readFile(function(err,emailList){if(err)return alert(err);$scope.gift.listEmail=emailList;switch($scope.productType){case"1":sendIconGift($scope.gift);break;case"2":sendSubscriptionGift($scope.gift,'premium');break;case"4":sendSubscriptionGift($scope.gift,'linked_wallet');break;case"3":sendCreditGift($scope.gift);break;case"5":sendPremiumGift($scope.gift);break;default:break;}});};function sendSubscriptionGift(gift,type){if(!gift.subscription){alert('Please select subscription package');}
var productInfo=$scope.subscriptionList[gift.subscription];var postData={listEmail:gift.listEmail,productId:productInfo.product_id,unit:productInfo.expire_unit,value:productInfo.expire_value,type:type};$http.post('/user/send-subscription',postData).success(function(result){if(!result.s){return alert('Send subscription gift due to failed');}
alert('Send gift to list of user is processing');init();}).error(function(){alert('Error from server');});}
function sendCreditGift(gift){if(!gift.credit){return alert('Please select credit product');}
gift.credit=JSON.parse(gift.credit);var postData={listEmail:gift.listEmail,reason:gift.reason,product_id:gift.credit.product_id};$http.post('/user/send-credit',postData).success(function(result){if(!result.s){return alert('Send credit gift due to failed');}
alert('Send gift to list of user is processing')
init();}).error(function(){alert('Error From Server');});}
function sendIconGift(gift){if(!gift.icon){return alert('Please select an icon');}
var giftInfo={listEmail:gift.listEmail,reason:gift.reason,iconName:$scope.iconList[gift.icon].name,iconId:$scope.iconList[gift.icon].product_id,iconLink:$scope.iconList[gift.icon].link};$http.post('/user/send-icon-gift',{giftInfo:giftInfo}).success(function(data){if(!data.s){return alert('Send icon gift due to failed');}
alert('Send gift to list of user is processing');init();}).error(function(){alert('Error while send icon gift');});}
function sendPremiumGift(gift){if(!gift.premium){return alert('Please select an item');}
gift.premium=JSON.parse(gift.premium);var postData={listEmail:gift.listEmail,product_id:gift.premium.product_id,reason:gift.reason};$http.post('/user/active-premium',postData).success(function(result){if(!result.s){return alert('Send premium gift due to failed');}
alert('Send gift to list of user is processing')
init();}).error(function(){alert('Error From Server');});}
function getIconList(){if($scope.iconList.length>0){return true;}
$http.post('/icons/get',{}).success(function(data){if(!data.error){$scope.iconList=data.data;}}).error(function(data){alert("Error while get icon list");});}
function getCreditList(){if($scope.creditList.length>0){return true;}
$http.post('/use-credits/list',{}).success(function(result){if(result.s){$scope.creditList=result.d;}else{alert('Get credit list due to failed');}}).error(function(){alert('Error From Server');});}
function getPremiumList(){if($scope.premiumList.length>0){return true;}
$http.post('/premium-products/list',{}).success(function(result){if(!result.s){return alert('Get premium product due to failed');}
$scope.premiumList=result.d;}).error(function(){alert('Error From Server');});}
function getSubscriptionList(){if($scope.subscriptionList.length>0){return true;}
$http.post('/subscription-products/gift',{}).success(function(result){if(!result.s){return alert('Get subscription product due to failed');}
$scope.subscriptionList=result.d;}).error(function(){alert('Error from server');});}
function readFile(callback){var file=document.getElementById("txtFile").files[0];if(!file)return callback('Please select email file');var mailListFromFile=[];var reader=new FileReader();reader.onload=function(e){var text=reader.result.toString();var a=text.split('\n');mailListFromFile=checkNullEmail(a);callback(null,mailListFromFile);};reader.readAsText(file,"utf-8");function checkNullEmail(list){var new_list=[];list.forEach(function(email){if(email!=""){new_list.push(email);}});return new_list;}}
$scope.productTypeSelected=function(){var type=this.productType;switch(type){case'1':getIconList();break;case'2':getSubscriptionList();break;case'3':getCreditList();break;case'4':getSubscriptionList();break;case'5':getPremiumList();break;default:break;}};function init(){$scope.productType="1";$scope.creditList=[];$scope.premiumList=[];$scope.subscriptionList=[];$scope.iconList=[];$scope.gift={};getIconList();}
init();});}(angular));(function($a,document){'use strict';$a.module('ML').controller('global',function($scope,$http,$modal,notificationService,$rootScope){$scope.new_noti=notificationService.getNotification();$scope.openIssues=0;$scope.totalIssues=0;$scope.spotlightOpened=false;$scope.setting={};$scope.$watch(function(){return notificationService.getNotification();},function(newValue,oldValue){$scope.new_noti=newValue;});setInterval(function(){checkMaintainStatus();},60000);function checkMaintainStatus(){$http.get('/server-setting/get').success(function(result){if(result.s){$scope.setting=result.data;if($scope.setting.isServerMaintain==='true'){document.getElementById("footerMaintainStatus").removeAttribute('hidden');}else{document.getElementById("footerMaintainStatus").setAttribute('hidden','true');}}}).error(function(){});}
checkMaintainStatus();$scope.logout=function(){$http.post('/logout').success(function(data){if(data.error===0)window.location='/login';else alert("Logout Failed");}).error(function(){alert("Error From Server");});};$scope.changePassword=function(adminId){var modalInstance=$modal.open({templateUrl:'/partials/global/change_password.html',controller:ctrlChangePassword,resolve:{}})};var ctrlChangePassword=function($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.closeAlert=function(mode){if(mode==='success'){$scope.isSuccess=false;}else if(mode==='warning'){$scope.isWarning=false;}else{$scope.isError=false;}};function checkSubmitData(data){if(!data||!data.current||!data.newPassword||!data.retype){$scope.isWarning=true;$scope.warningMessage='Please complete all the fields!';return false;}else if(data.newPassword.length<6||data.retype.length<6){$scope.isWarning=true;$scope.warningMessage='New Password must be at least 6 characters!';return false;}else if(data.retype!==data.newPassword){$scope.isWarning=true;$scope.warningMessage='Retype New Password and New Password must match!';return false;}else{return true;}}
$scope.submit=function(data){var ok=checkSubmitData(data);if(ok){$http.post('/admin/change-password',{passwords:data}).success(function(data){if(!data.s){if(data.msg==='wrong_password'){$scope.isWarning=true;$scope.warningMessage='Wrong Password!';}else if(data.msg==='admin_not_exist'){$scope.isWarning=true;$scope.warningMessage='Admin Not Found!';}else if(data.msg==='change_password_failed'){$scope.isError=true;}}else{$scope.isSuccess=true;}}).error(function(){alert('Error From Server');})}}};$scope.openNotification=function(){var noti=document.getElementById("noticenter");noti.className+=" open";};var sidebarOpened=false;$scope.showSidebar=function(){var sidebar=document.getElementById("sidebar-wrapper");var burger=document.getElementById("show-menu");var defaultBurger="btn btn-primary";if(!sidebarOpened){sidebar.className="open";burger.className+=" sidebar-opened";sidebarOpened=true;}else{sidebar.className="";burger.className=defaultBurger;sidebarOpened=false;}};function countIssue(){$http.post('/helpdesk/issue/count',{}).success(function(result){if(result.s){$scope.openIssues=result.d.open;$scope.totalIssues=result.d.total;}else alert("Issue Counting Fails");}).error(function(){alert("Error From Server");});}
function countReceipt(){$http.post('/receipt/count',{}).success(function(result){if(result.s){$scope.openReceipts=result.d.openReceipts;}else alert("Issue Counting Fails");}).error(function(){alert("Error From Server");});}
countIssue();countReceipt();$scope.userSpotlight=function(){if(!$scope.spotlightOpened){var modalInstance=$modal.open({templateUrl:'user_spotlight.html',controller:ctrlUserSpotlight});modalInstance.opened.then(function(){$scope.spotlightOpened=true;});modalInstance.result.then(function(){},function(){$scope.spotlightOpened=false;});}};var ctrlUserSpotlight=function($scope,$modalInstance){$scope.hasResult=false;$scope.results=[];$scope.isLoading=false;var myTimeout;function validateEmail(email){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return re.test(email);}
$scope.detectSocial=function(userTags){if(!userTags)return null;if(userTags.indexOf('facebook')!=-1)return'facebook';if(userTags.indexOf('google')!=-1)return'google';};function doSearch(kw){myTimeout=setTimeout(function(){$scope.isLoading=true;$http.post('/user/search',{limit:100,skip:0,condition:{email:kw},mode:1}).success(function(result){if(result.error)alert("Searching failed");else{result.data.forEach(function(user){getDevice(user);getCountry(user);});$scope.results=result.data;$scope.hasResult=true;$scope.isLoading=false;}}).error(function(){$scope.isLoading=false;alert('Error From Server');});},1000);}
function stopTimeout(){clearTimeout(myTimeout);}
var getDevice=function(user){$http.get('/info/device/'+user._id).success(function(data){if(data&&data!==false&&data!=='false'){data.forEach(function(device){if(device.platform===1){if(!user.hasAndroid){user.hasAndroid=true;}}else if(device.platform===2){if(!user.hasIos){user.hasIos=true;}}else if(device.appId===5){if(!user.hasWindows){user.hasWindows=true;}}else if(device.appId===4){if(!user.hasWp){user.hasWp=true;}}else if(device.platform===6){if(!user.hasOsx){user.hasOsx=true;}}else if(device.platform===7){if(!user.hasWeb){user.hasWeb=true;}}});}}).error(function(){alert("Error from server");});};var getCountry=function(user){};function editUser(userInfo,callback){$http.post('/user/edit',userInfo).success(function(data){callback(data);}).error(function(data){callback(data);});}
$scope.setPurchased=function(userInfo){var purchased=userInfo.purchased?false:true;var s=confirm('Bạn thực sự muốn thực hiện thay đổi này?');if(s){userInfo.purchased=purchased;editUser(userInfo,function(data){if(!data.err){var action="";if(purchased){action="free -> premium";}else{action="premium -> free";}
$http.post('/premiumlog/savelog',{email:userInfo.email,action:action}).success(function(data){if(!data.s){alert('Set premium failed');}}).error(function(){alert("Error while save admin action");})}});}};$scope.listenKeyPress=function(kw){if(kw&&validateEmail(kw)){stopTimeout();doSearch(kw);}};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};})}(angular,document));(function($a){'use strict';$a.module('ML').controller('groupCreateModal',function($scope,$rootScope,$modal,$modalInstance,$routeParams,$http){$scope.$on('$viewContentLoaded',function(){$scope.groupFeild={}});$scope.create=function(group){var url='/api/group/create';var param={name:group.name,countries:group.countries,devices:group.devices}
$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){$modalInstance.close(response.data.data);}else{if(response.data.message=='exists'){alert('group name exists!');}else{alert('Save campaign-marketing error');}}}},function errorCallback(response){alert(response.status);});$scope.cancel=function(){$modalInstance.dismiss('cancel');}}})}(angular));(function($a){'use strict';$a.module('ML').controller('groupMarketingCtrl',function($scope,$rootScope,$modal,$routeParams,$http){$scope.groups=[];$scope.page=1;$scope.noContent;var limit=20;$scope.$on('$viewContentLoaded',function(){console.log('groupMarketingCtrl');loadContent($scope.page);});function loadContent(page){var url='/api/group/browse';var skip=limit*(page-1);var param={skip:skip,limit:limit,page:page};$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.groups=response.data.data;if($scope.groups.length<1){$scope.noContent=true;}else{$scope.noContent=false;}
excutePage(response.data);}else{alert('Get list group error');}}},function errorCallback(response){alert(response.status);});}
$scope.nextPage=function(num){$scope.page+=num;loadContent($scope.page);};function excutePage(scope){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.groups.length<limit;};$scope.changeDisabled=function(group){alert('Chưa có, coming soon !');}})}(angular));(function($a){'use strict';$a.module('ML').controller('helpdeskFaq',function($scope,$rootScope,$routeParams,$http,$modal){$rootScope.tabSelect=5;$rootScope.MLPageDetail='Faq Management';$scope.languages=[{_id:'all',name:'All'},{_id:'vi',name:'Vietnamese'},{_id:'en',name:'English'}];$scope.platforms=[{_id:'all',name:'All'},{_id:'android',name:'Android'},{_id:'ios',name:'iOS'},{_id:'wp',name:'Windows Phone'},{_id:'win',name:'Windows'},{_id:'mac',name:'Mac OS X'},{_id:'web',name:'Web'}];$scope.option={};$scope.faqs=[];$scope.isLoading=true;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=false;var limit=50;var checkPage=function(){if($scope.page===1)$scope.isFirstPage=true;else $scope.isFirstPage=false;if($scope.faqs.length<50){$scope.isLastPage=true;}
else $scope.isLastPage=false;};var getSection=function(callback){$http.post('/helpdesk/section/get',{}).success(function(data){if(data.s){$scope.sections=data.d;$scope.sections.unshift({_id:"all",name:"All"});callback(true);}else{callback(false);alert("Get Section Failed");}}).error(function(){callback(false);alert("Error From Server");})};getSection(function(status){if(status)$scope.selectedSection=$scope.sections[0];});$scope.selectedLanguage=$scope.languages[0];$scope.selectedPlatform=$scope.platforms[0];$scope.faqs=[];$scope.selectLanguage=function(index){$scope.selectedLanguage=$scope.languages[index];};$scope.selectPlatform=function(index){$scope.selectedPlatform=$scope.platforms[index];};$scope.selectSection=function(index){$scope.selectedSection=$scope.sections[index];};$scope.$watch('selectedLanguage',function(newvalue,oldvalue){if(oldvalue&&newvalue!==oldvalue){$scope.page=1;getFaq();}});$scope.$watch('selectedPlatform',function(newvalue,oldvalue){if(oldvalue&&newvalue!==oldvalue){$scope.page=1;getFaq();}});$scope.$watch('selectedSection',function(newvalue,oldvalue){if(oldvalue&&newvalue!==oldvalue){$scope.page=1;getFaq();}});var getFaq=function(){var query=$scope.option;query.limit=limit;query.skip=limit*($scope.page-1);if($scope.selectedSection&&$scope.selectedSection._id!=='all')query.section=$scope.selectedSection._id;else query.section=null;if($scope.selectedLanguage._id!=='all')query.language=$scope.selectedLanguage._id;else query.language=null;if($scope.selectedPlatform._id!=='all')query.platform=$scope.selectedPlatform._id;else query.platform=null;$scope.isLoading=true;$http.post('/helpdesk/faq/get',query).success(function(data){$scope.isLoading=false;if(data.s){$scope.faqs=data.d;checkPage();}
else alert("Get Faq Failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");});};getFaq();$scope.getFaq=getFaq;$scope.changeGlobal=function(index,status){$scope.faqs[index].global=status;$http.post('/helpdesk/faq/edit',$scope.faqs[index]).success(function(data){}).error(function(){alert("Can't change global status!");});};$scope.changePublish=function(index,status){$scope.faqs[index].published=status;$http.post('/helpdesk/faq/edit',$scope.faqs[index]).success(function(data){}).error(function(){alert("Can't change publish status!");});};$scope.delete=function(index,faq){var s=confirm("Are you sure?");if(s){$http.post('/helpdesk/faq/delete',{faqId:faq._id}).success(function(data){if(data.s){$scope.faqs.splice(index,1);}else alert("Can't delete this item :(");}).error(function(){alert("Error From Server");});}};$scope.nextPage=function(value){$scope.page+=value;checkPage();getFaq();};});}(angular));(function($a){'use strict';$a.module('ML').controller('helpdeskFaqDetail',function($scope,$http,$routeParams,$rootScope){$rootScope.tabSelect=5;$rootScope.MLPageDetail='FaQ Details';$scope.isLoading=true;$scope.isWarning=false;$scope.isError=false;$scope.isSuccess=false;$scope.links=[];var mode="create";$scope.languages=[{_id:'vi',name:'Vietnamese'},{_id:'en',name:'English'}];$scope.platforms=[{_id:'android',name:'Android'},{_id:'ios',name:'iOS'},{_id:'wp',name:'Windows Phone'},{_id:'win',name:'Windows'},{_id:'mac',name:'Mac OS X'},{_id:'web',name:'Web'}];$scope.allPlatformChecked=false;$scope.checkAllPlatform=function(){$scope.allPlatformChecked=!$scope.allPlatformChecked;if($scope.allPlatformChecked){$scope.item.platform=['android','ios','wp','win','mac','web'];}else{$scope.item.platform=[];}};var getMultiFaq=function(list){$scope.isLoading=true;$http.post('/helpdesk/faq/get-multi',{listId:list}).success(function(data){$scope.isLoading=false;$scope.links=data;}).error(function(){$scope.isLoading=false;alert("Error From Server");});};var bindData=function(){if($routeParams.faq_id){mode="edit";$scope.isLoading=true;$http.post('/helpdesk/faq/get-one',{faqId:$routeParams.faq_id}).success(function(data){$scope.isLoading=false;if(data.s){$scope.item=data.d;if($scope.item.platform&&$scope.item.platform.length===6)$scope.allPlatformChecked=true;if($scope.item.links&&$scope.item.links.length>0){getMultiFaq($scope.item.links);}}
else alert("Get Item Failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");})}else mode="create";};bindData();var getSection=function(){$scope.isLoading=true;$http.post('/helpdesk/section/get',{}).success(function(data){$scope.isLoading=false;if(data.s){$scope.sections=data.d;}else alert("Get Section Failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");})};getSection();$scope.platformChanged=function(platform_id){if($scope.item.platform){if(platform_id==='all'){$scope.item.platform=[platform_id];}else{var exist=$scope.item.platform.indexOf(platform_id);if(exist===-1)$scope.item.platform.push(platform_id);else $scope.item.platform.splice(exist,1);}}else{$scope.item.platform=[platform_id];}};$scope.submitForm=function(){if(!$scope.item.language||!$scope.item.section||!$scope.item.platform||$scope.item.platform.length===0){$scope.isWarning=true;}else{var url='';if(mode==="create")url='/helpdesk/faq/add';else url='/helpdesk/faq/edit';var btnSubmit=document.getElementById('btnSubmit');btnSubmit.value="I doing... :v";btnSubmit.setAttribute('disabled','true');$http.post(url,$scope.item).success(function(data){btnSubmit.value="Submit";btnSubmit.removeAttribute('disabled');if(data.s){$scope.isSuccess=true;}else $scope.isError=true;}).error(function(){btnSubmit.value="Submit";btnSubmit.removeAttribute('disabled');$scope.isError=true;});}};$scope.addLink=function($item,$model,$label){if($scope.links.indexOf($item)===-1){$scope.links.push($item);if(!$scope.item.links){$scope.item.links=[];}
$scope.item.links.push($item._id);if(!$scope.item.otherLanguage)$scope.item.otherLanguage=[];$scope.item.otherLanguage.push($item.language);}};$scope.removeLink=function(index){$scope.links.splice(index,1);$scope.item.links.splice(index,1);$scope.item.otherLanguage.splice(index,1);};$scope.filterFaq=function(term){var postData={term:term,sectionId:$scope.item.section,linkedList:$scope.item.links||[],otherLanguage:$scope.item.otherLanguage||[]};if($scope.item.section._id)postData.sectionId=$scope.item.section._id;else postData.sectionId=$scope.item.section;return $http.post('/helpdesk/faq/filter',postData).then(function(response){return response.data;});};});}(angular));(function($a,$async){'use strict';$a.module('ML').controller('helpDeskFaqSection',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=5;$rootScope.MLPageDetail='Section Management';$scope.sections=[];$scope.isLoading=true;var getSection=function(){$scope.isLoading=true;$http.post('/helpdesk/section/get',{}).success(function(data){$scope.isLoading=false;if(data.s){$scope.sections=data.d;}else{alert("Get Section Failed");}}).error(function(){$scope.isLoading=false;alert("Error from Server");})};var deleteSection=function(id){var s=confirm("Are you sure?");if(s){$http.post('/helpdesk/section/delete',{sectionId:id}).success(function(data){if(data.s){getSection();}else{alert("Delete section failed");}}).error(function(){alert("Error From Server");})}};var updateSection=function(mode,index,info){var modalInstance=$modal.open({templateUrl:'/partials/helpdesk/section/info.html',controller:ctrlUpdate,resolve:{mode:function(){return mode;},info:function(){return info;},sortIndex:function(){if(mode==='Add')return $scope.sections.length+1;else return index+1;}}});modalInstance.result.then(function(){});};function saveSection(url,data,callback){$http.post(url,data).success(function(response){if(response.s)callback(null);else callback("Save section failed");}).error(function(){callback("Error From Server");})}
var ctrlUpdate=function($scope,$modalInstance,mode,info,sortIndex){$scope.mode=mode;if(info){$scope.section=info;}
$scope.saveSection=function(section){if(section){var url,errorMsg;if(mode==='Add'){url='/helpdesk/section/add';section.sortIndex=sortIndex;}else{url='/helpdesk/section/edit';if(!section.sortIndex||(section.sortIndex&&section.sortIndex!==sortIndex))
section.sortIndex=sortIndex;}
saveSection(url,section,function(err){if(err)$scope.errorMsg=err;else{getSection();$scope.cancel();}});console.log(section);}};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.sortSection=function(mode,key){var temp;var url='/helpdesk/section/edit';if(mode==='up'){if(key!==0){temp=$scope.sections[key];$scope.sections[key]=$scope.sections[key-1];$scope.sections[key-1]=temp;$async.parallel([function(callback){$scope.sections[key].sortIndex=key+1;saveSection(url,$scope.sections[key],callback);},function(callback){$scope.sections[key-1].sortIndex=key;saveSection(url,$scope.sections[key-1],callback);}],function(err){})}}else{if(key!==$scope.sections.length-1){temp=$scope.sections[key];$scope.sections[key]=$scope.sections[key+1];$scope.sections[key+1]=temp;$async.parallel([function(callback){$scope.sections[key].sortIndex=key+1;saveSection(url,$scope.sections[key],callback);},function(callback){$scope.sections[key+1].sortIndex=key+2;saveSection(url,$scope.sections[key+1],callback);}],function(err){})}}};$scope.getSection=function(){getSection();};$scope.newSection=function(){updateSection('Add');};$scope.editSection=function(index){updateSection('Edit',index,$scope.sections[index]);};$scope.deleteSection=function(id){deleteSection(id);};});}(angular,async));(function($a){'use strict';$a.module('ML').controller('helpdeskIssue',function($scope,$rootScope,$modal,$http,$routeParams,$route,$location,localStorageService){$rootScope.tabSelect=5;$rootScope.MLPageDetail='Issue Management';$scope.isLoading=false;$scope.issues=[];$scope.noResult=true;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.issuesOpenedFromUser=0;$scope.issuesOpendFromAdmin=0;var limit=50;var emailRegex=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;var helpdeskSettingKey='helpdeskIssueSettings';$scope.statused=[{label:'All',value:'all',is_mine:false},{label:'New',value:'new',is_mine:false},{label:'Open',value:'open',is_mine:false},{label:'Closed',value:'closed',is_mine:false},{label:'My issues',value:'all',is_mine:true},{label:'My open issues',value:'open',is_mine:true},{label:'My closed issue',value:'closed',is_mine:true}];$scope.platforms=[{label:'All',value:'All'},{label:'Android',value:'Android'},{label:'iOS',value:'iOS'},{label:'Mac',value:'Mac'},{label:'Windows',value:'Windows'},{label:'Windows Phone',value:'Windows Phone'},{label:'Web',value:'Web'},];$scope.sorts=[{label:'oldest',value:'oldest'},{label:'newest',value:'newest'}];$scope.senders=['user','admin'];var defaultFilters={status:'open',mine:false,platform:'all',sort:'newest',sender:'user',purchased:true,limit:limit};$scope.filters=defaultFilters;function getDataRequest(filters,skip,callback){filters.skip=skip;$http.post('/helpdesk/issue/get-all-2',filters).success(function(result){if(result.s){callback(null,result.d,result.u,result.a);}else{callback('Get issues due to failed');}}).error(function(){callback('Error From Server');});}
function getData(){var skip=limit*($scope.page-1);$scope.isLoading=true;getDataRequest($scope.filters,skip,function(err,data,openedByUser,openedAdmin){$scope.isLoading=false;if(err){return alert(err);}
$scope.issues=data;$scope.issuesOpenedFromUser=openedByUser;$scope.issuesOpendFromAdmin=openedAdmin;checkPage();});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.issues.length<limit;}
function validateEmail(email){return emailRegex.test(email);}
function directMessageToUserList(listEmail,message,title,schedule){var pushData={};pushData.listUserEmail=listEmail;pushData.message=message;pushData.name=title;if(schedule){pushData.schedule=schedule;}
$http.post('/helpdesk/issue/add',{pushData:pushData}).success(function(data){}).error(function(){alert("Can not send message");});}
function directMessageToUser(email,message,title){var pushData={};pushData.listUserEmail=[email];pushData.message=message;pushData.name=title;$http.post('/helpdesk/issue/add',{pushData:pushData}).success(function(data){}).error(function(){alert("Can not send message");});}
function getSetting(){var filters=localStorageService.get(helpdeskSettingKey);if(!filters||filters==={}){$scope.filters=defaultFilters;}else{$scope.filters=filters;}}
function saveSetting(){localStorageService.set(helpdeskSettingKey,JSON.stringify($scope.filters));}
$scope.selectStatus=function(status,mine){$scope.filters.status=status;$scope.filters.mine=mine;$scope.page=1;saveSetting();getData();};$scope.changeUserType=function(status){$scope.filters.purchased=status;$scope.page=1;saveSetting();getData();};$scope.changePlatform=function(platform){$scope.filters.platform=platform;$scope.page=1;saveSetting();getData();};$scope.changeSort=function(status){$scope.filters.sort=status;$scope.page=1;saveSetting();getData();};$scope.selectTab=function(person){$scope.filters.sender=person;$scope.page=1;saveSetting();getData();};$scope.nextPage=function(value){$scope.page+=value;getData();};$scope.displayAssigned=function(list){if(list){if(list.length&&list.length>0){var adminName=[];list.forEach(function(element){adminName.push(" "+element.username);});return adminName.toString();}else{return list.username;}}};$scope.sendMessage=function(){var modalInstance=$modal.open({templateUrl:'/partials/helpdesk/issue/sendMessage.html',controller:sendMessageController});};var sendMessageController=function($modalInstance,$scope){$scope.helpdeskIssuePage=true;$scope.inputUserType='manual';$scope.isScheduled=false;$scope.cancel=function(message,title,listUserEmail){if(message||title||listUserEmail){var cfmdialog=confirm('Do you really want to cancel?');if(cfmdialog){$modalInstance.dismiss('cancel');}else{return false;}}else{$modalInstance.dismiss('cancel');}};$scope.send=function(){var message=this.message;var title=this.title;var isScheduled=this.isScheduled;var schedule=this.schedule;var scheduleTime;if(isScheduled){if(!schedule||!schedule.date||!schedule.time){return alert('Please set schedule date & time');}
scheduleTime=scheduleTimeParser(schedule.date,schedule.time);}else{scheduleTime=null;}
getListEmail(this,function(listUserEmail){if(!message||!title||!listUserEmail){return $scope.checkRequired=true;}
if(!validateEmailList(listUserEmail)){return $scope.checkTrueEmail=false;}
directMessageToUserList(listUserEmail,message,title,scheduleTime);$modalInstance.dismiss('cancel');});};};function scheduleTimeParser(date,time){var day=date.getDate();var month=date.getMonth()+1;var year=date.getFullYear();return day+'/'+month+'/'+year+' '+time;}
function getListEmail(scope,callback){if(scope.listUserEmail){var list=scope.listUserEmail.split(',');return callback(parseEmail(list));}
readFile(callback);};function readFile(callback){var file=document.getElementById("csv_file").files[0];var mailListFromFile=[];var reader=new FileReader();reader.onload=function(e){var text=reader.result.toString();var a=text.split('\n');mailListFromFile=checkNullEmail(a);callback(parseEmail(mailListFromFile));};reader.readAsText(file,"utf-8");}
function validateEmailList(list){for(var i=0;i<list.length;i++){if(!validateEmail(list[i])){return false;}}
return true;}
function parseEmail(list){var new_list=[];list.forEach(function(email){new_list.push(email.trim());});return new_list;}
function checkNullEmail(list){var new_list=[];list.forEach(function(email){if(email!=""){new_list.push(email);}});return new_list;}
function init(){getSetting();getData();}
init();});}(angular));(function($a){'use strict';$a.module('ML').controller('helpdeskIssueDetails',function($scope,$rootScope,$http,$routeParams,$modal,$anchorScroll,$location,$window){$rootScope.tabSelect=5;$rootScope.MLPageDetail='Issue Details';$scope.env=env;$scope.isLoading=true;$scope.isUpdating=false;$scope.isReplying=false;$scope.messages=[];$scope.issue={};$scope.user={};$scope.newMessage=false;$scope.replyError=false;$scope.admins=[];$scope.gotoBottom=function(){$location.hash('lastItem');$anchorScroll();};function getCountry(user){if(user){if(user.tags){user.tags.forEach(function(tag){if(tag.indexOf('country')!==-1){user.flag=tag.split(':')[1];}});}}}
function getIssue(issue_id){$http.post('/helpdesk/issue/get-one',{issueId:issue_id}).success(function(data){if(data.s){getCountry(data.d);$scope.issue=data.d;if($scope.issue.assigned){if(typeof $scope.issue.assigned==='string'){$scope.issue.assigned=[$scope.issue.assigned];}}
$scope.user=data.d.user;getCountry($scope.user);}
else{alert('Get Issue Info Failed');}}).error(function(){$scope.isLoading=false;alert("Error From Server");})}
getIssue($routeParams.issue_id);var getMessage=function(issue_id){$scope.isLoading=true;$http.post('/helpdesk/message/get',{issueId:issue_id}).success(function(data){$scope.isLoading=false;if(data.s){$scope.messages=data.d;}else alert("Get Message Failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");})};getMessage($routeParams.issue_id);var listenSocket=function(issue_id){var socket=io('https://socket.moneylover.me/');var room='/helpdesk/issue/'+issue_id;socket.on(room,function(data){getIssue($routeParams.issue_id);getMessage($routeParams.issue_id);$scope.newMessage=true;});};listenSocket($routeParams.issue_id);var getAdminList=function(){$scope.isLoading=true;$http.get('/helpdesk/list-admin').success(function(data){$scope.isLoading=false;if(data.s)$scope.admins=data.d;else $scope.errorMsg="Get Admin Failed";}).error(function(){$scope.isLoading=false;$scope.errorMsg='Error From Server';})};getAdminList();var updateIssue=function(issue,callback){var postData={item:issue};if(postData.item.status==='null')postData.item.status=null;if(postData.item.user){if(postData.item.user._id)postData.item.user=postData.item.user._id;}else{postData.item.user={};postData.item.user._id=null;}
if(postData.item.assigned&&postData.item.assigned.length>0){forEach(postData.item.assigned,function(element,index){postData.item.assigned[index]=element._id;});}
if(postData.item.tags.length>0){postData.item.tags=postData.item.tags.split(",");postData.item.tags.forEach(function(value,index){postData.item.tags[index]=value.trim();});}
$scope.isUpdating=true;$http.post('/helpdesk/issue/update',postData).success(function(data){$scope.isUpdating=false;if(data.s){$scope.issue=data.d;callback(true);}
else callback(false);}).error(function(){$scope.isUpdating=false;callback(false);alert("Error From Server");})};$scope.moreIssue=moreIssue;function moreIssue(user){var modalInstance=$modal.open({templateUrl:'/partials/helpdesk/issue/more_issue.html',controller:ctrlMoreIssue,resolve:{user:function(){return user;}}});modalInstance.result.then(function(){});}
var ctrlMoreIssue=function($modalInstance,$scope,user){$scope.user=user;$scope.tabSelected='open';$scope.listIssue=[];var getMoreIssue=function(){$http.post('/helpdesk/issue/get-more',{userId:user._id}).success(function(result){if(result.s)$scope.listIssue=result.d;else alert("Get List Issue Failed");}).error(function(){alert("Error From Server");})};getMoreIssue();$scope.selectTab=function(mode){$scope.tabSelected=mode;};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.requestReview=function(){var msg='Would you like to review the app?';var metadata={isRequestReview:true};reply(msg,metadata);};$scope.requestImage=function(){var msg='Could you please attach a screenshot of the problem?';var metadata={isRequestImage:true};reply(msg,metadata);};$scope.setResolved=function(){$scope.issue.status='Resolved';logResolveDaily($scope.issue);$scope.updateIssue($scope.issue);};function logResolveDaily(issue){var postData={issue:issue._id}
$http.post('/helpdesk/stats/daily',postData).success(function(data){}).error(function(err){alert(err);})}
function reply(msg,metadata){var postData={issueId:$routeParams.issue_id,message:msg,userId:$scope.user._id,};if($scope.issue.metadata&&$scope.issue.metadata.l){postData.language=$scope.issue.metadata.l};if(metadata)postData.metadata=metadata;if($scope.issue.assigned&&$scope.issue.assigned.length>0){postData.isAssigned=true;}
$scope.isReplying=true;$http.post('/helpdesk/message/mod-reply',postData).success(function(data){$scope.isReplying=false;if(data.s){$scope.replyError=false;$scope.messages.push(data.d);$scope.message=null;$scope.issue.seen=false;if(!$scope.issue.assigned)getIssue($routeParams.issue_id);}else $scope.replyError=true;}).error(function(){$scope.isReplying=false;alert("Error From Server");});}
$scope.reply=function(msg){if(msg){reply(msg);}};$scope.replyAndResolved=function(msg){if(msg){reply(msg);$scope.issue.status='Resolved';$scope.updateIssue($scope.issue);}};$scope.editMessage=function(message){$http.post('/helpdesk/message/edit-mod-message',{id:message._id,message:message.content}).success(function(result){message.editMode=false;if(!result.s)return alert('Edit message failed');}).error(function(){message.editMode=false;alert('Error from server');});};$scope.updateIssue=function(issue){updateIssue(issue,function(status){if(status){$scope.updateNoteSuccess=false;$scope.updateNoteSuccess=true;}
else{$scope.updateNoteFailed=false;$scope.updateNoteFailed=true;}});};$scope.insertFaq=function(){var modalInstance=$modal.open({templateUrl:'/partials/helpdesk/issue/faq_popup.html',controller:ctrlInsertFaq,resolve:{}});modalInstance.result.then(function(answer){$scope.message=answer;});};var ctrlInsertFaq=function($scope,$modalInstance){var myTimeout;$scope.search=function(keyword){if(keyword){$http.post('/helpdesk/faq/search',{keyword:keyword}).success(function(data){if(data.s){$scope.suggestList=data.d;$scope.showSuggest=true;}else alert("Search Failed")}).error(function(){alert("Error From Server");})}};var startTimeoutSearch=function(keyword){myTimeout=setTimeout(function(){$scope.search(keyword);},2000);};var stopTimeoutSearch=function(){clearTimeout(myTimeout);};$scope.selectFaq=function(index){$modalInstance.close($scope.suggestList[index].answer);};$scope.keywordChanged=function(keyword){if(keyword||keyword!==''){stopTimeoutSearch();startTimeoutSearch(keyword);}else $scope.showSuggest=false;};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.showInfoIssues=function(){var modalInstance=$modal.open({templateUrl:'/partials/helpdesk/issue/infoMobile.html',controller:ctrlInfoMobile,resolve:{issue:function(){return $scope.issue;},user:function(){return $scope.user;}}});};var ctrlInfoMobile=function($scope,$modalInstance,issue,user){$scope.issue=issue;$scope.user=user;$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.moreIssues=function(user){moreIssue(user);$modalInstance.dismiss('cancel');}};$scope.checkAdminAssigned=function(admin){if(!$scope.issue.assigned){return true;}
for(var i=0;i<$scope.issue.assigned.length;i++){if($scope.issue.assigned[i]._id===admin._id)return false;}
return true;};$scope.assign=function(admin){$scope.issue.assigned.push(admin);$scope.updateIssue($scope.issue);};$scope.iosGroup=function(admins){roleTags(admins,'iOS');};$scope.androidGroup=function(admins){roleTags(admins,'Android');};$scope.bizGroup=function(admins){roleTags(admins,'Biz');};$scope.conceptGroup=function(admins){roleTags(admins,'Concept');};$scope.backendGroup=function(admins){roleTags(admins,'Web/Backend');};function roleTags(admins,roleName){var adminAssigned=[];for(var i=0;i<$scope.issue.assigned.length;i++){adminAssigned.push($scope.issue.assigned[i].username);}
for(var i=0;i<admins.length;i++){if(admins[i].role.indexOf(roleName)>-1&&adminAssigned.indexOf(admins[i].username)==-1){$scope.issue.assigned.push(admins[i]);}}
$scope.updateIssue($scope.issue);}
$scope.selectStatus=function(status){if(status==='Open'){if($scope.issue.status)$scope.issue.status=null;}
else $scope.issue.status=status;$scope.updateIssue($scope.issue);};$scope.removeAssign=function(index){$scope.issue.assigned.splice(index,1);$scope.updateIssue($scope.issue);};$scope.back=function(){$window.location.href='/helpdesk/issue';}});}(angular));(function($a){'use strict';$a.module('ML').controller('helpdeskEditAutoReplyMessages',function($scope,$rootScope,$http){$rootScope.tabSelect=5;$rootScope.MLPageDetail='Helpdesk Settings';getMessages();function getMessages(){$http.post('/helpdesk/settings/get-auto-reply-messages',{}).success(function(result){if(result.s){if(result.d)$scope.autoMessages=result.d;}else alert("Getting messages failed");}).error(function(){alert("Error From Server");});}
$scope.saveAutoMessages=function(messages){if(!messages||!messages.VI||!messages.EN){$scope.errorMessage='Messages must not null';return 0;}
$scope.errorMessage='';$scope.successMessage='';$http.post('/helpdesk/settings/update-auto-reply-messages',{messages:messages}).success(function(result){if(result.s)$scope.successMessage="Saved!";else $scope.errorMessage='Saving messages failed';}).error(function(){$scope.errorMessage="Error From Server";});}});}(angular));(function($a){'use strict';$a.module('ML').controller('helpdeskStats',function($rootScope,$scope,$http){$rootScope.tabSelect=5;$rootScope.MLPageDetail='Helpdesk Stats';$scope.isLoading=true;$scope.page=1;var limit=50;$scope.currentTab='issue';$scope.tabSelect=function(tab){$scope.currentTab=tab;};function getStats(url,year,month,adminId){$scope.isLoading=true;var postData={limit:limit,skip:limit*($scope.page-1),year:year||null,month:month||null,adminId:adminId||null};$http.post(url,postData).success(function(response){if(response.s){$scope.stats=response.d;$scope.isLoading=false;}
else alert("Get data failed");}).error(function(){alert("Error From Server");});}
$scope.getStats=function(){var url;switch($scope.currentTab){case'issue':url='/helpdesk/stats/issue';getStats(url);break;case'monthly':url='/helpdesk/stats/monthly';if(!$scope.query||!$scope.query.year||$scope.query.year==''||!$scope.query.month||$scope.query.month==''){$scope.query={year:moment().year(),month:moment().month()};}
getStats(url,$scope.query.year,$scope.query.month);break;case'personal':break;default:break;}};$scope.customGetStats=function(){if(!$scope.query||!$scope.query.year||$scope.query.year==''||!$scope.query.month||$scope.query.month==''){alert("Please type year and month!");}else{var url='/helpdesk/stats/monthly';getStats(url,$scope.query.year,$scope.query.month-1);}};$scope.helpdeskStats=function(year,month,adminId){$scope.isLoading=true;var postData={limit:limit,skip:limit*($scope.page-1),year:year||null,month:month||null,adminId:adminId||null};$http.post('/helpdesk/stats/issue',postData).success(function(response){if(response.s){$scope.isLoading=false;var dataRaw=response.d.monthly.reverse();var data=[];for(var i=0;i<dataRaw.length;i++){var time=dataRaw[i].month+1+"-"+dataRaw[i].year;var issue=dataRaw[i].amount;var solved=dataRaw[i].solved;data.push({time:time,issue:issue,solved:solved,});}
new Morris.Line({element:'chart009',data:data,smooth:false,parseTime:false,pointSize:5,xkey:'time',ykeys:['issue','solved'],labels:['Issue','Solved'],lineColors:['#E68A72','#247882'],pointStrokeColors:['#E68A72','#247882'],pointFillColors:['#ffffff'],fillOpacity:0});}
else alert("Get data failed");}).error(function(){alert("Error From Server");});};$scope.helpdeskDailyStats=function(){var postData={limit:limit,skip:limit*($scope.page-1)};var data=[];$http.post('/helpdesk/stats/static_daily',postData).success(function(response){if(response.status==true){for(var i=0;i<response.data.length;i++){var time=response.data[i].byDate;time=moment(time).format('ll');var issue=response.data[i].issue;var resolve=response.data[i].resolve;data.push({time:time,issue:issue,solved:resolve,});}
new Morris.Line({element:'chart010',data:data,smooth:false,parseTime:false,pointSize:5,xkey:'time',ykeys:['issue','solved'],labels:['Issue','Solved'],lineColors:['#E68A72','#247882'],pointStrokeColors:['#E68A72','#247882'],pointFillColors:['#ffffff'],fillOpacity:0});}else{alert('Get data failed');}}).error(function(error){alert(error);})};});}(angular));(function($a){'use strict';$a.module('ML').controller('iconsInfoMaker',function($scope,$rootScope,$http){$rootScope.MLPageDetail='Icon Pack Info JSON Maker';$rootScope.tabSelect=7;var output=null;$scope.isLoading=false;var generate=function(icon_pack_info){var file=document.getElementById('csv_input').files[0];if(!icon_pack_info||!icon_pack_info.name||!icon_pack_info.id||!file){return alert("Please fill all fields");}
var reader=new FileReader();reader.readAsText(file);reader.onload=function(event){output={name:icon_pack_info.name,product_id:icon_pack_info.id,icons:{}};var lines=event.target.result.replace(/"/g,"").replace(/\r/g,"").split('\n');for(var i=0;i<lines.length;i++){var line=lines[i];line=line.split(',');if(line[0]){for(var j=0;j<line.length;j++){line[j]=line[j].trim();}
if(line[0].indexOf('Main keywords')!==-1){line.shift();output.tags=line;}else if(line[0]!=='Name'){var icon_name=line[0];line.shift();output.icons[icon_name]=line;}}}
save(output);};};var save=function(data){if(!data){return;}
var filename='package.json';if(typeof data==='object'){data=JSON.stringify(data,undefined,2);}
var blob=new Blob([data],{type:'text/json'});var e=document.createEvent('MouseEvent');var a=document.createElement('a');a.download=filename;a.href=window.URL.createObjectURL(blob);a.dataset.downloadurl=['text/json',a.download,a.href].join(':');e.initMouseEvent('click',true,false,window,0,0,0,0,0,false,false,false,false,0,null);a.dispatchEvent(e);};$scope.generate=generate;$scope.save=save;});}(angular));(function($a){'use strict';$a.module('ML').controller('icons',function($scope,$http,$rootScope,$modal,localStorageService){$scope.env=env;$rootScope.tabSelect=8;$rootScope.MLPageDetail='Icons';$scope.listIcon=[];$scope.listPrivateIcon=[];$scope.currentList="Released";var newItems=0;function updateIcon(iconObject){$http.post('/icons/update',{data:iconObject}).success(function(result){if(!result.s){alert("Edit item due to failed");}}).error(function(){alert('Error From Server');});}
function pushNewIcon(icon,callback){$http.post('/icons/create',{icon:icon}).success(function(result){if(result.s){callback(null,result.d);}else{callback("Save icon info failed");}}).error(function(){callback("Error From Server");});}
function getList(){$http.post('/icons/get',{}).success(function(data){$scope.listIcon=data.data;localStorageService.add('listIcon',JSON.stringify(data.data));$scope.listPrivateIcon=data.privateData;localStorageService.add('listPrivateIcon',JSON.stringify(data.privateData));}).error(function(){alert('Error');});}
getList();$scope.showIconList=function(list){$scope.currentList=list;};$scope.changeStatus=function(icon,status){var url='';var stt=true;if(status===1){url='/icons/change-free-status';stt=!icon.isFree;}else if(status===2){url='/icons/change-new-status';stt=!icon.isNew;}else if(status===3){url='/icons/change-feature-status';stt=!icon.isFeature;}else if(status===4){url='/icons/change-top-download-status';stt=!icon.isTopDownload;}else if(status===5){url='/icons/change-hide-status';stt=!icon.isHide;}else{return;}
$http.post(url,{id:icon._id,status:stt}).success(function(result){if(result.s){if(status===1)icon.isFree=stt;if(status===2)icon.isNew=stt;if(status===3)icon.isFeature=stt;if(status===4)icon.isTopDownload=stt;if(status===5)icon.isHide=stt;updateIcon({listIcon:$scope.listIcon,listPrivateIcon:$scope.listPrivateIcon});}else{alert('Failed to change this status');}}).error(function(){alert("Error From Server");});};$scope.addNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/icons/info.html',controller:ctrlAdd,resolve:{listIcon:function(){return $scope.listIcon;},listPrivateIcon:function(){return $scope.listPrivateIcon;}}});modalInstance.result.then(function(iconCallbackObject){newItems++;updateIcon(iconCallbackObject);$scope.generate();},function(){});};var ctrlAdd=function($scope,Page,$modalInstance,listIcon,listPrivateIcon){$scope.errorMsg=null;$scope.iconInfo={isFree:false,isNew:true,isPublic:false,isShareOnly:false,canShareToBuy:false};$scope.saveIconPack=function(){var self=this;var fd=new FormData();if(self.iconInfo.price_vn&&self.iconInfo.price_gl&&self.iconInfo.price_share&&self.iconInfo.price_credit){self.iconInfo.price_vn=parseInt(self.iconInfo.price_vn);self.iconInfo.price_gl=parseInt(self.iconInfo.price_gl);self.iconInfo.price_share=parseInt(self.iconInfo.price_share);self.iconInfo.price_credit=parseInt(self.iconInfo.price_credit);if(isNaN(self.iconInfo.price_vn))return alert("Price VND should be number");if(isNaN(self.iconInfo.price_gl))return alert("Price USD should be number");if(isNaN(self.iconInfo.price_share))return alert("Price Share should be number");if(isNaN(self.iconInfo.price_credit))return alert("Price Credit should be number");}
fd.append('preview',this.iconInfo.preview);fd.append('thumb',this.iconInfo.thumb);fd.append('packages',this.iconInfo.link);fd.append('packagename',self.iconInfo.product_id);$http.post('/icons/upload-package',fd,{headers:{'Content-Type':undefined},transformRequest:$a.identity}).success(function(data){if(data.s){alert('Success');var urlPackage=(data.t)?'https://statictest.moneylover.me/icon_pack/':'https://static.moneylover.me/icon_pack/';self.iconInfo.thumb=urlPackage+'thumb/'+data.prefix+self.iconInfo.product_id+'_thumb.png';self.iconInfo.preview=urlPackage+'thumb/'+data.prefix+self.iconInfo.product_id+'_preview.png';self.iconInfo.link=urlPackage+'pack/'+data.prefix+self.iconInfo.product_id+'.zip';if(self.iconInfo.isPublic){listIcon.unshift(self.iconInfo);}else{listPrivateIcon.unshift(self.iconInfo);}
pushNewIcon(self.iconInfo,function(error,icon){if(error)return alert(error);});$modalInstance.close({listIcon:listIcon,listPrivateIcon:listPrivateIcon});}}).error(function(){alert('Upload error!');});};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.publicTurn=function(mode,icon){if(mode==="Release"){$http.post('/icons/change-public-status',{id:icon._id,status:true}).success(function(result){if(result.s){icon.isPublic=true;$scope.listPrivateIcon.forEach(function(iconInfo,key){if(iconInfo===icon){$scope.listPrivateIcon.splice(key,1);}});$scope.listIcon.unshift(icon);updateIcon({listIcon:$scope.listIcon,listPrivateIcon:$scope.listPrivateIcon});}else{alert("Failed to change this status");}}).error(function(){alert("Error From Server");});}else{$http.post('/icons/change-public-status',{id:icon._id,status:false}).success(function(result){if(result.s){icon.isPublic=false;$scope.listIcon.forEach(function(iconInfo,key){if(iconInfo===icon){$scope.listIcon.splice(key,1);}});$scope.listPrivateIcon.unshift(icon);updateIcon({listIcon:$scope.listIcon,listPrivateIcon:$scope.listPrivateIcon});}else{alert("Failed to change this status");}}).error(function(){alert("Error From Server");});}};$scope.edit=function(icon){var modalInstance=$modal.open({templateUrl:'/partials/icons/infoEdit.html',controller:ctrlEdit,resolve:{listIcon:function(){return $scope.listIcon;},iconInfo:function(){return icon;},listPrivateIcon:function(){return $scope.listPrivateIcon;}}});modalInstance.result.then(function(iconCallbackObj){updateIcon(iconCallbackObj);},function(){});};var ctrlEdit=function($scope,Page,$modalInstance,listIcon,iconInfo,listPrivateIcon){$scope.iconInfo=iconInfo;$scope.existPackpage=false;$scope.checkExistPackage=function(){var producId=$scope.iconInfo.product_id;var whereData=_.where(listIcon,{product_id:producId});$scope.existPackpage=whereData.length>1;};$scope.save=function(){var self=this;if(self.iconInfo.price_vn&&self.iconInfo.price_gl&&self.iconInfo.price_share&&self.iconInfo.price_credit){self.iconInfo.price_vn=parseInt(self.iconInfo.price_vn);self.iconInfo.price_gl=parseInt(self.iconInfo.price_gl);self.iconInfo.price_share=parseInt(self.iconInfo.price_share);self.iconInfo.price_credit=parseInt(self.iconInfo.price_credit);if(isNaN(self.iconInfo.price_vn))return alert("Price VND should be number");if(isNaN(self.iconInfo.price_gl))return alert("Price USD should be number");if(isNaN(self.iconInfo.price_share))return alert("Price Share should be number");if(isNaN(self.iconInfo.price_credit))return alert("Price Credit should be number");}
$modalInstance.close(self.iconInfo);};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.delete=function(icon,list){var ok=confirm("This icon package will be remove.Are you sure?");if(!ok){return;}
$http.post('/icons/delete-pack',icon).success(function(data){if(data.s){if(list=="Released"){$scope.listIcon.forEach(function(iconInfo,key){if(iconInfo===icon){$scope.listIcon.splice(key,1);}});}else{$scope.listPrivateIcon.forEach(function(iconInfo,key){if(iconInfo===icon){$scope.listPrivateIcon.splice(key,1);}});}
updateIcon({listIcon:$scope.listIcon,listPrivateIcon:$scope.listPrivateIcon});alert('Success');}else{alert('Failed to delete this icon package');}}).error(function(){alert('Deleting icon pack error!');});};$scope.generate=function(){$http.post('/icons/build',{}).success(function(result){if(result.s){alert('Done');}else{alert('Build cache due to failed');}}).error(function(){alert('Error From Server');});};});}(angular));(function($a,AWS){'use strict';$a.module('ML').controller('images',function($scope,$rootScope,$modal,$http){$rootScope.tabSelect=7;$rootScope.MLPageDetail='Image Manager';$scope.page=1;$scope.isLastPage=true;$scope.isFirstPage=true;$scope.isLoading=false;$scope.transactions=[];var limit=20;var bucket;var s3Options={accessKeyId:'AKIAJB6JUVNE22EIBMXA',secretAccessKey:'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',region:'ap-southeast-1'};connectS3();function connectS3(){var bucketName=(env==='production')?'money-lover-images':'money-lover-images-test';AWS.config.update({accessKeyId:s3Options.accessKeyId,secretAccessKey:s3Options.secretAccessKey});AWS.config.region=s3Options.region;bucket=new AWS.S3({params:{Bucket:bucketName}});}
function encode(data){var str=data.reduce(function(a,b){return a+String.fromCharCode(b)},'');return btoa(str).replace(/.{76}(?=.)/g,'$&\n');}
init();function init(){var skip=limit*($scope.page-1);getImageList(skip,limit);}
function getImageList(skip,limit){$http.post('/image-manager/get',{skip:skip,limit:limit}).success(function(result){if(result.s){$scope.transactions=result.d;checkPage();}
else alert("Get transaction images failed");}).error(function(){alert("Error From Server");});}
$scope.view=function(imageId){var modalInstance=$modal.open({templateUrl:'/partials/images/view.html',controller:viewController,resolve:{imageId:function(){return imageId;}}});};var viewController=function($scope,$modalInstance,imageId){getImage(imageId);function getImage(id){if(bucket){bucket.getObject({Key:id},function(err,file){var imageUrl="data:image/jpeg;base64,"+encode(file.Body);document.getElementById('transaction_image').setAttribute('src',imageUrl);});}}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};};function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.transactions.length<limit;}
$scope.nextPage=function(value){$scope.page+=value;var skip=limit*($scope.page-1);getImageList(skip,limit);};})}(angular,AWS));'use strict';(function($a){$a.module('ML').controller('info',function($scope,$rootScope,$http,$modal,$location,$routeParams,$window,$filter){$scope.param=$routeParams;$scope.userInfo=null;$scope.listWallet=[];$scope.campaign_list=[];$scope.walletDetails=null;$scope.isUserDetailsPage=true;$scope.isWalletPage=false;$scope.walletDetailsPageNo=null;$scope.isFirstPage=false;$scope.isLastPage=false;var limit=200;$scope.tabSelected='working';$scope.isLoading=false;$scope.walletBalance={};$scope.credits=null;var params=$location.search();if(params.wallet){getWalletById(params.wallet);}
function getWalletById(id){$scope.isLoading=true;$http.get('/info/wallet-by-id/'+id).success(function(result){$scope.isLoading=false;if(result){$scope.viewWalletDetails(result);}else{alert("Getting wallet detail failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
$scope.finsifyDetail=function(userInfo){var url="https://api.finsify.com/v2/login/private-detail?email="+userInfo.email+"&19f3fdbce4=19f3fdbce4&pass=7337610&client=Tu5dvG07KVpx6b";$window.open(url,'_blank');}
$scope.getWalletDetailsPageNo=function(){$scope.walletDetailsPageNo=$scope.listWallet.indexOf($scope.walletDetails);if($scope.walletDetailsPageNo==0){$scope.isFirstPage=true;}
if($scope.walletDetailsPageNo==($scope.listWallet.length-1)){$scope.isLastPage=true;}};$scope.backToUserDetail=function(){$scope.isUserDetailsPage=true;$scope.isWalletPage=false;};var getWalletsInfo=function(userid,callback){$scope.isLoading=true;$http.get('/info/acc/'+userid).success(function(data){$scope.isLoading=false;callback(data);}).error(function(){alert('Error');});};var getSkipPassword=function(user){$http.post('/user/get-customer-support',{userId:user._id}).success(function(result){if(result.s){user.customerSupport=result.d;}}).error();};function getUserInfo(){$scope.userInfo={};$http.get('/info/user/'+$scope.param.email).success(function(data){$scope.userInfo=data;getSkipPassword($scope.userInfo);$scope.getUserWallet();getCampaignByUser($scope.userInfo._id);getCredit($scope.userInfo._id);}).error(function(){alert('Error');});}
getUserInfo();function getBalance(listWallet){var wallet_id_list=[];listWallet.forEach(function(wallet){if(!wallet.account_type&&!wallet.isDelete){wallet_id_list.push(wallet._id);}});if(wallet_id_list.length===0)return 0;function formatResult(data){var keys=Object.keys(data);var result={};keys.forEach(function(id){result[id]=[];data[id].forEach(function(balance){var currency=Object.keys(balance)[0];var amount=$filter('number')(balance[currency],2);var str;if(keys.length===1){str=amount+' '+currency;}else{str=amount;}
result[id].push(str);});});return result;}
$http.post('/info/wallet-balance',{wallets:wallet_id_list}).success(function(result){if(result.s){$scope.walletBalance=formatResult(result.d);}else{alert("Failed to get balances");}}).error(function(){alert("Error From Server");});}
$scope.getUserWallet=function(){getWalletsInfo($scope.userInfo._id,function(data){getBalance(data);$scope.listWallet=data;});};$scope.nextWallet=function(status){if(!$scope.isFirstPage||!$scope.isLastPage){$scope.walletDetailsPageNo+=status;$scope.isFirstPage=$scope.walletDetailsPageNo==0;$scope.isLastPage=$scope.walletDetailsPageNo==($scope.listWallet.length-1);}
$scope.walletDetails=$scope.listWallet[$scope.walletDetailsPageNo];};$scope.selectTab=function(tab){if($scope.tabSelected!=tab)$scope.tabSelected=tab;};$scope.viewWalletDetails=function(walletDetails){$scope.walletDetails=walletDetails;$scope.isUserDetailsPage=false;$scope.isWalletPage=true;};$scope.restoreWallet=function(walletDetails){var ok=confirm('Do you really wanna restore this wallet?');if(ok){$http.post('/user/restore-wallet',{walletId:walletDetails._id}).success(function(result){if(result.s)alert("Done");else alert("Restoring wallet Failed");}).error(function(){alert("Error From Server");});}};var directMessageToUser=function(userInfo,message,title){var pushData={};pushData.listUserEmail=[userInfo.email];pushData.message=message;pushData.name=title;$http.post('/helpdesk/issue/add',{pushData:pushData}).success(function(data){}).error(function(data){});};$scope.sendMessage=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/helpdesk/issue/sendMessage.html',controller:sendMessageController,resolve:{userInfo:function(){return userInfo;}}});};var sendMessageController=function($modalInstance,$scope,userInfo){$scope.userDetailPage=true;$scope.cancel=function(message,title){if(message||title){var cfmdialog=confirm('Do you really want to cancel?');if(cfmdialog){$modalInstance.dismiss('cancel');}else{return false;}}else{$modalInstance.dismiss('cancel');}};$scope.send=function(message,title){$scope.checkRequired=true;if(message&&title){directMessageToUser(userInfo,message,title);$modalInstance.dismiss('cancel');}};$scope.userInfo=userInfo;};$scope.viewMoreWalletDetails=function(accid,mode){var modalInstance=$modal.open({templateUrl:'/partials/info/morewalletdetails.html',controller:ctrlMoreWalletDetails,resolve:{accid:function(){return accid;},mode:function(){return mode;}}});modalInstance.result.then(function(){});};var ctrlMoreWalletDetails=function($scope,$modalInstance,accid,mode){$scope.env=env;$scope.modalPageNo=0;$scope.modalFirstPage=true;$scope.modalLastPage=true;$scope.arrayInfo=[];$scope.info=null;$scope.mode=mode;$scope.isLoading=false;switch(mode){case"Budget":countRecords('budg');getDetail('budg',1);break;case"Category":countRecords('cate');getDetail('cate',1);break;case"Campaign":countRecords('camp');getDetail('camp',1);break;case"Transaction":countRecords('tran');getDetail('tran',1);break;default:break;}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.modalNextPage=function(status){if(status==="first"){$scope.modalPageNo=0;checkModalPage();}
else if(status==="last"){$scope.modalPageNo=$scope.arrayInfo.length-1;checkModalPage();}
else{if(!$scope.modalFirstPage||!$scope.modalLastPage){$scope.modalPageNo+=status;checkModalPage();}}
$scope.info=$scope.arrayInfo[$scope.modalPageNo];};function countRecords(type){var url='/info/'+type+'/'+accid+'/count';$http.get(url).success(function(data,status){if(data){$scope.totalRc=data.totalRc;$scope.isDel=data.deletedRc;var moduled=$scope.totalRc/limit;var totalBigPage=Math.round($scope.totalRc/limit);if(moduled<(limit/2))totalBigPage+=1;$scope.totalBigPage=totalBigPage;}}).error(function(data,status){alert("Counting Errors");});}
function getDetail(type,page){$scope.isLoading=true;var url='/info/'+type+'/'+accid+'?page='+page;$scope.bigPageNo=page;$http.get(url).success(function(data,err){$scope.isLoading=false;$scope.arrayInfo=data;$scope.info=$scope.arrayInfo[0];checkModalPage();}).error(function(data,err){$scope.isLoading=false;alert('error');});}
$scope.togglePublic=function(campaign){$http.post('/user/toggle-public-campaign',{id:campaign._id}).success(function(result){if(!result.s)return alert('Change public state failed');campaign.isPublic=!campaign.isPublic;}).error(function(){alert("Error from server");});};$scope.nextBigPage=function(mode){var type="";switch($scope.mode){case"Transaction":type='tran';break;case"Category":type='cate';break;case"Campaign":type='camp';break;case"Budget":type='budg';break;}
if(mode==='next'){if($scope.bigPageNo<$scope.totalBigPage)getDetail(type,$scope.bigPageNo+1);}else{if($scope.bigPageNo>1)getDetail(type,$scope.bigPageNo-1);}
$scope.modalPageNo=0;};var checkModalPage=function(){if($scope.arrayInfo.length===0){$scope.modalFirstPage=true;$scope.modalLastPage=true;}else{$scope.modalFirstPage=$scope.modalPageNo===0;$scope.modalLastPage=$scope.modalPageNo===($scope.arrayInfo.length-1);}};};$scope.iconGift=function(user){var modalInstance=$modal.open({templateUrl:'/partials/users/icon-gift.html',controller:ctrlIconGift,resolve:{icon_purchased:function(){return user.icon_package;},user_id:function(){return user._id;},user_email:function(){return user.email;}}});modalInstance.result.then(function(){},function(){});};var ctrlIconGift=function($scope,$modalInstance,$http,icon_purchased,user_id,user_email){$scope.userInfo={id:user_id,email:user_email,icon_purchased:icon_purchased};$scope.productType="1";$scope.creditList=[];$scope.premiumList=[];$scope.subscriptionList=[];$scope.iconList=[];$scope.semiPremiumList=[];$scope.send=function(){if(!this.gift.reason){return alert('Please type your reason');}
switch(this.productType){case"1":sendIconGift(this.gift);break;case"2":sendSubscriptionGift(this.gift,'premium');break;case"4":sendSubscriptionGift(this.gift,'linked_wallet');break;case"3":sendCreditGift(this.gift);break;case"5":sendPremiumGift(this.gift);break;case"6":sendSemiPremiumGift(this.gift);break;default:break;}};function sendSemiPremiumGift(gift){if(!gift.semi_premium){alert('Please select semi_premium package');}
var productInfo;$scope.semiPremiumList.forEach(function(item){if(item._id==JSON.parse(gift.semi_premium)._id){productInfo=item;}});var platform;if(productInfo){var str=productInfo.metadata.split(",");str.forEach(function(item){var key=item.split(":")[0];var value=item.split(":")[1];if(key=='platform'){platform=value;}});}
var postData={userId:user_id,productId:productInfo.product_id,platform:platform};$http.post('/user/send-semi-gift',postData).success(function(result){if(!result.status){return alert('Send semi premium gift due to failed');}
$modalInstance.dismiss('cancel');}).error(function(){alert('Error from server');});}
function sendSubscriptionGift(gift,type){if(!gift.subscription){alert('Please select subscription package');}
var productInfo=$scope.subscriptionList[gift.subscription];var postData={userId:user_id,productId:productInfo.product_id,unit:productInfo.expire_unit,value:productInfo.expire_value,type:type};$http.post('/user/send-subscription',postData).success(function(result){if(!result.s){return alert('Send subscription gift due to failed');}
$modalInstance.dismiss('cancel');}).error(function(){alert('Error from server');});}
function sendCreditGift(gift){if(!gift.credit){return alert('Please select credit product');}
gift.credit=JSON.parse(gift.credit);var postData={user_id:user_id,user_email:user_email,reason:gift.reason,product_id:gift.credit.product_id};$http.post('/user/send-credit',postData).success(function(result){if(!result.s){return alert('Send credit gift due to failed');}
$modalInstance.dismiss('cancel');}).error(function(){alert('Error From Server');});}
function sendIconGift(gift){if(!gift.icon){return alert('Please select an icon');}
var giftInfo={userId:user_id,userEmail:user_email,reason:gift.reason,iconName:$scope.iconList[gift.icon].name,iconId:$scope.iconList[gift.icon].product_id,iconLink:$scope.iconList[gift.icon].link};$http.post('/user/send-icon-gift',{giftInfo:giftInfo}).success(function(data){if(!data.s){return alert('Send icon gift due to failed');}
$modalInstance.dismiss('cancel');}).error(function(){alert('Error while send icon gift');});}
function sendPremiumGift(gift){if(!gift.premium){return alert('Please select an item');}
gift.premium=JSON.parse(gift.premium);var postData={user_id:user_id,user_email:user_email,product_id:gift.premium.product_id,reason:gift.reason};$http.post('/user/active-premium',postData).success(function(result){if(!result.s){return alert('Send premium gift due to failed');}
$modalInstance.dismiss('cancel');}).error(function(){alert('Error From Server');});}
$scope.checkPurchased=function(item){var purchased=icon_purchased.indexOf(item.product_id);return purchased===-1;};function getIconList(){if($scope.iconList.length>0){return true;}
$http.post('/icons/get',{}).success(function(data){if(!data.error){$scope.iconList=data.data;}}).error(function(data){alert("Error while get icon list");});}
function getCreditList(){if($scope.creditList.length>0){return true;}
$http.post('/use-credits/list',{}).success(function(result){if(result.s){$scope.creditList=result.d;}else{alert('Get credit list due to failed');}}).error(function(){alert('Error From Server');});}
function getPremiumList(){if($scope.premiumList.length>0){return true;}
$http.post('/premium-products/list',{}).success(function(result){if(!result.s){return alert('Get premium product due to failed');}
$scope.premiumList=result.d;}).error(function(){alert('Error From Server');});}
function getSubscriptionList(){if($scope.subscriptionList.length>0){return true;}
$http.post('/subscription-products/gift',{}).success(function(result){if(!result.s){return alert('Get subscription product due to failed');}
$scope.subscriptionList=result.d;}).error(function(){alert('Error from server');});}
function getSemiPremiumList(){if($scope.semiPremiumList.length>0){return true;}
$http.post('/premium-products/list',{}).success(function(result){if(!result.s){return alert('Get premium product due to failed');}
$scope.semiPremiumList=result.d;}).error(function(){alert('Error From Server');});}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.productTypeSelected=function(){var type=this.productType;switch(type){case'1':getIconList();break;case'2':getSubscriptionList();break;case'3':getCreditList();break;case'4':getSubscriptionList();break;case'5':getPremiumList();break;case'6':getSemiPremiumList();break;default:break;}};function init(){getIconList();}
init();};$scope.showDevice=function(user_id){var modalInstance=$modal.open({templateUrl:'/partials/info/devices.html',controller:ctrlListDevices,resolve:{user_id:function(){return user_id;}}});modalInstance.result.then(function(){},function(){});};var ctrlListDevices=function($scope,Page,$modalInstance,user_id){$scope.listDevices=[];getDeviceList();$scope.changeDevMode=function(device){device.isDev=!device.isDev;$http.post('/bonus/change-dev-mode-device',{id:device._id,devMode:device.isDev}).success(function(data,err){alert(data.msg);}).error(function(data,err){alert("Error from server");});};function getDeviceList(){$http.get('/info/device/'+user_id).success(function(data,status){if(data)$scope.listDevices=data;}).error(function(data,status){alert("Error from server");});}
$scope.copyToken=function(device){return device.tokenDevice;};$scope.getTokenClicked=function(){alert("Token has been copied to clipboard.");};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.changeLimitDevice=function(user){var modalInstance=$modal.open({templateUrl:'/partials/users/edit-limit-device.html',controller:ctrlLimitDevice,resolve:{user:function(){return user;}}});modalInstance.result.then(function(){},function(){});};var ctrlLimitDevice=function($scope,$rootScope,$modalInstance,user){$scope.user=user;var originalData={limitDevice:$scope.user.limitDevice};$scope.save=function(){var userinfo={uid:$scope.user._id,limitDevice:$scope.user.limitDevice};$http.post('/user/changelimitdevice',{userinfo:userinfo}).success(function(data,err){if(data.err)alert('Error from server');else{$modalInstance.dismiss('cancel');}}).error(function(data,err){alert("Error from server");});};$scope.close=function(){$scope.user.limitDevice=originalData.limitDevice;$modalInstance.dismiss('cancel');};};$scope.addExpire=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/info/expire-setting.html',controller:ctrlAddExpire,resolve:{userInfo:function(){return userInfo;}}});modalInstance.result.then(function(){$http.post('/premiumlog/savelog',{email:userInfo.email,action:"Set Expire"}).success(function(){}).error(function(){});},function(){});};var ctrlAddExpire=function($scope,$modalInstance,$http,userInfo){$scope.currentExpire=userInfo.expireDate;$scope.save=function(data){$http.post('/user/add-expire',{userId:userInfo._id,timeUnit:data.type,timeValue:data.value}).success(function(result){if(result.s){getUserInfo();$modalInstance.close();}
else alert("Set Expire Date Failed");}).error(function(){alert("Error From Server");});};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.showNotif=function(){var modalInstance=$modal.open({templateUrl:'/partials/messages/sessions.html',controller:ctrlShowNotif,});};var ctrlShowNotif=function($scope,$modalInstance){$scope.userDetailPage=true;$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.showIssues=function(user){var modalInstance=$modal.open({templateUrl:'/partials/helpdesk/issue/more_issue.html',controller:ctrlIssues,resolve:{user:function(){return user;}}});modalInstance.result.then(function(){});};$scope.changeCustomerSupport=function(user){var skiped=user.customerSupport?false:true;var s=confirm("Bạn muốn đổi trạng thái Customer Support của user "+user.email+"?");if(s){$http.post('/user/set-customer-support',{userId:user._id,status:skiped}).success(function(result){if(result.s){user.customerSupport=skiped;}else alert("Setting customer support failed");}).error(function(){alert('Error From Server');});}};var ctrlIssues=function($scope,$http,$modalInstance,user){$scope.listIssue=[];$scope.user=user;$scope.tabSelected='open';function getList(){$http.post('/user/issues',{userId:user._id}).success(function(result){if(result.s)$scope.listIssue=result.d;else alert("Get Issues Failed");}).error(function(){alert("Error From Server");});}
getList();$scope.selectTab=function(tab){$scope.tabSelected=tab;};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.manualTag=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/info/manual-tag.html',controller:ctrlManualTag,resolve:{userInfo:function(){return userInfo;}}});};var ctrlManualTag=function($scope,$modalInstance,userInfo){$scope.userInfo=userInfo;$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.removeTag=function(item){var cfmdialog=confirm("Do you want remove this tag?");if(cfmdialog){userInfo.tags.splice(item,1);}};$scope.addTag=function(newTag){if(newTag&&newTag.trim().length>0){$scope.userInfo.tags.push(newTag);newTag='';$a.element("#newTag").val('');}};$scope.save=function(newTag){$scope.addTag(newTag);$http.post("/user/update-tag",{tags:$scope.userInfo.tags,userId:$scope.userInfo._id}).success(function(result){if(result.s){$modalInstance.close();}else{$scope.errorSave=true;}}).error(function(){$scope.errorAdd=true;});};};$scope.showUserInfo=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/info/user-info.html',controller:ctrlUserInfo,resolve:{userInfo:function(){return userInfo;}}});modalInstance.result.then(function(){});};var ctrlUserInfo=function($scope,$modalInstance,userInfo){$scope.userInfo=userInfo;$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.acceptPurchased=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/users/reason.html',controller:ctrlAcceptPurchased,resolve:{userInfo:function(){return userInfo;}}});modalInstance.result.then(function(user){userInfo=user;},function(){});};var ctrlAcceptPurchased=function($scope,Page,$modalInstance,userInfo){$scope.userInfo=userInfo;$scope.setPurchased=function(userInfo){var purchased=userInfo.purchased?false:true;var s=confirm('Bạn thực sự muốn thực hiện thay đổi này?');if(s){userInfo.purchased=purchased;editUser(userInfo,function(data){if(data.data){var action="";if(data.data.purchased){action="free -> premium";}else{action="premium -> free";}
$http.post('/premiumlog/savelog',{email:data.data.email,action:action}).success(function(data){if(data.s){$modalInstance.close(userInfo);}}).error(function(){alert("Error while save admin action");$modalInstance.close(userInfo);});}});}};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};function editUser(userInfo,callback){$http.post('/user/edit',userInfo).success(function(data){callback(data);}).error(function(data){callback(data);});}
$scope.discountSetting=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/info/discount.html',controller:ctrlDiscount,resolve:{userInfo:function(){return userInfo;}}});};var ctrlDiscount=function($scope,$modalInstance,userInfo){$scope.userInfo=userInfo;detectUserDiscount();function detectUserDiscount(){if(userInfo.tags.length===0)return 0;userInfo.tags.forEach(tag=>{if(tag.indexOf('discount:')!==-1){return $scope.userDiscount=tag.split(':')[1];}});}
$scope.submit=function(userDiscount){if(!userDiscount)return 0;$scope.isLoading=true;$http.post('/user/update-discount',{discount:userDiscount,userId:$scope.userInfo._id}).success(function(result){$scope.isLoading=false;if(result.s)$modalInstance.close();else $scope.failMessage='Discount setting failed';}).error(function(){$scope.isLoading=false;$scope.failMessage="Error from server";});};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};function getCampaignByUser(user){$http.post('/info/global-camp',{user:user}).success(function(result){if(result.s){$scope.campaign_list=result.d;}else{alert('Get campaign due to failed');}}).error(function(){alert('Error From Server');});}
function getCredit(user_id){$http.post('/user/view-credit',{user_id:user_id}).success(function(result){if(result.s){var credit_type_list=Object.keys(result.d);var output="";credit_type_list.forEach(function(key,index){if(index>0){output+=', ';}
output+=key+' '+result.d[key];});$scope.credits=output;}}).error(function(){alert("Error From Server");});}
$scope.showReceipt=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/info/receipt.html',controller:ctrlReceipt,resolve:{userInfo:function(){return userInfo;}}});};function ctrlReceipt($scope,$modalInstance,userInfo){$scope.receipt_list=[];$http.post('/info/receipt',{user:userInfo._id}).success(function(result){if(result.s){$scope.receipt_list=result.d;}else{alert('Get receipt due to error');}}).error(function(){alert('Error From Server');});$scope.close=function(){$modalInstance.dismiss('cancel');};}
$scope.purchase_history=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/info/purchase_history.html',controller:ctrlPurchaseHistory,resolve:{userInfo:function(){return userInfo;}}});};function ctrlPurchaseHistory($scope,$modalInstance,userInfo){$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.isLoading=false;$scope.history_list=[];var limit=20;getHistory();function getHistory(){$scope.isLoading=true;var skip=limit*($scope.page-1);$http.post('/user/purchase-history',{user:userInfo._id,skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.history_list=result.d;checkPage();}else{alert('Get purchase history due to failed');}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.history_list.length<limit;}
$scope.nextPage=function(value){$scope.page+=value;getHistory();};$scope.close=function(){$modalInstance.dismiss('cancel');};}
$scope.togglePublicWallet=function(wallet){$http.post('/user/toggle-public-wallet',{id:wallet._id}).success(function(result){if(!result.s)return alert('Change public status failed');wallet.isPublic=!wallet.isPublic;if(wallet.isPublic){var url='https://widget.moneylover.me?wallet='+wallet._id;if(env==='dev'){url+="?mode=dev";}
$modal.open({templateUrl:'alert.html',controller:ctrlWidgetLinkDialog,resolve:{url:function(){return url}}});}}).error(function(){alert('Error From Server');});};function ctrlWidgetLinkDialog($scope,$modalInstance,url){$scope.url=url;$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.changeActivateStatus=function(userInfo){$http.post('/user/change-activate-status',{id:userInfo._id}).success(function(result){userInfo.isDeactivated=!userInfo.isDeactivated;}).error(function(){alert('Error from server');});};$scope.restoreCredit=function(userInfo){var ok=confirm("User "+userInfo.email+' will be restore credit default, are you sure?');if(ok){$http.post('/receipt/restore-default',{user:userInfo._id}).success(function(result){alert('success');}).error(function(){alert('Error from server');});}}
$scope.reactiveFinsifyManual=function(userInfo){var url="/finsify/reactive-manual";$http.post(url,{user:userInfo._id}).success(function(result){alert('success');}).error(function(){alert('Error from server');});}
$scope.fetchTransactionManual=function(wallet){var login_secret;var timestamp;if(wallet.account_type!=0){if(wallet.rwInfo){login_secret=wallet.rwInfo.secret;}else{var metadata=wallet.metadata;if(typeof wallet.metadata!='object'){metadata=JSON.parse(wallet.metadata);}
login_secret=metadata.secret;}
var url='/finsify/fetch-transaction-manual';$http.post(url,{login_secret:login_secret,timestamp:timestamp}).success(function(result){alert('Successfully');}).error(function(){alert('Error from server');});}else{alert('Warning: This is a local wallet');}};});}(angular));(function($a){'use strict';$a.module('ML').controller('invited',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=2;$rootScope.MLPageDetail='Sync';$scope.listInvite=[];$scope.indexList=0;$scope.invStatus=0;var page=1;function getInviteSync(limit,cb,keyword){var postData={status:$scope.invStatus,limit:limit.limit,skip:limit.skip,keyword:keyword};$http.post('/invited/list',postData).success(function(data,err){cb(data);}).error(function(data,err){alert('Error');});}
function updateInviteSync(info,cb){$http.post('/invited/update',info).success(function(data){cb(data);}).error(function(){alert('Error');});}
$scope.search=function(){var limit={limit:50,skip:0};page=1;var keyword=this.keyword;$scope.invStatus=this.invStatus;getInviteSync(limit,function(data){if(data.error)alert('Error');else{$scope.indexList=0;$scope.listInvite=data.data;}},keyword);};$scope.nextPage=function(number){page+=number;if(page<2)page=1;var newSkip=(page-1)*50;var limit={limit:50,skip:newSkip};var keyword=this.keyword;getInviteSync(limit,function(data){if(data.error)alert('Error');else{$scope.indexList=newSkip;$scope.listInvite=data.data;}},keyword);};$scope.get=function(){var limit={limit:50,skip:0};page=1;$scope.status=0;this.keyword='';getInviteSync(limit,function(data){if(data.error)alert('Error');else{$scope.indexList=0;$scope.listInvite=data.data;}});};$scope.update=function(inviteInfo,status){var s=confirm('Bấm OK/Đồng ý để tiếp tục');if(s){var infoUpdate={inviteInfo:inviteInfo,status:status};$http.post('/invited/update',infoUpdate).success(function(data){$scope.listInvite.forEach(function(invite,key){if(invite===inviteInfo){$scope.listInvite.splice(key,1);}});}).error(function(){alert('Error');});}};})}(angular));(function($a){'use strict';$a.module('ML').controller('ItemChart',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=8;$rootScope.MLPageDetail='Purchase item chart';$scope.mode='Daily';var productList={};var totalData=[];var totalChart;var productData=[];var productChart;var platformData=[];var platformChart;$scope.selectedProduct=null;$scope.totalEndTime=moment().format('DD/MM/YYYY');$scope.totalStartTime=moment().subtract(7,'days').format('DD/MM/YYYY');$scope.selectedProduct=null;$scope.topTenEndTime=moment().format('DD/MM/YYYY');$scope.topTenStartTime=moment().subtract(7,'days').format('DD/MM/YYYY');$scope.selectViewMode=function(mode){if(mode!==$scope.mode){$scope.mode=mode;init();}};$scope.selectProduct=function(){var modalInstance=$modal.open({templateUrl:'/partials/item_chart/select_product.html',controller:ctrlSelectProduct,resolve:{startDate:function(){return $scope.totalStartTime;},endDate:function(){return $scope.totalEndTime;}}});modalInstance.result.then(function(selectedProduct){$scope.selectedProduct=selectedProduct;});};function getTotal(){$http.post('/item-chart/total',{start:$scope.totalStartTime,end:$scope.totalEndTime,mode:$scope.mode}).success(function(result){if(!result.status){return alert('Get total failed');}
totalData=result.data;if(totalChart){totalChart.setData(totalData);}else{totalChart=new Morris.Area({element:'turnover_total',data:totalData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['amount'],labels:['USD'],lineColors:['#379ca8']});}}).error(function(){alert('Error from server');});}
function getTopTen(startTime,endTime){$scope.loadingTopTenProduct=true;$http.post('/item-chart/top-purchase',{start:startTime,end:endTime}).success(function(result){$scope.loadingTopTenProduct=false;if(!result.status)return alert('Get top 10 product failed');$scope.topTenData=result.data;}).error(function(){$scope.loadingTopTenProduct=false;alert('Error from server');});}
function getTopByCountry(startTime,endTime){$scope.loadingTopCountry=true;$http.post('/item-chart/top-country',{start:startTime,end:endTime}).success(function(result){$scope.loadingTopCountry=false;if(!result.status)return alert('Get top country failed');var countryList=Object.keys(result.data);var data=[];countryList.forEach(function(country){data.push({country:country,amount:result.data[country]});});data.sort(function(a,b){return b.amount-a.amount;});$scope.topCountry=data;}).error(function(){$scope.loadingTopCountry=false;alert('Error from server');});}
function getTotalGroupByProductType(){$http.post('/item-chart/total-by-type',{start:$scope.totalStartTime,end:$scope.totalEndTime,mode:$scope.mode}).success(function(result){if(!result.status)return alert('Get chart data failed');var keys=Object.keys(result.data[0]);keys.forEach(function(key,index){if(key==='date'){return keys.splice(index,1);}});if(productChart){productChart.setData(result.data);}else{productChart=new Morris.Area({element:'turnover_product',data:result.data,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:keys,labels:keys,lineColors:['#EF5350','#EC407A','#AB47BC','#7E57C2','#5C6BC0']});}}).error(function(){});}
function getTotalGroupByPlatform(){$http.post('/item-chart/total-by-platform',{start:$scope.totalStartTime,end:$scope.totalEndTime,mode:$scope.mode}).success(function(result){if(!result.status)return alert('Get chart data failed');platformData=result.data;if(platformChart){platformChart.setData(result.data);}else{platformChart=new Morris.Area({element:'turnover_platform',data:platformData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['iOS','Android','Windows'],labels:['iOS','Android','Windows'],lineColors:['#EF5350','#EC407A','#AB47BC']});}}).error(function(){alert('Error from server');});}
function ctrlSelectProduct($scope,$modalInstance,startDate,endDate){$scope.productList=[];function getIcon(){if(productList.icon&&productList.icon.length>0){return $scope.productList=productList.icon;}
$http.post('/icons/get',{}).success(function(result){if(result.error)return alert('Get icon list failed');productList.icon=result.data;$scope.productList=result.data;}).error(function(){alert('Error from server');});}
function getCredit(){if(productList.credit&&productList.credit.length>0){return $scope.productList=productList.credit;}
$http.post('/use-credits/list',{skip:0,limit:99}).success(function(result){if(!result.s)return alert('Get credit product list failed');$scope.productList=result.d;productList.credit=result.d;}).error(function(){alert('Error from server');});}
function getPremium(){if(productList.premium&&productList.premium.length>0){return $scope.productList=productList.premium;}
$http.post('/premium-products/list',{skip:0,limit:99}).success(function(result){if(!result.s)return alert('Get product list failed');$scope.productList=result.d;productList.premium=result.d;}).error(function(){alert('Error from server');});}
function getSubscription(){if(productList.subscription&&productList.subscription.length>0){return $scope.productList=productList.subscription;}
$http.post('/premium-products/list',{skip:0,limit:99}).success(function(result){if(!result.s)return alert('Get product list failed');$scope.productList=result.d;productList.subscription=result.d;}).error(function(){alert('Error from server');});}
$scope.getProduct=function(productType){switch(productType){case'icon':getIcon();break;case'premium':getPremium();break;case'credit':getCredit();break;case'subscription':getSubscription();break;default:break;}};$scope.showProductChart=function(productId){$http.post('/item-chart/by-product',{start:startDate,end:endDate,product_id:productId}).success(function(result){if(!result.status)return alert('Get turnover by product failed');productData=result.data;if(productChart){productChart.setData(productData);}else{productChart=new Morris.Area({element:'turnover_product',data:productData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['amount'],labels:['USD'],lineColors:['#379ca8']});}
$modalInstance.close(productId);}).error(function(){alert('Error from server');});};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}
$scope.selectDateRange=function(){var modalInstance=$modal.open({templateUrl:'/partials/item_chart/select_date_range.html',controller:ctrlSelectDateRange,resolve:{}});modalInstance.result.then(function(date){$scope.topTenStartTime=date.startTime;$scope.topTenEndTime=date.endTime;});};function ctrlSelectDateRange($scope,$modalInstance){$scope.selectDate=function(){if(this.startDate>this.endDate){return alert('Start date must less than or equal end date');}
var startTime=moment(this.startDate.valueOf()).format('DD/MM/YYYY');var endTime=moment(this.endDate.valueOf()).format('DD/MM/YYYY');getTopTen(startTime,endTime);$modalInstance.close({startTime:startTime,endTime:endTime});};$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
function init(){if($scope.mode==='Daily'){$scope.totalEndTime=moment().format('DD/MM/YYYY');$scope.totalStartTime=moment().subtract(7,'days').format('DD/MM/YYYY');$scope.topTenEndTime=moment().format('DD/MM/YYYY');$scope.topTenStartTime=moment().subtract(7,'days').format('DD/MM/YYYY');}else if($scope.mode==='Weekly'){$scope.totalEndTime=moment().format('DD/MM/YYYY');$scope.totalStartTime=moment().startOf('week').subtract(7,'weeks').format('DD/MM/YYYY');$scope.topTenEndTime=moment().format('DD/MM/YYYY');$scope.topTenStartTime=moment().startOf('week').subtract(7,'weeks').format('DD/MM/YYYY');}else{$scope.totalEndTime=moment().format('DD/MM/YYYY');$scope.totalStartTime=moment().startOf('month').subtract(7,'months').format('DD/MM/YYYY');$scope.topTenEndTime=moment().format('DD/MM/YYYY');$scope.topTenStartTime=moment().startOf('month').subtract(7,'months').format('DD/MM/YYYY');}
getTotal();getTopTen($scope.topTenStartTime,$scope.topTenEndTime);getTotalGroupByProductType();getTotalGroupByPlatform();getTopByCountry($scope.topTenStartTime,$scope.topTenEndTime);}
init();});}(angular));'use strict';(function($a){$a.module('ML').controller('ItemLog',function($scope,$rootScope,$http){$rootScope.tabSelect=8;$rootScope.MLPageDetail='Purchase item log';$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;var limit=20;$scope.listLog=[];function getData(){var skip=limit*($scope.page-1);sendRequest('/item-log/list',{skip:skip,limit:limit},function(err,data){if(err){return alert(err);}
$scope.listLog=data;checkPage();});}
function sendRequest(url,postData,callback){$scope.isLoading=true;$http.post(url,postData).success(function(result){$scope.isLoading=false;if(result.s){return callback(null,result.d);}
callback('Get data due to failed');}).error(function(){$scope.isLoading=false;callback('Error From Server');});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.listLog.length<limit;}
$scope.nextPage=function(value){$scope.page+=value;getData();};function init(){getData();}
init();});}(angular));(function($a){'use strict';$a.module('ML').controller('landingpage',function($scope,$rootScope,$modal,$routeParams,$http,$q){$rootScope.tabSelect=11;$rootScope.MLPageDetail='Landing Page Manager';$scope.landing={};$rootScope.enable=false;$rootScope.item={};$scope.$on('$viewContentLoaded',function(){$q.all([loadContent(),]).then(function(response){let loadContentResolve=response[0];$scope.landing=loadContentResolve;})})
function loadContent(){let url='/api/landing_page/loadbrowse';let deferred=$q.defer();$http({method:'POST',url:url}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.landing=response.data.data;deferred.resolve(response.data.data)}else{deferred.reject();alert('Get list url error!')}}},function errorCallback(response){deferred.reject();alert(response.status);});return deferred.promise;}
$scope.send=function(item){console.log('gia tri rootscope:',$rootScope)}
$scope.create=function(){var modalInstance=$modal.open({templateUrl:'/partials/landing_page/create.html',controller:ctrlCreate,resolve:{landing:function(){return $scope.landing;}}});modalInstance.result.then(function(data){});};function ctrlCreate($scope,$modalInstance,landing){$scope.init=function(){$scope.Lists=[{name:"finsify.com",status:1},{name:"moneylover.me",status:1},{name:"moneylover.vn",status:1}];$scope.landing=landing;}();$scope.save=function(landing){let url='/api/landing_page/create';let params={subdomain:landing.subdomain,domain:landing.domain,url:landing.url,folder:landing.folder,status:'Pending',}
$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){$modalInstance.close(response.data.data);loadContent()}}},function errorCallback(response){alert(response.status)})}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};}})}(angular));(function($a){'use strict';$a.module('ML').controller('LogSync',function($scope,$http,$rootScope){$rootScope.tabSelect=3;$rootScope.MLPageDetail="Client Sync Fail Log";$scope.logs=[];$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.searchMode=false;var limit=30;function getLog(){var skip=limit*($scope.page-1);$http.post('/logsync/get',{limit:limit,skip:skip}).success(function(result){if(result.s){$scope.logs=result.d;checkPage();}
else alert("Getting Log Failed");}).error(function(){alert("Error From Server");});}
getLog();function checkPage(){$scope.isFirstPage=($scope.page===1);$scope.isLastPage=($scope.logs.length<limit);}
function search(keyword,skip,limit){$http.post('/logsync/get-by-email',{email:keyword,skip:skip,limit:limit}).success(function(result){if(result.s){$scope.searchMode=true;$scope.logs=result.d;checkPage();}else alert("Finding Log Failed");}).error(function(){alert("Error From Server");});}
$scope.search=function(keyword){if(keyword){$scope.page=1;search(keyword,0,limit);}};$scope.searchKey=function(event,keyword){var keyCode=window.event?event.keyCode:event.which;if(keyCode===13)$scope.search(keyword);};$scope.backToListMode=function(){$scope.searchMode=false;$scope.keyword=null;$scope.page=1;getLog();};$scope.nextPage=function(value){$scope.page+=value;if($scope.keyword&&$scope.searchMode){var skip=limit*($scope.page-1);search($scope.keyword,skip,limit);}else getLog();};});}(angular));(function($a){'use strict';$a.module('ML').controller('LogSyncDetail',function($scope,$http,$routeParams,$rootScope){$rootScope.tabSelect=3;$rootScope.MLPageDetail="Client Sync Fail Log Detail";$scope.info={};getInfo($routeParams.id);function getInfo(id){$http.post('/logsync/get-by-id',{id:id}).success(function(result){if(result.s)$scope.info=result.d;else alert("Getting Log Failed");}).error(function(){alert("Error From Server");});}});}(angular));(function($a){'use strict';$a.module('ML').controller('lucky',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Lucky Item Manager';$scope.itemList=[];getAll();function getAll(){$http.post('/lucky/get-item',{}).success(function(data){if(data.s)$scope.itemList=data.d;else alert("Get Item Failed");}).error(function(){alert('Error From Server');});}
$scope.getAll=getAll;$scope.addNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/lucky/add.html',controller:ctrlAdd,resolve:{}});modalInstance.result.then(function(newItem){$scope.itemList.push(newItem);},function(){});};var ctrlAdd=function($scope,$modalInstance){$scope.error={show:false,message:''};getProductId();function getProductId(){$http.post('/lucky/get-product',{}).success(function(data){if(data.s)$scope.products=data.d;}).error(function(){alert("Error from Server");});}
function validateItem(item){if(isNaN(item.remain)){return false;}else{if(item.remain<0){return false;}}
if(isNaN(item.drop)){return false;}else{if(item.drop<0||item.drop>10000){return false;}}
return true;}
$scope.save=function(item){item.remain=parseInt(item.remain);item.drop=parseInt(item.drop);if(item.startDate)item.startDate=moment(item.startDate);if(item.expireDate)item.expireDate=moment(item.expireDate);if(validateItem(item)){$http.post('/lucky/add-new',item).success(function(data){if(data.s){getAll();}else{$scope.error.show=true;$scope.error.message='Add new item failed';}}).error(function(){$scope.error.show=true;$scope.error.message='Error From Server';});}else{$scope.error.show=true;$scope.error.message='Please type exactly the item info!';}};$scope.cancel=function(){$modalInstance.dismiss('cancel');}}});}(angular));(function($a){'use strict';$a.module('ML').controller('macBeta',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Mac Beta';$scope.editMode=false;function getVersion(){$http.get('/mac-beta/get-version').success(function(data){if(data.s){$scope.macInfo=data.d;}else $scope.macInfo=null;}).error(function(){alert("Error From Server");})}
getVersion();$scope.editOn=function(){$scope.editMode=true;};$scope.save=function(macInfo){console.log(macInfo);$http.post('/mac-beta/update-version',macInfo).success(function(result){if(result.s)$scope.editMode=false;else alert("Save Failed");}).error(function(){alert("Error From Server");})};})}(angular));(function($a){'use strict';$a.module('ML').controller('pushMessageReport',function($scope,$http,$rootScope,$location,$modal){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Notifications Report';$scope.session={};$scope.stat={};$scope.isStatLoading=false;var query=$location.search();function getSession(id){$http.post('/message/get-one-session',{id:id}).success(function(result){if(result.s){$scope.session=result.d;}else{alert("Get notification info failed");}}).error(function(){alert("Error From Server");});}
getSession(query.id);function getNotificationStat(id){$scope.isStatLoading=true;$http.post('/message/report',{id:id}).success(function(result){$scope.isStatLoading=false;if(result.s){$scope.stat=result.d;}else{alert("Get notification stat failed");}}).error(function(){$scope.isStatLoading=false;alert("Error From Server");})}
getNotificationStat(query.id);$scope.userListReport=function(mode){var modalInstance=$modal.open({templateUrl:'/partials/messages/user-list-report.html',controller:ctrlUserListReport,resolve:{session:function(){return $scope.session;},mode:function(){return mode;}}});};var ctrlUserListReport=function($scope,$modalInstance,session,mode){var limit=10;$scope.mode=mode;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.isLoading=false;$scope.users=[];$scope.deviceLogs=[];$scope.session=session;getData($scope.mode);function checkFirstLastPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.users.length<limit;}
var getDevice=function(user){$http.get('/info/device/'+user._id).success(function(data){if(data&&data!==false&&data!=='false'){data.forEach(function(device){if(device.platform===1){if(!user.hasAndroid){user.hasAndroid=true;}}else if(device.platform===2){if(!user.hasIos){user.hasIos=true;}}else if(device.appId===5){if(!user.hasWindows){user.hasWindows=true;}}else if(device.appId===4){if(!user.hasWp){user.hasWp=true;}}else if(device.platform===6){if(!user.hasOsx){user.hasOsx=true;}}else if(device.platform===7){if(!user.hasWeb){user.hasWeb=true;}}});}}).error(function(){alert("Error from server");});};var getCountry=function(user){if(user.tags){user.tags.forEach(function(tag){if(tag.indexOf('country')!==-1){user.flag=tag.split(':')[1];}});}};$scope.detectSocial=function(userTags){if(!userTags)return null;if(userTags.indexOf('facebook')!=-1)return'facebook';if(userTags.indexOf('google')!=-1)return'google';};function getOpened(sessionId,page){var skip=limit*(page-1);$scope.isLoading=true;$http.post('/message/opened-by-push-session',{id:sessionId,limit:limit,skip:skip}).success(function(result){$scope.isLoading=false;if(result.s){$scope.deviceLogs=result.d;checkFirstLastPage();}
else alert("Getting opened users failed");}).error(function(){$scope.isLoading=false;alert("Error from server");})}
function getError(sessionId,page){$scope.isLoading=true;var skip=limit*(page-1);$http.post('/message/error-by-push-session',{id:sessionId,skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.deviceLogs=result.d;}
else alert("Getting error users failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
function getData(mode,page){if(mode==='Opened')getOpened(session._id,page);else getError(session._id,page);}
$scope.nextPage=function(value){$scope.page+=value;getData($scope.mode,$scope.page);};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};});}(angular));(function($a){'use strict';$a.module('ML').controller('messages',function($scope,$rootScope,$location,Page,$http,$modal){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Push Notifications';$scope.listMsg=[];var REGEX=/^[^ -]+$/g;function validateCa(campaign){return campaign.match(REGEX);}
function randomString(len){function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
var buf=[],chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',charlen=chars.length;for(var i=0;i<len;++i){buf.push(chars[getRandomInt(0,charlen-1)]);}
return buf.join('');}
$scope.optionMsg=[{id:'dId_1',name:'Android',device:[{name:'Kitkat',version:'4.4 - 4.4.2',api:19},{name:'Jelly Bean',version:'4.3.x',api:18},{name:'Jelly Bean',version:'4.2.x',api:17},{name:'Jelly Bean',version:'4.1.x',api:16},{name:'Ice Cream Sandwich',version:'4.0.3 - 4.0.4',api:15},{name:'Ice Cream Sandwich',version:'4.0.1 - 4.0.2',api:14},{name:'Honeycomb',version:'3.2.x',api:13},{name:'Honeycomb',version:'3.1',api:12},{name:'Honeycomb',version:'3.0',api:11}]},{id:'dId_2',name:'iOS'},{id:'dId_3',name:'Winphone/Windows'}];$scope.getList=function(){this.searchKeyword='';$http.post('/message/get',{}).success(function(data){if(data.err)alert(data.msg);else $scope.listMsg=data.data;}).error(function(){alert('Error');});};$scope.deleteMessage=function(mess,index){var yn=confirm("Are you sure?");if(yn){$http.post('/message/delete',{messid:mess._id}).success(function(data){if(data)$scope.listMsg.splice(index,1);else alert("Delete message error");}).error(function(){alert('Error');});}};$scope.editMessage=function(mess){var oldMsg=mess;if(oldMsg&&oldMsg.option&&oldMsg.option.ca){oldMsg.campaign=oldMsg.option.ca;}
if(oldMsg&&oldMsg.option&&oldMsg.option.group){oldMsg.group=oldMsg.option.group;}
var modalInstance=$modal.open({templateUrl:'/partials/messages/message.html',controller:createNew,resolve:{msgInfo:function(){return oldMsg;},listMsg:function(){return $scope.listMsg;},optionMsg:function(){return $scope.optionMsg;},mode:function(){return"Edit";}}});modalInstance.result.then(function(){$scope.getList();},function(){});};$scope.sendMessage=function(mess,mode){var modalInstance=$modal.open({templateUrl:'/partials/messages/send.html',controller:ctrlSend,resolve:{message:function(){return mess;},mode:function(){return mode;}}});};$scope.createNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/messages/message.html',controller:createNew,resolve:{msgInfo:function(){return{};},listMsg:function(){return $scope.listMsg;},optionMsg:function(){return $scope.optionMsg;},mode:function(){return"Add";}}});modalInstance.result.then(function(){$scope.getList();},function(){});};var createNew=function($scope,Page,$modalInstance,msgInfo,listMsg,optionMsg,mode){$scope.mode=mode;$scope.msgInfo=msgInfo;$scope.optionMsg=optionMsg;$scope.optionAction=[{data:28,name:'View message'},{data:1,name:'Open PlayStore'},{data:2,name:'Login'},{data:3,name:'Open Icon Store'},{data:4,name:'Open Web'},{data:29,name:'Open Store'}];if(!msgInfo.device){$scope.msgInfo.device=[];}
$scope.platformPicked=function(deviceID){var exist=$scope.msgInfo.device.indexOf(deviceID);if(exist>-1){$scope.msgInfo.device.splice(exist,1);}else{$scope.msgInfo.device.push(deviceID);}};$scope.datePicker1=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};$scope.preview=function(){};$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.save=function(){if(this.msgInfo.campaign){if(!validateCa(this.msgInfo.campaign)){alert('Campaign invaild');return;}}
if(this.msgInfo.device.length>0){if($scope.mode=="Add"){var msgInfo=this.msgInfo;var condition={};$http.post('/message/save',{msgInfo:msgInfo,condition:condition}).success(function(data){$modalInstance.close();}).error(function(){alert('Error');});}
if($scope.mode=="Edit"){var msgInfo=this.msgInfo;$http.post('/message/update',{msgInfo:msgInfo}).success(function(data){$modalInstance.close();}).error(function(){alert('Error');});}}else{$scope.error="Please select platforms";}};};var ctrlSend=function($scope,$modalInstance,$http,message,mode){$scope.scheduled='no';$scope.sendMode='manual';$scope.pressEnter=function(event,sendMode,toList,userOption){var keyCode=window.event?event.keyCode:event.which;if(keyCode===13)$scope.send(sendMode,toList,userOption);};var getQueryList=function(){$http.post('/search-query/get',{skip:0,limit:1000}).success(function(result){if(result.s)$scope.queryList=result.d;else alert("Get query list failed");}).error(function(){alert("Error From Server");});};getQueryList();$scope.send=function(sendMode){var postData={mess:message,mode:mode};var that=this;var str=randomString(7);var ok=prompt('Are you sure? Type "'+str+'" to confirm!');if(ok!=str){return;}
if(this.scheduled==='yes'){if(!this.schedule||!this.schedule.date||!this.schedule.time){return alert('Please pick your schedule date and time!');}
postData.schedule_time=scheduleTimeParser(this.schedule.date,this.schedule.time);}
prepareData(function(err){if(err){return alert(err);}
$http.post('/message/send',postData).success(function(data){if(data.s){$scope.cancel();}
if(data.msg){alert(data.msg);}}).error(function(){alert("Error");});});function prepareData(callback){if(sendMode==='manual'){if(that.emailList){var newToList=that.emailList.split(",");newToList.forEach(function(elm,index){newToList[index]=elm.trim();});postData.send_mode=sendMode;postData.toList=newToList;callback();}}else if(sendMode==='search_query'){if(that.searchQuery){postData.send_mode=sendMode;postData.query=JSON.parse(that.searchQuery);callback();}}else if(sendMode==='csv_file'){var file=document.getElementById("csv_file").files[0];if(!file){return callback('Please select a csv file');}
readFile(function(err,mail_list){if(err){return callback(err);}
postData.send_mode=sendMode;postData.toList=mail_list;callback();});}}};$scope.cancel=function(){$modalInstance.dismiss('cancel');};function readFile(callback){var file=document.getElementById("csv_file").files[0];var mailListFromFile=[];var reader=new FileReader();reader.onload=function(e){var text=reader.result.toString();var a=text.split('\n');mailListFromFile=checkNullEmail(a);callback(null,mailListFromFile);};reader.readAsText(file,"utf-8");}};$scope.sessionList=function(message){var modalInstance=$modal.open({templateUrl:'/partials/messages/sessions.html',controller:ctrlSession,resolve:{messageId:function(){return message._id;}}});modalInstance.result.then(function(){});};var ctrlSession=function($scope,$modalInstance,messageId){$scope.pushPushNotifPage=true;$scope.sessionList=[];$scope.isLoading=false;var limit=10;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;getSession(messageId,0,limit);function getSession(id,skip,limit){$scope.isLoading=true;$http.post('/message/get-push-session',{messageId:id,skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.sessionList=result.d;checkPage();}
else alert("Get session list failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.sessionList.length<limit;}
$scope.nextPage=function(value){$scope.page+=value;var skip=limit*($scope.page-1);getSession(messageId,skip,limit);};$scope.cancel=function(){$modalInstance.dismiss();};};function checkNullEmail(list){var new_list=[];list.forEach(function(email){if(email!=""){new_list.push(email);}});return new_list;}
function scheduleTimeParser(date,time){var day=date.getDate();var month=date.getMonth()+1;var year=date.getFullYear();return day+'/'+month+'/'+year+' '+time;}});}(angular));(function($a){'use strict';$a.module('ML').controller('mileStone',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Milestone';function closeModal(modalInstance){modalInstance.dismiss('cancel');}
var getMilestone=function(){$http.post('/milestone/get',{}).success(function(data){if(data.s){$scope.listMilestone=data.d;}else{alert('Get fails!')}}).error(function(){alert("Error from Server");})};getMilestone();function postMethod(data,link,listInfo){if(!data){$scope.checkRequired=true;}else{if(data.eventDate&&data.title){$http.post(link,listInfo).success(function(data){if(data.s){getMilestone();}else{alert(data.m)}}).error(function(){alert("Error from Server");})}else{$scope.checkRequired=true;}}}
$scope.addMilestone=function(){var modalInstance=$modal.open({templateUrl:'/partials/setting/enterMilestone.html',controller:ctrlMilestone,});}
var ctrlMilestone=function($scope,$modalInstance){$scope.createPage=true;$scope.cancel=function(){closeModal($modalInstance)};$scope.add=function(milestone){var link='/milestone/add';var listInfo={info:milestone};postMethod(milestone,link,listInfo);$scope.cancel();};};$scope.del=function(milestone){var s=confirm("Are you sure?");if(s){$http.post('/milestone/delete',{milestone:milestone}).success(function(data){if(!data.error){getMilestone();}else{alert(data.msg);}}).error(function(){alert('Error from server :(');});}};$scope.edit=function(milestone){var modalInstance=$modal.open({templateUrl:'/partials/setting/enterMilestone.html',controller:ctrlEditMilestone,resolve:{milestone:function(){return milestone;}}});};var ctrlEditMilestone=function(milestone,$scope,$modalInstance){$scope.editPage=true;$scope.thisMilestone=milestone;$scope.cancel=function(){closeModal($modalInstance)};$scope.save=function(milestoneEdited){var link='/milestone/edit';var listInfo={id:milestone._id,info:milestoneEdited};postMethod(milestoneEdited,link,listInfo);$scope.cancel();};};})}(angular));(function($a){'use strict';$a.module('ML').controller('navigation',function($scope,$rootScope,Page,$location,$http){$scope.permission=null;$scope.adminSystem=false;$scope.roles=[];var NAVIGATION_BAR={'DASHBOARD':'Dashboard','USERS':'Users','PRODUCTS':'Products','MARKETING':'Marketing','HELPDESK':'Helpdesk','SUBSCRIPTION':'Subscription','TOOLS':'Tools','RECEIPTS':'Receipts','SETTINGS':'Settings','LANDINGPAGE':'LandingPage',};var PERMISSION={'ADMIN':'Admin','DEV':'Dev','MARKETING':'Marketing','SUPPORT':'Support','VOLUNTEER':'Volunteer'};function setRole(permission){$scope.roles[NAVIGATION_BAR.DASHBOARD]=true;$scope.roles[NAVIGATION_BAR.USERS]=true;$scope.roles[NAVIGATION_BAR.PRODUCTS]=true;$scope.roles[NAVIGATION_BAR.MARKETING]=true;$scope.roles[NAVIGATION_BAR.HELPDESK]=true;$scope.roles[NAVIGATION_BAR.SUBSCRIPTION]=true;$scope.roles[NAVIGATION_BAR.TOOLS]=true;$scope.roles[NAVIGATION_BAR.RECEIPTS]=true;$scope.roles[NAVIGATION_BAR.SETTINGS]=true;$scope.roles[NAVIGATION_BAR.LANDINGPAGE]=true
switch(permission){case PERMISSION.ADMIN:break;case PERMISSION.DEV:break;case PERMISSION.MARKETING:$scope.roles[NAVIGATION_BAR.DASHBOARD]=true;$scope.roles[NAVIGATION_BAR.USERS]=false;$scope.roles[NAVIGATION_BAR.PRODUCTS]=false;$scope.roles[NAVIGATION_BAR.MARKETING]=true;$scope.roles[NAVIGATION_BAR.HELPDESK]=false;$scope.roles[NAVIGATION_BAR.SUBSCRIPTION]=false;$scope.roles[NAVIGATION_BAR.TOOLS]=false;$scope.roles[NAVIGATION_BAR.RECEIPTS]=false;$scope.roles[NAVIGATION_BAR.SETTINGS]=false;$scope.roles[NAVIGATION_BAR.LANDINGPAGE]=true;break;case PERMISSION.SUPPORT:$scope.roles[NAVIGATION_BAR.DASHBOARD]=true;$scope.roles[NAVIGATION_BAR.USERS]=true;$scope.roles[NAVIGATION_BAR.PRODUCTS]=false;$scope.roles[NAVIGATION_BAR.MARKETING]=false;$scope.roles[NAVIGATION_BAR.HELPDESK]=true;$scope.roles[NAVIGATION_BAR.SUBSCRIPTION]=false;$scope.roles[NAVIGATION_BAR.TOOLS]=false;$scope.roles[NAVIGATION_BAR.RECEIPTS]=false;$scope.roles[NAVIGATION_BAR.SETTINGS]=false;$scope.roles[NAVIGATION_BAR.LANDINGPAGE]=true;break;case PERMISSION.VOLUNTEER:$scope.roles[NAVIGATION_BAR.DASHBOARD]=true;$scope.roles[NAVIGATION_BAR.USERS]=false;$scope.roles[NAVIGATION_BAR.PRODUCTS]=false;$scope.roles[NAVIGATION_BAR.MARKETING]=false;$scope.roles[NAVIGATION_BAR.HELPDESK]=false;$scope.roles[NAVIGATION_BAR.SUBSCRIPTION]=false;$scope.roles[NAVIGATION_BAR.TOOLS]=false;$scope.roles[NAVIGATION_BAR.RECEIPTS]=true;$scope.roles[NAVIGATION_BAR.SETTINGS]=false;$scope.roles[NAVIGATION_BAR.LANDINGPAGE]=true;break;default:break;}}
$rootScope.$on('adminPermission',function(event,data){$scope.permission=data.data.permission;$scope.adminSystem=data.data.adminSystem;setRole($scope.permission);});$scope.tab=function(tabs){this.tabSelect=tabs;};var checkEnv=function(){if(env!=='production'){$a.element(document).find('#backend_logo').attr('style','background-color: #d35400;');}};var loadContent=function(){$http.get("/changelog.txt").success(function(response){var no=response.trim().split(' ');$scope.currentVersion=no[3];}).error(function(){alert("Error load changelog");});};checkEnv();loadContent();})}(angular));(function($a){$a.module('ML').controller('notification-center',function($scope,$http,notificationService){$scope.notifications=[];var limit=20;var MESSAGE_TEMPLATE={ISSUE_ASSIGNED:"Bạn vừa được Assign vào một Issue",ISSUE_REPLY:"User vừa trả lời vào Issue bạn đang hỗ trợ",CSV_DOWNLOAD:"CSV File đã sẵn sàng để download",PUSH_NOTIFICATION_COMPLETE:"Push Notification đã hoàn thành"};var tabIsActive=true;$a.element(window).bind('focus',function(){tabIsActive=true;}).bind('blur',function(){tabIsActive=false;});function getNotification(){$http.post('/notification/get',{skip:0,limit:limit}).success(function(result){if(result.s){$scope.notifications=result.d.notification;notificationService.clearNotification();notificationService.updateNotification(result.d.news);}}).error(function(){alert('Error from Server');});}
function notifyMe(message,url){if(!tabIsActive)return;if(!Notification){alert("Your browser is not supported!");return;}
if(Notification.permission!=="granted"){Notification.requestPermission();}else{var notification=new Notification("Money Lover NSFW",{icon:'/images/logo2.png?v=1',body:message});notification.onclick=function(){window.open(url);}}}
var listenSocket=function(){var adminId=document.getElementById("adminId").value;var socket=io('https://socket.moneylover.me/');var room='/backend/notification/admin/'+adminId;socket.on(room,function(message){var parsedMessage=JSON.parse(message);if(parsedMessage.type==='helpdesk_issue'){notifyMe(MESSAGE_TEMPLATE.ISSUE_ASSIGNED,parsedMessage.url);}else if(parsedMessage.type==='helpdesk_issue_reply'){notifyMe(MESSAGE_TEMPLATE.ISSUE_REPLY,parsedMessage.url);}else if(parsedMessage.type==='csv_export'){notifyMe(MESSAGE_TEMPLATE.CSV_DOWNLOAD,parsedMessage.url);}else if(parsedMessage.type==='backend_push'){notifyMe(parsedMessage.content,parsedMessage.url);}
getNotification();});};$scope.deleteNotify=function(index,id){$http.post('/notification/delete-one',{nId:id}).success(function(result){if(result.s)$scope.notifications.splice(index,1);else $scope.notifications.splice(index,1);}).error(function(){alert('Error From Server');});};$scope.close=function(){var notibar=document.getElementById('noticenter');notibar.className='notification-center';$http.post('/notification/mark-all-as-read',{}).success(function(result){if(result.s){notificationService.clearNotification();getNotification();}
else notificationService.clearNotification();}).error(function(){alert('Error From Server');});};$scope.clearAll=function(){$http.post('/notification/delete-all',{}).success(function(result){if(result.s)$scope.notifications=[];else $scope.notifications=[];}).error(function(){alert('Error From Server');})};listenSocket();getNotification();})}(angular));(function($a){'use strict';$a.module('ML').controller('NotificationFail',function($scope,$http,$rootScope){var limit=20;function getList(skip,limit){$http.post('/notification-fail/list',{skip:skip,limit:limit}).success(function(result){console.log(result);}).error(function(){alert("Error From Server");});}
getList(0,limit);});}(angular));(function($a){'use strict';$a.module('ML').controller('openedlog',function($scope,$rootScope,$http){$rootScope.tabSelect=1;$rootScope.MLPageDetail='App open log';$scope.listLog=[];$scope.appVersion=["Android","iOS Free","iOS Plus","Windows Phone","Windows"];$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;var limit=50;var checkFirstLastPage=function(){if($scope.page==1){$scope.isFirstPage=true;}else{$scope.isFirstPage=false;}
if($scope.listLog.length<limit){$scope.isLastPage=true;}else $scope.isLastPage=false;};checkFirstLastPage();var getLog=function(l,s){$http.post('/openedlog/getlist',{limit:l,skip:s}).success(function(data,err){if(data.s){$scope.listLog=data.data;checkFirstLastPage();}else{alert('Get List Error');}}).error(function(data){alert("Error From Server");})};$scope.getList=function(){$scope.page=1;getLog(limit,0);};$scope.nextPage=function(p){$scope.page+=p;var skip=limit*($scope.page-1);getLog(limit,skip);};$scope.clearList=function(){var ok=confirm("Are you SURE?");if(ok){$http.post('/openedlog/clear',{ok:"ok clear"}).success(function(data,status){if(data.s){$scope.getList();}else{alert("failed");}}).error(function(data){alert("Error from server");});}};})}(angular));(function($a){'use strict';$a.module('ML').controller('Partners',function($scope,$rootScope,$http,$modal){$rootScope.MLPageDetail='Partner Manager';$rootScope.tabSelect=3;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.partnerList=[];$scope.isLoading=false;var limit=20;var getPartnerList=function(skip,limit){$scope.isLoading=true;$http.post('/partners/get',{skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.partnerList=result.d;checkPage();}else{alert("Get list failed");}}).error(function(){$scope.isLoading=false;alert("Error from Server");});};var checkPage=function(){$scope.isFirstPage=($scope.page===1);$scope.isLastPage=($scope.partnerList.length<limit);};var nextPage=function(value){$scope.page+=value;var skip=limit*($scope.page-1);getPartnerList(skip,limit);};var addPartner=function(){var modalInstance=$modal.open({templateUrl:'/partials/partners/info.html',controller:ctrlPartnerInfo,resolve:{mode:function(){return"add";},partnerInfo:function(){return{};}}});modalInstance.result.then(function(){$scope.page=1;getPartnerList(0,limit);});};var openPartnerDetail=function(partner){var modalInstance=$modal.open({templateUrl:'/partials/partners/info.html',controller:ctrlPartnerInfo,resolve:{mode:function(){return"edit";},partnerInfo:function(){return partner;}}});modalInstance.result.then(function(){$scope.page=1;getPartnerList(0,limit);});};var ctrlPartnerInfo=function($scope,$rootScope,$http,$modalInstance,mode,partnerInfo){$scope.mode=mode;$scope.partner=partnerInfo;if($scope.partner.provider&&$scope.partner.provider.code){$scope.partner.provider=$scope.partner.provider.code;}
$scope.close=function(){$modalInstance.dismiss('cancel');};function validateData(data){if(!data)return false;if(!data.email)return false;if(!data.provider)return false;return true;}
$scope.add=function(partner){var ok=validateData(partner);if(!ok){return;}
$http.post('/partners/add',partner).success(function(result){if(result.s){$modalInstance.close();}else{alert("Add new partner due to error");}}).error(function(){alert("Error From Server");});};$scope.edit=function(partner){var ok=validateData(partner);if(!ok){return;}
$http.post('/partners/update',partner).success(function(result){if(result.s){$modalInstance.close();}else{alert("Edit partner due to error");}}).error(function(){alert("Error From Server");})};};var deletePartner=function(partner){var ok=confirm("Are you sure?");if(!ok){return;}
$http.post('/partners/remove',{partnerId:partner._id}).success(function(result){if(result.s){getPartnerList();}else{alert(result.msg);}}).error(function(){alert("Error From Server");});};getPartnerList(0,limit);$scope.nextPage=nextPage;$scope.addPartner=addPartner;$scope.openPartnerDetail=openPartnerDetail;$scope.deletePartner=deletePartner;});}(angular));(function($a){$a.module('ML').controller('PremiumProducts',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=8;$rootScope.MLPageDetail='Premium products';$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;var limit=20;$scope.listProduct=[];function sendRequest(url,postData,callback){$scope.isLoading=true;$http.post(url,postData).success(function(result){if(result.s){return callback(null,result.d);}
callback('Request due to failed');}).error(function(){$scope.isLoading=false;callback('Error From Server');});}
function getList(){var skip=limit*($scope.page-1);sendRequest('/premium-products/list',{skip:skip,limit:limit},function(err,data){if(err){return alert(err);}
$scope.listProduct=data;checkPage();});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.listProduct.length<limit;$scope.noResult=$scope.listProduct.length===0;}
function validateInfo(data){if(!data.name)return false;if(!data.product_id)return false;if(!data.type)return false;if(!data.price_gl)return false;if(!data.price_vn)return false;return true;}
function aliasParser(data){var output=[];if(typeof data==='string'){data=data.split(',');}
data.forEach(function(element){if(element){output.push(element);}});return output;}
$scope.nextPage=function(value){$scope.page+=value;getList();};$scope.create=function(){var modalInstance=$modal.open({templateUrl:'/partials/premium_products/info.html',controller:ctrlCreate,resolve:{}});modalInstance.result.then(function(){getList();});};function ctrlCreate($scope,$modalInstance){$scope.submit=function(){if(!validateInfo(this.info)){return alert('Please fill all required fields');}
this.info.type=parseInt(this.info.type);var metadata=[];if(this.info.type===6){if(!this.metadata||!this.metadata.platform||!this.metadata.script){return alert('Please fill all required fields');}
metadata.push('platform:'+this.metadata.platform);metadata.push('script:'+this.metadata.script);}
if(this.info.alias){this.info.alias=aliasParser(this.info.alias);}
this.info.metadata=metadata.toString();sendRequest('/premium-products/create',this.info,function(err){if(err){alert(err);}
$modalInstance.close();});};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}
$scope.edit=function(product){var modalInstance=$modal.open({templateUrl:'/partials/premium_products/info.html',controller:ctrlEdit,resolve:{product:function(){return product;}}});modalInstance.result.then(function(){});};function ctrlEdit($scope,$modalInstance,product){$scope.info=product;$scope.metadata={platform:null,script:null,discount:0};if(product.type==6&&product.metadata){var metadata=product.metadata.split(',');metadata.forEach(function(data){if(data.indexOf('platform:')>-1){$scope.metadata.platform=data.split(':')[1];}else if(data.indexOf('script:')>-1){$scope.metadata.script=data.split(':')[1];}else if(data.indexOf('discount')>-1){$scope.metadata.discount=data.split(':')[1];}});}
$scope.submit=function(){this.info.type=parseInt(this.info.type);var metadata=[];if(this.info.type===6){if(!this.metadata||!this.metadata.platform||!this.metadata.script){return alert('Please fill all required fields');}
metadata.push('platform:'+this.metadata.platform);metadata.push('script:'+this.metadata.script);}
if(this.info.alias){this.info.alias=aliasParser(this.info.alias);}
metadata.push('discount:'+this.info.discount);this.info.metadata=metadata.toString();sendRequest('/premium-products/edit',{product:this.info},function(err){if(err){getList();return alert(err);}
$modalInstance.close();});};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}
$scope.changePublic=function(product){product.isPublic=!product.isPublic;sendRequest('/premium-products/edit',{product:product},function(err){if(err){return alert(err);}});};$scope.changeTopDownload=function(product){product.isTopDownload=!product.isTopDownload;sendRequest('/premium-products/edit',{product:product},function(err){if(err){return alert(err);}});}
$scope.delete=function(product){sendRequest('/premium-products/delete',{product_id:product._id},function(err){if(err){return alert(err);}
getList();});};function init(){getList();}
init();});}(angular));(function($a){'use strict';$a.module('ML').controller('premiumlog',function($scope,$rootScope,$http){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Admin log';$scope.displaySearch=false;$scope.listLog=[];var searchMode=[{value:0,title:"Tìm theo admin"},{value:1,title:"Tìm theo email"}];$scope.searchMode=searchMode[0];$scope.isFirstPage=true;$scope.isLastPage=true;$scope.page=1;var limit=100;checkFirstLastPage();function getLog(l,s){$http.post('/premiumlog/getlist',{limit:l,skip:s}).success(function(data){if(data.s){$scope.listLog=data.d;checkFirstLastPage();}else{alert(data.msg);}}).error(function(data){alert("Error From Server");})}
function checkFirstLastPage(){if($scope.page==1){$scope.isFirstPage=true;}else{$scope.isFirstPage=false;}
if($scope.listLog.length<limit){$scope.isLastPage=true;}else $scope.isLastPage=false;}
function searchPage(){$scope.isFirstPage=true;$scope.isLastPage=true;}
function search(keyword,callback){var url='';if($scope.searchMode.value===0){url='/premiumlog/search-admin';}else{url='/premiumlog/search-email';}
$http.post(url,{keyword:keyword}).success(function(data){callback(data);}).error(function(data){callback(false);})}
$scope.getList=function(){$scope.page=1;getLog(limit,0);};$scope.searchKey=function(event,keyword){var keyCode=window.event?event.keyCode:event.which;if(keyCode===13)$scope.search(keyword);};$scope.search=function(keyword){search(keyword,function(data){if(data){if(data.s){if(data.d.length>0){$scope.listLog=data.d;searchPage();}
else
alert("No result");}else{alert(data.msg);}}else{alert("Error From Server");}})};$scope.clearList=function(){var ok=confirm("Are you SURE????");if(ok){$http.post('/premiumlog/clear',{ok:"ok clear"}).success(function(data){if(data.s){$scope.getList();}else{alert("failed");}}).error(function(data){alert('Error From Server');})}};$scope.selectSearchMode=function(mode){$scope.searchMode=searchMode[mode];};$scope.nextPage=function(p){$scope.page+=p;var skip=limit*($scope.page-1);getLog(limit,skip);};})}(angular));(function($a){'use strict';$a.module('ML').controller('provider',function($scope,$rootScope,$modal,$http){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Provider';$scope.$on('$viewContentLoaded',function(){loadProvider();selectCountry();});$scope.providers=null;$scope.countries=null;$scope.provider={};$scope.noContent=false;var getCountryName=function(country_code){var country_name=null;$scope.countries.forEach(country=>{if(country.code2l===country_code){country_name=country.name;}});return country_name;}
function loadProvider(){var url='/api/provider_cache/browse';$http({method:'GET',url:url}).then(function successCallback(response){if(response.data.status===1){var provider_list=response.data.data;$scope.providers=provider_list;if($scope.providers.length<1){$scope.noContent=true;}else{$scope.noContent=false;}}},function errorCallback(response){alert("Error from server");});};function selectCountry(){var url='/api/country/browse';$http({method:'GET',url:url}).then(function successCallback(response){if(response.data.status===1){var countries=response.data.data;$scope.countries=countries;}},function errorCallback(response){alert("Error from server");});};$scope.create=function(country_code){var modalInstance=$modal.open({templateUrl:'/partials/file_provider/create_provider.html',controller:ctrlCreate,resolve:{countries:function(){return $scope.countries;},country_code:function(){return country_code;}}});modalInstance.result.then(function(data){});};function ctrlCreate($scope,$modalInstance,countries,country_code){$scope.countries=countries;$scope.provider={};$scope.createProvider=function(country_code){if(!country_code){alert('this feild is not empty');return;}
var ccode=country_code.toLowerCase();var data={country_code:ccode};var country_name=getCountryName(country_code);if(country_name){data.country_name=country_name}
var url='/api/provider_cache/create';$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.data.status===1){loadProvider()}else{alert(response.data.message);}},function errorCallback(response){alert("Error from server");});$modalInstance.close();}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.build=function(){var url='/api/provider-country-code/build';$http({method:'POST',url:url,data:{}}).then(function successCallback(response){alert(response.data.message);},function errorCallback(response){alert("Error from server");});};$scope.deleteCategory=function(provider){var param={provider:provider}
var ok=confirm("You will delete "+provider+" ,are you sure?");if(ok){var url='/api/provider_cache/delete';$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status===1){loadProvider();}else{alert(response.data.message);}},function errorCallback(response){alert("Error from server");});}};})}(angular));(function($a){'use strict';$a.module('ML').controller('providerCategory',function($scope,$rootScope,$http,$modal,$window,$routeParams){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Category List';$scope.countryProvider=$routeParams.provider;$window.localStorage.setItem('countryName',$scope.countryProvider);$scope.categories=null;$scope.noContent=false;$scope.$on('$viewContentLoaded',function(){loadCategory();});function loadCategory(){var url='/api/provider-category/getByCountry';var data=$routeParams.provider;$http({method:'GET',url:url,params:{countryName:data}}).then(function successCallback(response){if(response.data.status===1){$scope.categories=response.data.data;if($scope.categories.length<1){$scope.noContent=true;}else{$scope.noContent=false;}}},function errorCallback(response){alert(response);});}
$scope.create=function(){var modalInstance=$modal.open({templateUrl:'/partials/file_provider/create_category.html',controller:ctrlCreate,resolve:{}});modalInstance.result.then(function(data){});}
function ctrlCreate($scope,$modalInstance){$scope.provider={};$scope.save=function(){var country=window.localStorage.getItem('countryName');var param={};if($scope.provider.name){param.name=$scope.provider.name;}
if($scope.provider.key_name){param.key_name=$scope.provider.key_name;}
param.country=country;var url='/api/category/createCacheCategory';$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status===1){loadCategory();}else{alert(response.data.message);}},function errorCallback(response){alert(response);});$modalInstance.close();}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.edit=function(category_name){var modalInstance=$modal.open({templateUrl:'/partials/file_provider/edit_provider_category.html',controller:ctrlUpdate,resolve:{category_name:function(){return category_name;}}});modalInstance.result.then(function(data){var url='/api/category/update';var param={'newData':data.newData,'cachedData':data.cachedData};$http({method:'POST',url:url,data:{newData:param.newData,cachedData:param.cachedData}}).then(function successCallback(response){if(response.data.status===1){loadCategory();}else{alert(response.data.message);}},function errorCallback(response){alert(response);});});}
function ctrlUpdate($scope,$modalInstance,category_name){loadOldProvider($scope,category_name);$scope.update=function(provider_edit){var newData={};var category=$scope.edit.category;newData.key_name=$scope.edit.key_name;newData.category=$scope.edit.category;var cachedData={};cachedData.key_name=$scope.cloned.key_name;cachedData.category=$scope.cloned.category;$modalInstance.close({newData:newData,cachedData:cachedData});}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};}
function loadOldProvider($scope,key_name){var url='/api/provider-category/getByKeyName';var data=key_name;$http({method:'GET',url:url,params:{key_name:data}}).then(function successCallback(response){if(response.data.status===1){$scope.edit=response.data.data;$scope.cloned=angular.copy(response.data.data);}},function errorCallback(response){alert(response);});}
$scope.delete=function(category_name,country_name){var param={category_name:category_name,country_name:country_name}
var ok=confirm("You will delete "+category_name+" ,are you sure?");if(ok){var url='/api/category/delete';$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status===1){loadCategory();}else{alert(response.data.message);}},function errorCallback(response){alert(response);});}}})}(angular));(function($a){'use strict';$a.module('ML').controller('providerData',function($scope,$rootScope,$http,$modal,$window,$routeParams){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Provider List In Category';$scope.providerParam=$routeParams.categoryId;var key=$routeParams.categoryId;var countryName=$window.localStorage.getItem('countryName');$scope.countryName=countryName;$scope.categoryName=null;$scope.page=1;var limit=20;var limitPickMore=10;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.pagePickMore=1;$scope.noContent==true;var SERVICE={1:"saltedge",2:"finsify"};$scope.providers=null;$scope.$on('$viewContentLoaded',function(){loadProvider($scope.page);$scope.loadCategoryName();});function excutePage(scope){if(scope.pre_page){$scope.isFirstPage=false;}else{$scope.isFirstPage=true;}
if(scope.next_page){$scope.isLastPage=false;}else{$scope.isLastPage=true;}}
$scope.move=function(index,num){var temp=$scope.providers[index];$scope.providers[index]=$scope.providers[index+num];$scope.providers[index+num]=temp;}
$scope.loadCategoryName=function(){var url='/api/provider-category/getByKeyName';$http({method:'GET',url:url,params:{key_name:key}}).then(function successCallback(response){if(response.data.status===1){$scope.categoryName=response.data.data.category;}},function errorCallback(response){alert(response);});};function loadProvider(page){var url='/api/provider/browse';var skip=limit*(page-1);var data={key_name:key,country:countryName,skip:skip,limit:limit,page:$scope.page,type:countryName};$http({method:'GET',url:url,params:data}).then(function successCallback(response){if(response.data.status===1){$scope.providers=response.data.data;if($scope.providers.length>0){$scope.noContent=false;}else{$scope.noContent=true;}
excutePage(response.data);}},function errorCallback(response){alert(response);});};$scope.deleteProviderChoose=function(realId,categoryName){var url='/api/provider/delete';var param={realId:realId,countryName:countryName,category:categoryName};var ok=confirm("You will delete "+realId+" ,are you sure?");if(ok){$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status){loadProvider($scope.page);}else{alert(response.data.message);}},function errorCallback(response){alert('Error from server');});}}
$scope.nextPage=function(num){num=parseInt(num);$scope.page+=num;loadProvider($scope.page);}
$scope.saveProviderList=function(){var param={};if(countryName){param.country=countryName;}
param.key_name=key;var provider_id_list=[];$scope.providers.forEach(function(item){provider_id_list.push(item.realId);});param.provider_list=provider_id_list;var url='/api/provider/create';$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status===1){var landingUrl="/provider-country-code/category/"+countryName;location.href=landingUrl;}else{alert(response.data.message);}},function errorCallback(response){alert('Error from server');});};$scope.pickMoreProvider=function(){var modalInstance=$modal.open({templateUrl:'/partials/file_provider/pick_more.html',controller:ctrlPick,resolve:{}});modalInstance.result.then(function(data){});};function ctrlPick($scope,$modalInstance){$scope.pagePickMore=1;$scope.isFirstPageMore=true;$scope.isLastPageMore=true;$scope.providerPick=[];$scope.answers=[];$scope.providerChoose=[];$scope.keyword='';$scope.suggests=[];$scope.providersElse=[]
$scope.isChecked=[];var inSearchBound=[];function getProviderOld(){var url='/api/provider/browse';var data={key_name:key,country:countryName,page:1,type:countryName};$http({method:'GET',url:url,params:data}).then(function successCallback(response){if(response.data.status===1){getId(response.data.data);}},function errorCallback(response){alert(response);});};function load(page){var url='/api/provider/browse';var skip=limitPickMore*(page-1);var data={key_name:key,country:countryName,skip:skip,limit:limitPickMore,page:page,type:countryName};$http({method:'GET',url:url,params:data}).then(function successCallback(response){if(response.data.status===1){$scope.providersElse=response.data.dataElse.data;for(var provider of $scope.providersElse){inSearchBound.push(provider._id);$scope.isChecked[provider._id]=false;}
$scope.excutePageMore(response.data.dataElse);}},function errorCallback(response){alert(response);});};function getId(providerChoose){providerChoose.forEach(function(item){$scope.providerChoose.push(item.realId);});};getProviderOld();load($scope.pagePickMore);$scope.excutePageMore=function(scope){if(scope.pre_page){$scope.isFirstPageMore=false;}else{$scope.isFirstPageMore=true;}
if(scope.next_page){$scope.isLastPageMore=false;}else{$scope.isLastPageMore=true;}};$scope.nextPage=function(num){$scope.pagePickMore+=num;load($scope.pagePickMore);}
$scope.selectProvider=function(realId){if(!$scope.providerPick[realId]){$scope.providerPick[realId]=true;$scope.isChecked[realId]=true;}else{$scope.providerPick[realId]=false;$scope.isChecked[realId]=false;}}
$scope.save=function(){for(var provider in $scope.providerPick){if($scope.providerPick[provider]===true){if($scope.answers.indexOf(provider)===-1){$scope.answers.push(parseInt(provider));}}}
if($scope.answers.length>0){var arrayResultProvider=[];arrayResultProvider=$scope.providerChoose.concat($scope.answers);var url='/api/provider/create';var param={};if(countryName){param.country=countryName;}
param.key_name=key;param.provider_list=arrayResultProvider;$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status===1){$modalInstance.dismiss('cancel');loadProvider(1);}else{alert(response.data.message);}},function errorCallback(response){alert('Error from server');});}};$scope.search=function(keySearch){var url='/api/provider/search';var param={searchKey:keySearch,inSearchBound:inSearchBound,type:countryName};$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status){$scope.providersElse=response.data.data;}else{alert(response.data.message);}},function errorCallback(response){alert('Error from server');});};$scope.liveSuggest=function(keyword,event){if(keyword){var url='/api/provider/liveSearch';var param={keyword:keyword,inSearchBound:inSearchBound,type:countryName};if(event.keyCode===13){$scope.search(keyword);}else{$http({method:'POST',url:url,data:param}).then(function successCallback(response){if(response.data.status){$scope.suggests=response.data.data;}else{alert(response.data.message);}},function errorCallback(response){alert('Error from server');});}}};$scope.choose=function(name){document.getElementById("txtKeyword").value="";document.getElementById("txtKeyword").value=name;$scope.keyword=document.getElementById("txtKeyword").value;}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};};})}(angular));(function($a){'use strict';$a.module('ML').controller('purchaselog',function($scope,$rootScope,$http,$modal,$routeParams){$rootScope.tabSelect=1;$rootScope.MLPageDetail='Purchase log';var itemCode={"summer_icon_pack":1301,"office_icon_pack":1302,"icon_daily_care":1303,"xmas_icon_pack":1304,"worldcup_icon_pack_2014":1305,"summer_icon_pack_2014":1306,"icon_transport":1307,"icon_fastfood":1308,"transport_icon_pack":1310,"summer_pack":1311,"all_feature":1312,"no_ads":1313,"me.moneylover.ios.MoneyLover.pluss":1314,"me.moneylover.removeAd":1315,"icon_ml_halloween14":1316,"icon_ml_adults":1317,"icon_ml_baby":1318,"icon_ml_students":1319,"test_icon_pack":1399};var startTime=0;var endtime=new Date().getTime();var type=1;var limit=30;$scope.statsData=[];function getItemPurchased(){$http.post('/purchaselog/get-purchased-items',{}).success(function(data){if(data.items!==[])$scope.purchasedItems=data.items;}).error(function(data){alert('get item list error');});}
var formatData=function(data){if(data.length>0){data=_(data).sortBy(function(d){return d.createAt;});var newData=[];data.forEach(function(stat){if(stat&&stat.createAt){var newCreateTime=moment(stat.createAt).format('HH:mm DD/MM');newData.push({counter:stat.counter,createAt:newCreateTime});}});return newData;}else{return[];}};var mergeData=function(object){console.log(object);var newData=[];var total=object.total.d;var totalSize=total.length;var objSize=Object.keys(object).length;var objKeys=Object.keys(object);total.forEach(function(data,index){var info={};info.createAt=data.createAt;for(var i=0;i<objSize;i++){var counter=object[objKeys[i]].d[index]||0;if(counter===0)
info[objKeys[i]]=counter;else
info[objKeys[i]]=counter.counter;}
newData.push(info);});return newData;};var getStat=function(table,types,start,end,limit,callback){$http.post('/stats',{table:table,types:types,start:start,end:end,limit:limit}).success(function(data){callback(false,data);}).error(function(data){callback(true,data);});};$scope.getPurchaseLog=function(element){$http.post('/purchaselog/get-purchased-items',{}).success(function(data){if(data.items!==[]){var parallel={};parallel.total=function(cb){getStat(1300,type,startTime,endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});};data.items.forEach(function(elm,index){parallel[elm]=function(cb){getStat(itemCode[elm],type,startTime,endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});}});async.parallel(parallel,function(err,result){var newData=mergeData(result);newData=newData.reverse();var ykeys=Object.keys(itemCode);ykeys.push("total");new Morris.Line({element:element,data:newData,grid:true,parseTime:false,xkey:'createAt',ykeys:ykeys,labels:ykeys});});}}).error(function(data){alert('get item list error');});};})}(angular));(function($a){'use strict';$a.module('ML').controller('pnRequest',function($scope,$rootScope,$http){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Push Notifications Requests';$scope.listSession=[];$scope.isLoading=false;$scope.page=1;var limit=20;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.view='Pending';getRequestSessions(0,limit);function getRequestSessions(skip,limit){$scope.isLoading=true;var url='';switch($scope.view){case'Pending':url='/push-notification-request/get-pending';break;case'Accepted':url='/push-notification-request/get-accepted';break;case'Denied':url='/push-notification-request/get-denied';break;case'All':url='/push-notification-request/get-all';break;default:url='/push-notification-request/get-all';break;}
$http.post(url,{skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.listSession=result.d;checkPage();}
else if(result.e&&result.e==='permission_error'){alert("Only system admin can use this feature");}
else{alert("Get notification push request failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
$scope.accept=function(session){var ok=confirm("Are you sure?");if(ok){$scope.isLoading=true;$http.post('/push-notification-request/accept',{session:session}).success(function(result){$scope.isLoading=false;if(result.s){var skip=limit*($scope.page-1);getRequestSessions(skip,limit);}
else if(result.e&&result.e==='permission_error'){alert("Only system admin can use this feature");}
else{alert("Deny request failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}};$scope.deny=function(session){var ok=confirm("Are you sure?");if(ok){$scope.isLoading=true;$http.post('/push-notification-request/deny',{session:session}).success(function(result){$scope.isLoading=false;if(result.s){var skip=limit*($scope.page-1);getRequestSessions(skip,limit);}
else if(result.e&&result.e==='permission_error'){alert("Only system admin can use this feature");}
else{alert("Deny request failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}};$scope.remove=function(session){var ok=confirm('Are you sure?');if(ok){$scope.isLoading=true;$http.post('/push-notification-request/remove',{id:session._id}).success(function(result){$scope.isLoading=false;if(result.s){var skip=limit*($scope.page-1);getRequestSessions(skip,limit);}
else if(result.e&&result.e==='permission_error'){alert("Only system admin can use this feature");}
else{alert("Remove request failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}};$scope.viewSelect=function(view){$scope.view=view;$scope.page=1;getRequestSessions(0,limit);};function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.listSession.length<limit;}
$scope.nextPage=function(value){$scope.page+=value;var skip=limit*($scope.page-1);getRequestSessions(skip,limit);}});}(angular));(function($a,moment){'use strict';$a.module('ML').controller('queryCompare',function($scope,$rootScope,$http,$modal){$rootScope.MLPageDetail='User Search Query Compare';$rootScope.tabSelect=4;var timeLimit=15;var charts={};$scope.queries=[];$scope.results={total:[]};function init(){$scope.startDate=moment().subtract(timeLimit,'days').format('DD/MM/YYYY');$scope.endDate=moment().format('DD/MM/YYYY');}
var processData=function(rawData){var data=[];rawData.forEach(function(queryResult){var tempData={};queryResult.forEach(function(dailyResult){tempData[dailyResult.key_as_string]=dailyResult.doc_count;});data.push(tempData);});return data;};var mergeData=function(timeCell,rawData){var data=processData(rawData);timeCell.forEach(function(dayCell){data.forEach(function(queryResult,resultIndex){if(queryResult[dayCell.Day]){dayCell[resultIndex+1]=queryResult[dayCell.Day];}else{dayCell[resultIndex+1]=0;}});});return timeCell;};var generateTimeCell=function(startDate,endDate){var data=[];var sd=moment(startDate,'DD/MM/YYYY').startOf('day');var ed=moment(endDate,'DD/MM/YYYY').startOf('day');while(!sd.isSame(ed)){var date=sd.format('DD-MM-YYYY');var item={Day:date};data.push(item);sd.add(1,'days');}
data.push({Day:ed.format('DD-MM-YYYY')});return data;};var handleData=function(rawData){var timeCell=generateTimeCell($scope.startDate,$scope.endDate);timeCell=mergeData(timeCell,rawData);return timeCell;};var renderChart=function(element,data,queryAmount){var ykeys=[];var labels=[];for(var i=1;i<=queryAmount;i++){ykeys.push(i);labels.push('Query '+i+' users');}
if(charts[element]){charts[element].setData(data);}else{charts[element]=new Morris.Area({element:element,data:data,grid:true,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'Day',ykeys:ykeys,labels:labels});}};var generateChart=function(data,queryAmount){var chartData=handleData(data);renderChart('compare-result',chartData,queryAmount);};var add=function(query){if(!query)return 0;if($scope.queries.indexOf(query)!==-1){return 0}
$scope.queries.push(query);$scope.query='';};var startCompare=function(){$scope.chartRendering=true;$http.post('/query-compare/compare',{queries:$scope.queries,startDate:$scope.startDate,endDate:$scope.endDate}).success(function(result){if(result.s){generateChart(result.d,$scope.queries.length);$scope.chartRendering=false;$scope.results.total=result.t;}else{alert('Get charts failed');}}).error(function(){alert("Error From Server");});};var clearQueryList=function(){$scope.queries=[];};var removeQuery=function(index){$scope.queries.splice(index,1);};var enterToAdd=function(event,query){var keyCode=window.event?event.keyCode:event.which;if(keyCode===13){add(query);}};var setDateRange=function(){var modalInstance=$modal.open({templateUrl:'/partials/dashboard/set_date_range.html',controller:datePickerController,resolve:{startDate:function(){return $scope.startDate;},endDate:function(){return $scope.endDate;}}});modalInstance.result.then(function(date){$scope.startDate=moment(date.sd).format('DD/MM/YYYY');$scope.endDate=moment(date.ed).format('DD/MM/YYYY');});};var datePickerController=function($scope,$modalInstance,startDate,endDate){$scope.info={sd:moment(startDate,'DD/MM/YYYY').valueOf(),ed:moment(endDate,'DD/MM/YYYY').valueOf()};$scope.done=function(info){var s=new Date(info.sd),e=new Date(info.ed);if(s>e)alert("End Date must greater or equal than Start Date");else $modalInstance.close(info);};$scope.cancel=function(){$modalInstance.dismiss('cancel');}};init();$scope.startCompare=startCompare;$scope.add=add;$scope.clearQueryList=clearQueryList;$scope.removeQuery=removeQuery;$scope.enterToAdd=enterToAdd;$scope.setDateRange=setDateRange;});}(angular,moment));var opened_list=[];(function($a,AWS,moment,Viewer){'use strict';$a.module('ML').controller('receiptDetails',function($scope,$rootScope,$http,$routeParams,$modal,localStorageService){$rootScope.tabSelect=9;$rootScope.MLPageDetail='Receipt Manager';$scope.receipt={};$scope.categories=[];$scope.wallets=[];$scope.hasWallet=true;$scope.adminName=ADMIN_NAME;$scope.btnDoneLabel='Create transaction';var urlRootImage=(env==='production')?'https://s3-img.moneylover.me':'https://s3-img-dev.moneylover.me';var imageElement=document.getElementById('myimg');$scope.imageReceipt='';var id=$routeParams.id;var s3=new AWS.S3({accessKeyId:'AKIAJB6JUVNE22EIBMXA',secretAccessKey:'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',region:'ap-southeast-1'});var bucket=(env==='production')?'money-lover-images':'money-lover-images-test';init();function init(){$scope.isLoading=true;var opened_list=localStorageService.get('openedReceipt')||[];opened_list.push(id);opened_list=_.unique(opened_list);localStorageService.add('openedReceipt',opened_list);getReceiptInfo(id,function(err,receipt){$scope.isLoading=false;if(err){return showErrorMain(err);}
$scope.receipt=receipt;if($scope.receipt.data&&$scope.receipt.data.amount){$scope.receipt.data.amount=parseInt($scope.receipt.data.amount);}
setDefaultDisplayDate();getWallet(receipt.user._id,function(err,data){$scope.wallets=data;$scope.hasWallet=checkWallet();if($scope.hasWallet){getCategory(receipt.wallet._id,function(err,categories){if(err){return showErrorMain(err);}
$scope.categories=categories;});}});$scope.imageReceipt=urlRootImage+'/'+receipt.image_id;imageElement.onerror=function(){imageElement.setAttribute('src','/partials/receipt/receipt_default.png');showErrorImage();};});}
function checkWallet(){if(!$scope.receipt.wallet){return false;}
if(!$scope.receipt.wallet._id){return false;}
var hw=false;$scope.wallets.forEach(function(wallet){if(wallet._id===$scope.receipt.wallet._id){hw=true;}});return hw;}
function setDefaultDisplayDate(){if(!$scope.receipt.data){$scope.receipt.data={};}
$scope.receipt.data.displayDate=moment($scope.receipt.created_at).format('YYYY-MM-DD');}
function removeImage(id){s3.deleteObject({Bucket:bucket,Key:id},function(err){if(err){console.log(err.stack);}});}
function encode(data){var str=data.reduce(function(a,b){return a+String.fromCharCode(b);},'');return btoa(str).replace(/.{76}(?=.)/g,'$&\n');}
function getReceiptInfo(id,callback){$http.post('/receipt/find-one',{id:id}).success(function(result){if(result.s){callback(null,result.d);}else{callback('Get Receipt due to failed');}}).error(function(){callback("Error From Server");});}
function reject(receipt,reason,callback){$http.post('/receipt/save/reject',{receipt:receipt,reason:reason}).success(function(result){if(result.s){callback();}else{callback('Reject due to failed');}}).error(function(){callback('Error From Server');});}
function draft(receipt,callback){$http.post('/receipt/save/draft',{receipt:receipt}).success(function(result){if(result.s){callback();}else{callback('Save draft due to failed');}}).error(function(){callback('Error From Server');});}
function done(receipt,callback){$http.post('/receipt/save/done',{receipt:receipt}).success(function(result){if(result.s){callback();}else{callback('Set done due to failed');}}).error(function(){showErrorMain('Error From Server');});}
function showErrorImage(){document.getElementById('errorImage').removeAttribute('hidden');}
function showErrorMain(message){document.getElementById('errorMain').removeAttribute('hidden');document.getElementById('errorMainMessage').innerHTML=message;}
function showSuccessMain(message){document.getElementById('successMain').removeAttribute('hidden');document.getElementById('successMainMessage').innerHTML=message;}
function getCategory(wallet_id,callback){$http.post('/receipt/get-category',{wallet:wallet_id}).success(function(result){if(result.s){return callback(null,result.d);}
callback('Get category list due to failed');}).error(function(){callback('Error From Server');});}
function getWallet(user_id,callback){$http.post('/receipt/get-wallet',{user_id:user_id}).success(function(result){if(!result.s){return callback('Get wallet list due to failed');}
callback(null,result.d);}).error(function(){callback('Error From Server');});}
function selfAssign(receipt){$http.post('/receipt/save/self-assign',{id:receipt._id}).success(function(result){if(result.s){receipt.admin=result.d;}else{showErrorMain("Assign due to failed");}}).error(function(){showErrorMain("Error From Server");});}
var ctrlReason=function($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.ok=function(){var myReason=document.getElementsByName('reject_reason');if(!this.myReason){return showErrorMain("Please select a reason!");}
$modalInstance.close(JSON.parse(this.myReason));};};$http.post('/currency/get').success(function(data){$scope.listCurrency=data.data;}).error(function(){showErrorMain("Get currency error!");});$scope.setLongLat=function(address){var url="https://maps.googleapis.com/maps/api/geocode/json?address="+address+"&sensor=false";url=encodeURI(url);$http.get(url).success(function(res){$scope.receipt.data.latitude=res.results[0].geometry.location.lat;$scope.receipt.data.longtitude=res.results[0].geometry.location.lng;}).error(function(){showErrorMain("Get long/lat error!");});};$scope.selectWallet=function(){$scope.receipt.wallet=$scope.wallets[parseInt($scope.selectedWalletIndex)];getCategory($scope.wallets[parseInt($scope.selectedWalletIndex)],function(err,data){$scope.categories=data;});};$scope.selfAssign=function(receipt){selfAssign(receipt);};$scope.draft=function(receipt){var ok=confirm("Are you sure?");if(!ok)return;$scope.isLoading=true;draft(receipt,function(err){$scope.isLoading=false;if(err){showErrorMain(err);}});};$scope.reject=function(receipt){var modalInstance=$modal.open({templateUrl:'/partials/receipt/reason.html',controller:ctrlReason,resolve:{}});modalInstance.result.then(function(reason){reject(receipt,reason,function(err){if(err){return showErrorMain(err);}
removeImage(receipt.image_id);receipt.status='rejected';showSuccessMain('Receipt has been rejected');if(!receipt.metadata){receipt.metadata={};}
receipt.metadata.reject_reason=reason;});});};$scope.done=function(){var receipt=this.receipt;if(!receipt.data){return alert('Data is empty!');}
if(!receipt.data.amount){return alert('Amount is empty!');}
if(!receipt.data.displayDate){var inputDisplayDate=document.getElementById('inputDisplayDate').value;if(!inputDisplayDate){return alert('Display date is empty!');}
receipt.data.displayDate=moment(inputDisplayDate,'DD/MM/YYYY').format('YYYY-MM-DD');}
var ok=confirm('Are you sure?');if(!ok){return;}
if(this.selectedCategoryIndex){receipt.category=this.categories[parseInt(this.selectedCategoryIndex)];}
$scope.isLoading=true;done(receipt,function(err){$scope.isLoading=false;if(err){showErrorMain(err);}else{showSuccessMain('Transaction from this receipt has been created successfully');receipt.status='done';$scope.btnDoneLabel='Transaction created';}});};$scope.hideErrorImage=function(){document.getElementById('errorImage').setAttribute('hidden','true');};$scope.hideErrorMain=function(){document.getElementById('errorMain').setAttribute('hidden','true');};$scope.hideSuccessMain=function(){document.getElementById('successMain').setAttribute('hidden','true');};$scope.imageDetail=function(){var viewer=new Viewer(imageElement);};$scope.unassign=function(receipt){$http.post('/receipt/save/unassign',{id:receipt._id}).success(function(result){if(!result.s){return alert('Unassign admin due to error');}
receipt.admin=null;}).error(function(){alert('Error From Server');});};$scope.nextReceipt=function(){$http.post('/receipt/get-next-open',{opened:localStorageService.get('openedReceipt')}).success(function(result){if(!result.s){return alert('Get next receipt due to failed');}
if(!result.d){return alert('No open receipt found');}
if(result.d===id){return alert('No open receipt found');}
location.replace(result.d);}).error(function(){alert('Error From Server');});};});}(angular,AWS,moment,Viewer,_));'use strict';(function($a){$a.module('ML').controller('receiptList',function($scope,$rootScope,$http,localStorageService){$rootScope.tabSelect=9;$rootScope.MLPageDetail='Receipt Manager';$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;var limit=20;$scope.isLoading=false;$scope.noResult=false;$scope.searchResult=false;var FILTER_MODE={1:'all',2:'new',3:'open',4:'draft',5:'rejected',6:'done'};$scope.filter_selected=3;$scope.isAdmin=false;$scope.sort='asc';$scope.listReceipt=[];init();function init(){localStorageService.add('openedReceipt',[]);getData();}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.listReceipt.length<limit;$scope.noResult=$scope.listReceipt.length===0;}
function getAll(is_get_by_admin,skip,limit,callback,sort){var postData={skip:skip,limit:limit};if(is_get_by_admin){postData.admin=true;}
if(sort){postData.sort=sort;}
$http.post('/receipt/find-all',postData).success(function(result){if(!result.s){return callback('Get list due to failed');}
callback(null,result.d);}).error(function(){callback('Error from server');});}
function getByStatus(is_get_by_admin,status,skip,limit,callback,sort){var postData={skip:skip,limit:limit,status:status};if(is_get_by_admin){postData.admin=true;}
if(sort){postData.sort=sort;}
$http.post('/receipt/find-by-status',postData).success(function(result){if(!result.s){return callback('Get list due to failed');}
callback(null,result.d);}).error(function(){callback('Error from server');});}
function deleteReceipt(id,callback){$http.post('/receipt/delete',{id:id}).success(function(result){if(!result.s){return callback('Delete receipt due to failed');}
callback();}).error(function(){callback('Error from server');});}
function getData(){$scope.isLoading=true;var mode_number=$scope.filter_selected;var offset=limit*($scope.page-1);var status=FILTER_MODE[mode_number];var admin=$scope.isAdmin;if(mode_number===1){getAll(admin,offset,limit,callbackStatus,$scope.sort);}else{getByStatus(admin,status,offset,limit,callbackStatus,$scope.sort);}
function callbackStatus(err,data){$scope.isLoading=false;if(err){return alert(err);}
$scope.listReceipt=data;checkPage();}}
function filterSelected(mode_number,is_admin){$scope.filter_selected=mode_number;$scope.isAdmin=is_admin||false;$scope.page=1;getData();}
function search(skip){if(!$scope.searchEmail||$scope.searchEmail==''){return;}
var skip=limit*($scope.page-1);$scope.isLoading=true;$http.post('/receipt/find-by-email',{email:$scope.searchEmail,skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(!result.s){return alert('Searching due to failed');}
$scope.searchResult=true;$scope.listReceipt=result.d;checkPage();}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
$scope.deleteReceipt=function(receipt,index){var ok=confirm('Are you sure?');if(!ok){return;}
deleteReceipt(receipt._id,function(err){if(err){return alert(err);}
$scope.listReceipt.splice(index,1);});};$scope.search=function(){$scope.page=1;search();};$scope.exitSearch=function(){$scope.page=1;$scope.searchResult=false;$scope.searchEmail='';init();};$scope.checkEnterSearch=function(event){if(event.keyCode!=13){return;}
$scope.search();};$scope.nextPage=function(value){$scope.page+=value;if($scope.searchResult){search();}else{getData();}};$scope.changeSort=function(){if($scope.sort==='asc'){$scope.sort='decs';}else{$scope.sort='asc';}
getData();};$scope.filterSelected=filterSelected;});}(angular));'use strict';(function($a,async,moment){$a.module('ML').controller('receiptRanking',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=9;$rootScope.MLPageDetail='Receipt Handle Statistic';$scope.startDate=null;$scope.endDate=null;$scope.rankingData={};$scope.listAdmin={};$scope.tabSelected='done';function getAdminNameById(id){$http.post('/admin/find-one',{id:id}).success(function(result){if(!result.s){return alert('Get admin name due to error');}
$scope.listAdmin[id]=result.d.username;}).error(function(){alert('Error From Server');});}
function getAdmin(data){data.forEach(function(element){if(!$scope.listAdmin[element._id]){getAdminNameById(element._id);}});}
function compare(a,b){return b.total-a.total;}
function mergeData(done_data,rejected_data){var output=[];var pin_data=rejected_data;var ref_data=done_data;var pin_key='rejected';var ref_key='done';if(done_data.length>=rejected_data.length){pin_data=done_data;pin_key='done';ref_data=rejected_data;ref_key='rejected';}
pin_data.forEach(function(pin){var obj={_id:pin._id};obj[pin_key]=pin.total||0;ref_data.forEach(function(ref){if(ref._id===pin._id){obj[ref_key]=ref.total;}});if(!obj[ref_key]){obj[ref_key]=0;}
obj['total']=obj[pin_key]+obj[ref_key];output.push(obj);});return output;}
function handleData(data){var output=mergeData(data.done,data.rejected);output.sort(compare);getAdmin(output);return output;}
function getData(){$http.post('/receipt/ranking',{startDate:$scope.startDate.format('YYYY-MM-DD'),endDate:$scope.endDate.format('YYYY-MM-DD')}).success(function(result){if(!result.s){return alert('Get ranking data due to error');}
$scope.rankingData=handleData(result.d);getAdmin($scope.rankingData);}).error(function(){alert("Error From Server");});}
function setDateRange($scope,$modalInstance,startDate,endDate){$scope.range={start:startDate.format('YYYY-MM-DD'),end:endDate.format('YYYY-MM-DD')};$scope.submit=function(){$modalInstance.close(this.range);};$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
function ctrlListReceiptByAdmin($scope,$modalInstance,admin_info,start_date,end_date,status){$scope.admin_name=admin_info.name;$scope.isLoading=false;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;var limit=20;$scope.list=[];$scope.close=function(){$modalInstance.dismiss('cancel');};$scope.nextPage=function(value){$scope.page+=value;getCompleteList();};function getCompleteList(){var skip=limit*($scope.page-1);var postData={skip:skip,limit:limit,admin_id:admin_info._id,startDate:start_date.format('YYYY-MM-DD'),endDate:end_date.format('YYYY-MM-DD'),status:status};$scope.isLoading=true;$http.post('/receipt/find-solved-by-admin',postData).success(function(result){$scope.isLoading=false;if(result.s){$scope.list=result.d;checkPage();}else{alert('Get receipts due to failed');}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.list.length<limit;}
function init(){getCompleteList();}
init();}
$scope.selectTab=function(tab){$scope.tabSelected=tab;};$scope.setDateRange=function(){var modalInstance=$modal.open({templateUrl:"receipt_date_range.html",controller:setDateRange,resolve:{startDate:function(){return $scope.startDate;},endDate:function(){return $scope.endDate;}}});modalInstance.result.then(function(range){if(moment(range.start,'YYYY-MM-DD')._d.toString()==$scope.startDate._d.toString()&&moment(range.end,'YYYY-MM-DD')._d.toString()==$scope.endDate._d.toString()){return 0;}
$scope.startDate=moment(range.start,'YYYY-MM-DD');$scope.endDate=moment(range.end,'YYYY-MM-DD');getData();});};$scope.listReceiptByAdmin=function(admin_id,status){var modalInstance=$modal.open({templateUrl:'list_receipt_by_admin.html',controller:ctrlListReceiptByAdmin,resolve:{admin_info:function(){return{_id:admin_id,name:$scope.listAdmin[admin_id]};},start_date:function(){return $scope.startDate;},end_date:function(){return $scope.endDate;},status:function(){return status;}}});};function init(){$scope.startDate=moment().startOf('month');$scope.endDate=moment().startOf('day');getData();}
init();});}(angular,async,moment));(function($a){'use strict';$a.module('ML').controller('redeem',function($scope,$rootScope,$http,$modal,$routeParams){$rootScope.MLPageDetail="Redeem Details";$rootScope.tabSelect=4;})}(angular));(function($a){$a.module('ML').controller('register_dev_ml',function($scope,$rootScope,$modal,$http){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Open API';$scope.page=1;var perPage=10;$scope.partners=[];$scope.noContent=true;$scope.isFirstPage=true;$scope.isLastPage=true;var STATUS_MODE={PENDING:0,DONE:1};$scope.$on('$viewContentLoaded',function(){loadPartner($scope.page);});function excutePage(scope){if(!scope.pre_page){$scope.isFirstPage=true;}else{$scope.isFirstPage=false;}
if(!scope.next_page){$scope.isLastPage=true;}else{$scope.isLastPage=false;}}
function loadPartner(page){var url='/api/register_dev_ml/browse';var params={page:page,perPage:perPage};$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.partners=response.data.data;if($scope.partners.length<1){$scope.noContent=true;}else{$scope.noContent=false;}
excutePage(response.data);}else{alert('Get list partner error');}}},function errorCallback(response){alert(response.status);});};$scope.nextPage=function(int){$scope.page+=int;loadPartner($scope.page);};$scope.accept=function(partner,flag){var url='/api/register_dev_ml/accept';var data={_id:partner._id,flag:flag};if(flag==false){var ok=confirm("You will denine "+partner.email+", are you sure?");if(ok){$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadPartner($scope.page);}else{alert('Update partner error');}}},function errorCallback(response){alert(response.status);});}}else{$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){loadPartner($scope.page);}else{alert('Update partner error');}}},function errorCallback(response){alert(response.status);});}};$scope.filter=function(type){var url='/api/register_dev_ml/filter';var data={type:type}
$http({method:'POST',url:url,data:data}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.partners=response.data.data;}else{alert('Filter partner error');}}},function errorCallback(response){alert(response.status);});}
$scope.showSecret=function(partner){partner.showSecret=true;};$scope.hideSecret=function(partner){partner.showSecret=false;};$scope.detail=function(item){var modalInstance=$modal.open({templateUrl:'/partials/open_api/detail.html',controller:ctrlDetail,resolve:{scope:function(){return item;}}});modalInstance.result.then(function(data){});};function ctrlDetail($scope,$modalInstance,scope){$scope.init=function(){if(scope.status==0){$scope.status='Pending';}else if(scope.status==1){$scope.status='Accepted';}else if(scope.status==2){$scope.status='Denied';}
$scope.partnerDetail=scope;$scope.itemDetailName=scope.partnerName;}();$scope.cancel=function(){$modalInstance.dismiss('cancel');}};})}(angular));(function($a){'use strict';$a.module('ML').controller('rwList',function($scope,$http,$rootScope,$modal,$location){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Remote Wallet List';$scope.walletList=[];var limit=20;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.isLoading=false;$scope.walletDetails={};$scope.isViewRank=false;$scope.loadingTopService=false;$scope.serviceRanking=[];getList(0,limit);function getList(skip,limit){$scope.isLoading=true;$http.post('/remote-wallet/list',{skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.walletList=result.d;if(result.total)$scope.total=result.total;checkPage();}else{alert("Getting Remote Wallet failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.walletList.length<limit;}
function nextPage(value){$scope.page+=value;var skip=limit*($scope.page-1);getList(skip,limit);}
function showRank(){$scope.isViewRank=!$scope.isViewRank;if($scope.serviceRanking.length===0){$scope.loadingTopService=true;$http.post('/remote-wallet/provider/wallet-amount',{}).success(function(result){$scope.loadingTopService=false;if(!result.status)return alert('Get service ranking failed');$scope.serviceRanking=result.data;$scope.serviceRanking.sort(function(a,b){return b.amount-a.amount;});}).error(function(){$scope.loadingTopService=false;alert('Error from server');});}}
$scope.nextPage=nextPage;$scope.showRank=showRank;});}(angular));(function($a,document){'use strict';$a.module('ML').controller('rwProvider',function($http,$scope,$rootScope,$modal){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Remote Wallet Service Manager';$scope.imgRootUrl=(env==='production')?'https://static.moneylover.me/img/icon/provider/':'https://statictest.moneylover.me/img/icon/provider/';var limit=20;$scope.listProvider=[];$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.PROVIDER={1:"SaltEdge",2:"Finsify"};$scope.isLoading=true;$scope.isSearchPage=false;$scope.filter=null;$scope.statistic=null;function getStats(){$http.post('/remote-wallet/provider/count',{}).success(function(result){if(!result.status)return alert('Get provider stats failed');$scope.statistic=result.data;}).error(function(){alert('Error from server');});}
getStats();function validateHexColor(input){var regexHexColor=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i;return regexHexColor.test(input);}
function validateUrl(input){var regexUrl=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/;return regexUrl.test(input);}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.listProvider.length<limit;}
function getList(){$http.post('/remote-wallet/get-provider',{skip:limit*($scope.page-1),limit:limit,filter:$scope.filter}).success(function(result){if(result.s){$scope.listProvider=result.d;$scope.isLoading=false;checkPage();}
else alert('Get List Failed');}).error(function(){alert('Error From Server');});}
getList();$scope.filterSelect=function(mode){if($scope.filter===mode){return;}
$scope.filter=mode;$scope.page=1;getList();};$scope.backToList=function(){$scope.isSearchPage=false;$scope.page=1;getList();};$scope.changeIcon=function(provider){var modalInstance=$modal.open({templateUrl:'/partials/rw-provider/icon.html',controller:ctrlChangeIcon,resolve:{provider:function(){return provider;},imgRootUrl:function(){return $scope.imgRootUrl;}}});modalInstance.result.then(function(icon_link){provider.icon=icon_link;});};var ctrlChangeIcon=function($scope,$modalInstance,provider,imgRootUrl){$scope.icon=provider.icon;$scope.errorMsg=null;$scope.imgRootUrl=imgRootUrl;$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.submit=function(){$scope.errorMsg=null;var fd=new FormData();fd.append('filedata',document.querySelector('#newIcon').files[0]);fd.append('imagename',provider.code+'.png');fd.append('providerId',provider._id);$http.post('/remote-wallet/change-icon',fd,{headers:{'Content-Type':undefined},transformRequest:$a.identity}).success(function(result){if(result.s)$modalInstance.close(result.icon);else $scope.errorMsg="Change Icon Failed";}).error(function(){$scope.errorMsg="Error From Server";});}};$scope.editMetaSearch=function(provider){var modalInstance=$modal.open({templateUrl:'/partials/rw-provider/edit_meta.html',controller:ctrlEditMeta,resolve:{provider:function(){return provider;}}});modalInstance.result.then(function(meta_search){provider.meta_search=meta_search;});};var ctrlEditMeta=function($scope,$modalInstance,provider){$scope.meta=provider.meta_search||"";$scope.errorMsg=null;$scope.save=function(meta){$scope.errorMsg=null;$http.post('/remote-wallet/change-meta-search',{meta:meta,id:provider._id}).success(function(result){if(result.s)$modalInstance.close(meta);else $scope.errorMsg="Edit meta search failed";}).error(function(){$scope.errorMsg="Error From Server";})};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.changeDisabled=function(provider){var ok=confirm("Are you sure?");if(ok){$http.post('/remote-wallet/change-disabled',{_id:provider._id,disabled:!provider.disabled}).success(function(result){if(result.s)provider.disabled=!provider.disabled;else alert("Change provider disabled status failed");}).error(function(){alert("Error From Server");});}};$scope.changeFree=function(provider){var ok=confirm("Are you sure?");if(ok){$http.post('/remote-wallet/change-free',{_id:provider._id,free:!provider.is_free}).success(function(result){if(result.s)provider.is_free=!provider.is_free;else alert("Change provider free status failed");}).error(function(){alert("Error From Server");});}};$scope.changeDebugStatus=function(provider){var ok=confirm("Are you sure?");if(ok){$http.post('/remote-wallet/change-debug',{_id:provider._id,debug:!provider.is_debug}).success(function(result){if(result.s)provider.is_debug=!provider.is_debug;else alert("Change provider debug status failed");}).error(function(){alert("Error From Server");});}};$scope.changeHasBalance=function(provider){var ok=confirm('Are you sure?');if(!ok){return;}
$scope.isLoading=true;var status=!provider.hasBalance;$http.post('/remote-wallet/change-has-balance',{providerId:provider._id,status:status}).success(function(result){$scope.isLoading=false;if(result.s){provider.hasBalance=status;}else{alert("Change failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});};$scope.searchKey=function(event,keyword){var keyCode=window.event?event.keyCode:event.which;if(keyCode===13)$scope.search(keyword);};function search(keyword,skip){$scope.isLoading=true;$http.post('/remote-wallet/search',{keyword:keyword,limit:limit,skip:skip}).success(function(result){$scope.isLoading=false;if(result.s){$scope.isSearchPage=true;$scope.listProvider=result.d;checkPage();}
else alert("Searching provider failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
$scope.search=function(keyword){$scope.isLoading=true;$scope.page=1;search(keyword,0);};$scope.nextPage=function(value){$scope.page+=value;if($scope.isSearchPage){var skip=limit*($scope.page-1);search(this.keyword,skip);}else getList();};$scope.goToPage=function(page){var p=parseInt(page);if(p>0&&!isNaN(p)){$scope.page=parseInt(page);getList();}};$scope.updateProvider=function(){var ok=confirm("Remote wallet providers will be updated, are you sure?");if(ok){$http.post('/remote-wallet/init-provider-list',{}).success(function(result){if(result.s)alert("Providers are updating");else alert("Provider update failed");}).error(function(){alert("Error From Server");});}};$scope.rebuildCache=function(service){var ok=confirm('Cache will be rebuilt, are you sure?');if(ok){$http.post('/remote-wallet/build-cache',{service:service}).success(function(result){if(result.s)alert("Cache is being rebuilt");else alert("Cache rebuild failed");}).error(function(){alert("Error From Server");});}};$scope.showIconlessList=function(){var modalInstance=$modal.open({templateUrl:'/partials/rw-provider/iconless.html',controller:ctrlIconless,resolve:{}});modalInstance.result.then(function(){});};var ctrlIconless=function($scope,$modalInstance){var limit=10;$scope.page=1;$scope.list=[];$scope.isLoading=false;$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.list.length<limit;function getList(){$scope.isLoading=true;$http.post('/remote-wallet/iconless-list',{skip:limit*($scope.page-1),limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.list=result.d;checkPage();}
else alert('Get list failed');}).error(function(){$scope.isLoading=false;alert('Error From Server');});}
getList();function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.list.length<limit;}
$scope.nextPage=function(value){$scope.page+=value;getList();};$scope.cancel=function(){$modalInstance.dismiss('close');}};$scope.editActions=function(provider){var modalInstance=$modal.open({templateUrl:'/partials/rw-provider/actions.html',controller:ctrlEditActions,resolve:{provider:function(){return provider;}}});};var ctrlEditActions=function($scope,$modalInstance,provider){$scope.setting={};getSetting(provider.realId);function getSetting(serviceId){$http.post('/remote-wallet/provider/action/get',{serviceId:serviceId}).success(function(data){if(data.s){$scope.setting=data.d;if(!$scope.setting.actions){$scope.setting.actions=[];}}else{alert("Get data failed");}}).error(function(){alert("Error From Server");});}
$scope.addAction=function(){var instance2=$modal.open({templateUrl:'/partials/rw-provider/action_detail.html',controller:ctrlAddAction,resolve:{action:function(){return{color:$scope.setting.color}}}});instance2.result.then(function(data){$scope.setting.actions.push(data);});};$scope.edit=function(action){var instanceEdit=$modal.open({templateUrl:'/partials/rw-provider/action_detail.html',controller:ctrlAddAction,resolve:{action:function(){return action;}}});instanceEdit.result.then(function(data){action=data;});};$scope.delete=function(index){var ok=confirm('Action will be deleted. Are you sure?');if(!ok)return;$scope.setting.actions.splice(index,1);};$scope.save=function(setting){var ok=confirm('Are you sure?');if(!ok)return;if(!setting)return;if(setting.color){if(!validateHexColor(setting.color)){return alert("Color invalid");}}
$http.post('/remote-wallet/provider/action/save',{serviceId:provider.realId,data:setting}).success(function(result){if(result.s){$modalInstance.close();}else{alert("Save failed");}}).error(function(){alert("Error From Server");});};$scope.cancel=function(){$modalInstance.dismiss('cancel');}};var ctrlAddAction=function($scope,$modalInstance,action){$scope.info=action;$scope.add=function(info){if(!info||!info.name||!info.type||!info.icon){return alert("Info invalid");}
if(info.color){if(!validateHexColor(info.color)){return alert('Color invalid');}}
if(info.metadata){if(info.type==='link'){if(validateUrl(info.metadata)){var url=info.metadata.split('?');if(url[1]){if(url[1].indexOf('ref=moneylover')===-1){info.metadata+='&ref=moneylover';}}else{info.metadata+='?ref=moneylover';}}}}
$modalInstance.close(info);};$scope.cancel=function(){$modalInstance.dismiss('cancel');}}});}(angular,document));(function($a){'use strict';$a.module('ML').controller('rwRequest',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Remote Wallet Extend Limit Request';var limit=20;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.isLoading=false;$scope.isSearchPage=false;$scope.listRequest=[];function getList(){$scope.isLoading=true;$http.post('/remote-wallet/get-request',{limit:limit,skip:limit*($scope.page-1)}).success(function(result){$scope.isLoading=false;if(result.s){$scope.listRequest=result.d;checkPage();}else alert("Get request list due to error");}).error(function(){alert("Error From Server");});}
getList();function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.listRequest.length<limit;}
$scope.deleteRequest=function(request){var ok=confirm('Are you sure?');if(ok){$scope.isLoading=true;$http.post('/remote-wallet/delete-extend-limit-request',{id:request._id}).success(function(result){$scope.isLoading=false;if(result.s)getList();else alert("Delete request failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");});}};$scope.accept=function(request){var ok=confirm('Are you sure?');if(!ok)return;$scope.isLoading=true;$http.post('/remote-wallet/accept-extend-limit-request',{request:request}).success(function(result){$scope.isLoading=false;if(result.s){var action="Accept Extend Remote Wallet Limit Request";$http.post('/premiumlog/savelog',{email:request.user.email,action:action}).success(function(data){}).error(function(){});getList();}}).error(function(){$scope.isLoading=false;alert("Error From Server");});};$scope.reject=function(request){}});}(angular));(function($a){'use strict';$a.module('ML').controller('searchQuery',function($scope,$rootScope,$http,$modal,$location){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Search-query Manager';$scope.isLoading=false;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;var limit=20;$scope.queryList=[];$scope.nextPage=function(numberPage){$scope.page+=numberPage;getList();};function excutePage(scope){$scope.isFirstPage=$scope.page==1;$scope.isLastPage=scope.length<limit;};function getList(){var skip=limit*($scope.page-1);$scope.isLoading=true;$http.post('/search-query/get',{skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.queryList=result.d;excutePage($scope.queryList);}
else alert("Get list failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");})}
getList();function alertModal(message){var modalInstance=$modal.open({templateUrl:'alert.html',controller:ctrlAlert,resolve:{message:function(){return message;}}});modalInstance.result.then(function(){});}
function ctrlAlert($scope,$modalInstance,message){$scope.message=message;$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.regen=function(query){var ok=confirm('"'+query.name+'" will be regenerate new cached result. Are you sure?');if(ok){$scope.isLoading=true;$http.post('/search-query/regenerate',{query:query}).success(function(result){$scope.isLoading=false;if(result.s){getList();alert("Regenerate search-query is being process");}
else alert("Regen new result failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");});}};$scope.exportToCsv=function(query){var ok="Are you sure?";if(!ok)return;$scope.isLoading=true;$http.post('/search-query/export-full',{tags:query.query}).success(function(result){$scope.isLoading=false;if(!result.s){alert("Export failed");}else{alertModal('The request is being processed. You will be notified whenever it done');}}).error(function(){$scope.isLoading=false;alert('Error From Server');});};$scope.removeQuery=function(query){var ok=confirm('"'+query.name+'" will be removed. Are you sure?');if(ok){$scope.isLoading=true;$http.post('/search-query/remove',{query:query}).success(function(result){$scope.isLoading=false;if(result.s)getList();else alert("Remove search-query failed");}).error(function(){alert("Error From Server");});}};$scope.regenerateAll=function(){var ok=confirm('" Will you regenerate all search query. Are you sure?');if(ok){$scope.isLoading=true;$http.post('/search-query/regenerate-all',{query:{}}).success(function(result){$scope.isLoading=false;if(result.s){alert('successfully');getList();}
else alert("Regenerate all search-query failed");}).error(function(){alert("Error From Server");});}}
$scope.createAutomationQuick=function(query){if(!query)return;$location.path("/email_push_automation").search({query:query.name,id:query._id,modal:true});}});}(angular));(function($a){'use strict';$a.module('ML').controller('searchQueryDetails',function($scope,$rootScope,$http,$modal,$location){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Search-query Details';$scope.title='';$scope.isPreviewLoading=false;$scope.previewDevice=[];$scope.previewUser=[];$scope.deviceCount=0;$scope.userCount=0;$scope.pageDevice=1;$scope.pageUser=1;$scope.isFirstPageDevice=true;$scope.isFirstPageUser=true;$scope.isLastPageDevice=true;$scope.isLastPageUser=true;$scope.isSaving=false;var limit=10;var tempKey;$scope.previewMode='device';$scope.isEditing=false;initInfo();function getInfo(id){$http.post('/search-query/get-one',{id:id}).success(function(result){if(result.s){$scope.queryInfo=result.d;$scope.isEditing=true;$scope.title=$scope.queryInfo.name+" query details";}
else alert("Get search query failed");}).error(function(){alert("Error From Server");});}
function initInfo(){var queryId=$location.search().id;if(queryId){getInfo(queryId);}
else{$scope.queryInfo={type:'device',query:''};$scope.title='Add new search-query';}}
function getDevice(user){$http.get('/info/device/'+user._id).success(function(data){if(data&&data!==false&&data!=='false'){data.forEach(function(device){if(device.platform===1){if(!user.hasAndroid){user.hasAndroid=true;}}else if(device.platform===2){if(!user.hasIos){user.hasIos=true;}}else if(device.appId===5){if(!user.hasWindows){user.hasWindows=true;}}else if(device.appId===4){if(!user.hasWp){user.hasWp=true;}}else if(device.platform===6){if(!user.hasOsx){user.hasOsx=true;}}else if(device.platform===7){if(!user.hasWeb){user.hasWeb=true;}}});}}).error(function(){alert("Error from server");});}
function getCountry(user){if(user.tags){user.tags.forEach(function(tag){if(tag.indexOf('country')!==-1){user.flag=tag.split(':')[1];}});}}
function getPreviewMongo(type,query,skip,limit,mode){$scope.isPreviewLoading=true;$http.post('/search-query/query-preview-mongo',{type:type,query:query,limit:limit,skip:skip}).success(function(result){$scope.isPreviewLoading=false;console.log(result);if(result.s){if(result.t&&result.t.user)$scope.userCount=result.t.user;if(result.t&&result.t.device)$scope.deviceCount=result.t.device;if(result.d&&result.d.device&&(mode==='all'||mode==='device')){$scope.previewDevice=result.d.device;$scope.previewDevice.forEach(function(device,index){if(!device)$scope.previewDevice[index]={};});}
if(result.d&&result.d.user&&(mode==='all'||mode==='user')){$scope.previewUser=result.d.user;$scope.previewUser.forEach(function(user,index){if(user){getDevice(user);getCountry(user);}else $scope.previewUser[index]={}});}
$scope.previewMode=$scope.queryInfo.type;checkPage();}else alert("Preview query failed");}).error(function(){$scope.isPreviewLoading=false;alert("Error From Server");});}
function getPreview(type,query,skip,limit,mode){$scope.isPreviewLoading=true;$http.post('/search-query/query-preview',{type:type,query:query,limit:limit,skip:skip}).success(function(result){$scope.isPreviewLoading=false;if(result.s){if(result.t&&result.t.user)$scope.userCount=result.t.user;if(result.t&&result.t.device)$scope.deviceCount=result.t.device;if(result.d&&result.d.device&&(mode==='all'||mode==='device')){$scope.previewDevice=result.d.device;$scope.previewDevice.forEach(function(device,index){if(!device)$scope.previewDevice[index]={};});}
if(result.d&&result.d.user&&(mode==='all'||mode==='user')){$scope.previewUser=result.d.user;$scope.previewUser.forEach(function(user,index){if(user){getDevice(user);getCountry(user);}else $scope.previewUser[index]={}});}
$scope.previewMode=$scope.queryInfo.type;checkPage();}else alert("Preview query failed");}).error(function(){$scope.isPreviewLoading=false;alert("Error From Server");});}
function checkPage(){$scope.isFirstPageDevice=$scope.pageDevice===1;$scope.isFirstPageUser=$scope.pageUser===1;$scope.isLastPageDevice=$scope.previewDevice.length<limit;$scope.isLastPageUser=$scope.previewUser.length<limit;}
$scope.selectPreview=function(mode){$scope.previewMode=mode;};$scope.detectSocial=function(userTags){if(!userTags)return null;if(userTags.indexOf('facebook')!=-1)return'facebook';if(userTags.indexOf('google')!=-1)return'google';};$scope.previewMongo=function(type,query){if(!type||!query)return 0;$scope.pageDevice=1;$scope.pageUser=1;var skip=0;getPreviewMongo(type,query,skip,limit,'all');};$scope.preview=function(type,query){if(!type||!query)return 0;$scope.pageDevice=1;$scope.pageUser=1;var skip=0;getPreview(type,query,skip,limit,'all');};$scope.save=function(type,query,name){if(!type||!query)return 0;if($scope.isEditing){var ok=confirm("Are you sure?");if(ok)edit();}else{createNew();}
function createNew(){if(query.indexOf('limit:')===-1){return alert('Please set limit for the query');}
$scope.isSaving=true;$http.post('/search-query/save',{type:type,query:query,name:name,keyRedis:tempKey}).success(function(result){$scope.isSaving=false;if(result.s){var createAnother=confirm("Saving search-query is being process. Do you wanna create another search-query?");if(createAnother)initInfo();else window.location.href='/search-query';}
else alert("Save search-query failed");}).error(function(){$scope.isSaving=false;alert("Error From Server");});}
function edit(){alert("Edit");}};$scope.regen=function(query){$scope.isLoading=true;$http.post('/search-query/regenerate',{query:query}).success(function(result){$scope.isLoading=false;if(result.s){initInfo();alert("Regenerate search-query is being process");}
else alert("Regen new result failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");})};$scope.nextPreviewPage=function(value,type,query,mode){if(mode==='device'){$scope.previewMode='device';$scope.pageDevice+=value;var skip=limit*($scope.pageDevice-1);getPreview(type,query,skip,limit,mode);}else{$scope.previewMode='user';$scope.pageUser+=value;var skip=limit*($scope.pageUser-1);getPreview(type,query,skip,limit,mode);}};$scope.exportToCsv=function(query){$scope.isLoading=true;console.log(query);if(query.queryMode==='elastic'){$http.post('/search-query/export-full',{tags:query.query}).success(function(result){$scope.isLoading=false;if(!result.s){alert("Export failed");}else{alert('The request is being processed. You will be notified whenever it done');}}).error(function(){$scope.isLoading=false;alert('Error From Server');});}else if(query.queryMode==='mongo'){$http.post('/search-query/export-full-mongo',{tags:query.query_mongo}).success(function(result){$scope.isLoading=false;if(!result.s){alert("Export failed");}else{alert('The request is being processed. You will be notified whenever it done');}}).error(function(){$scope.isLoading=false;alert('Error From Server');});}};});}(angular));(function($a){'use strict';$a.module('ML').controller('sendpremiumcode',function($scope,$rootScope,$http,$location){$rootScope.tabSelect=4;$rootScope.MLPageDetail='Send Premium Code';$scope.userInfo={lang:"vi"};$scope.mode='single';$scope.send=function(info){if($scope.mode=='single')singleModeSend(info);else multiModeSend(info);};var singleModeSend=function(userInfo){if(userInfo.email&&userInfo.email!==""){checkCodeEverSent(userInfo.email,function(result){if(result){if(result.length>0){var ok=confirm("Email này đã từng được gửi hoặc đã được một admin kích hoạt premium, bạn có chắc muốn gửi lại không?");if(ok){sendMail(userInfo);}}else{sendMail(userInfo);}}else{alert("checking error");}});}else{alert("Please complete this form")}};var multiModeSend=function(userInfo){if(!userInfo.list_email)return;var list=userInfo.list_email.split(',');for(var i=0;i<list.length;i++){if(validateEmail(list[i].trim()))list[i]=list[i].trim();else return alert(list[i].trim()+' is not email');}};var sendMail=function(userInfo){$http.post('/user/send-premium-code',userInfo).success(function(data){if(data.s){alert("All Done!")}else{alert(data.msg);}}).error(function(){alert("Error From Server");})};var checkCodeEverSent=function(email,callback){$http.post('/premiumlog/search-email',{keyword:email}).success(function(data){if(data.s){callback(data.d);}else{callback(false);}}).error(function(){alert("Error From Server");})};var validateEmail=function(email){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return re.test(email);}})}(angular));(function($a,document){'use strict';$a.module('ML').controller('serverSetting',function($scope,$rootScope,$http){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Server Setting';$scope.env=env;var API_KEY='AIzaSyBCZ06wztPJpP8Q2l5m4xW8zm_jB833Pu4';var GCM_ENDPOINT='https://android.googleapis.com/gcm/send';$scope.setting={};$scope.setting.isServerMaintain='false';$scope.backgroundNotification=false;function sendSubscriptionToServer(subscription){var mergedEndpoint=endpointWorkaround(subscription);updateGcmId(mergedEndpoint);}
function updateGcmId(mergedEndpoint){var endpointSections=mergedEndpoint.split('/');var subscriptionId=endpointSections[endpointSections.length-1];var curlCommand='curl --header "Authorization: key='+API_KEY+'" --header Content-Type:"application/json" '+GCM_ENDPOINT+' -d "{\\"registration_ids\\":[\\"'+subscriptionId+'\\"]}"';console.log(curlCommand);$http.post('/admin/update-gcm-id',{gcm:subscriptionId}).success(function(result){if(!result.s)alert("Update GCM Id Failed");}).error(function(){alert("Error From Server");});}
function initialiseState(){if(!('showNotification'in ServiceWorkerRegistration.prototype)){return;}
if(Notification.permission==='denied'){return;}
if(!('PushManager'in window)){return;}
navigator.serviceWorker.ready.then(function(serviceWorkerRegistration){serviceWorkerRegistration.pushManager.getSubscription().then(function(subscription){if(!subscription){return;}
sendSubscriptionToServer(subscription);}).catch(function(err){console.warn('Error during getSubscription()',err);});});}
function checkServiceWorker(){if('serviceWorker'in navigator){navigator.serviceWorker.register('/service-worker.js').then(initialiseState);}else{console.warn('Service workers aren\'t supported in this browser.');}}
function endpointWorkaround(pushSubscription){if(pushSubscription.endpoint.indexOf('https://android.googleapis.com/gcm/send')!==0){return pushSubscription.endpoint;}
var mergedEndpoint=pushSubscription.endpoint;if(pushSubscription.subscriptionId&&pushSubscription.endpoint.indexOf(pushSubscription.subscriptionId)===-1){mergedEndpoint=pushSubscription.endpoint+'/'+
pushSubscription.subscriptionId;}
return mergedEndpoint;}
function subscribe(){navigator.serviceWorker.ready.then(function(serviceWorkerRegistration){console.log(serviceWorkerRegistration);serviceWorkerRegistration.pushManager.subscribe({userVisibleOnly:true}).then(function(subscription){return sendSubscriptionToServer(subscription);}).catch(function(e){if(Notification.permission==='denied'){console.log('Permission for Notifications was denied');}else{console.log('Unable to subscribe to push.',e);}});});}
function unsubscribe(){navigator.serviceWorker.ready.then(function(serviceWorkerRegistration){serviceWorkerRegistration.pushManager.getSubscription().then(function(pushSubscription){pushSubscription.unsubscribe().then(function(successful){}).catch(function(e){console.log('Unsubscription error: ',e);});}).catch(function(e){console.log('Error thrown while unsubscribing from push messaging.',e);});});}
var getSetting=function(){$http.get('/server-setting/get').success(function(data){if(!data.s){alert('error while get settings');}else{$scope.setting=data.data;}}).error(function(){alert("loi cmnr");});$http.post('/backend-setting/get-gcm-status',{}).success(function(result){if(result.s){$scope.backgroundNotification=(result.data==='true');}else alert("Get GCM Setting due to error");}).error(function(){alert("Error From Server");});};getSetting();$scope.changeStatus=function(){var postData={sm:$scope.setting.isServerMaintain};if($scope.setting.isServerMaintain==='true'){if($scope.setting.endMaintainTime){var m=moment($scope.setting.endMaintainTime,'DD-MM-YYYY HH:mm');var now=moment();if(m<=now)return alert("Invalid time! The time is should greater than this moment");if(m.isValid())postData.ft=m.toISOString();}else{postData.ft=null;}}else{postData.ft=null;$scope.setting.endMaintainTime=null;}
$http.post('/server-setting/maintain-status',postData).success(function(data){if(!data.s){alert(data.e);}else{$scope.timeSetting=false;if($scope.setting.isServerMaintain==='true'){document.getElementById("footerMaintainStatus").removeAttribute('hidden');}else{document.getElementById("footerMaintainStatus").setAttribute('hidden','true');}}}).error(function(){alert('Loi cmnr');});};$scope.changeBackgroundNotificationStatus=function(){if(!$scope.backgroundNotification)unsubscribe();else subscribe();checkServiceWorker();$http.post('/backend-setting/gcm-status',{gcm:$scope.backgroundNotification}).success(function(result){if(!result.s)alert("Save setting due to error");}).error(function(){alert("Error From Server");});};$scope.editEndMaintainTime=function(){$scope.timeSetting=true;$scope.setting.endMaintainTime=null;}});}(angular,document));(function($a,document){$a.module('ML').controller('shoeboxed',function($scope,$modal,$rootScope,$http){$rootScope.tabSelect=2;$rootScope.MLPageDetail='Test Shoeboxed';$scope.upload=function(){if(this.imgFile){var fd=new FormData();fd.append('filedata',document.querySelector('#imgFile').files[0]);$http.post('/test-shoeboxed/upload',fd,{headers:{'Content-Type':undefined},transformRequest:$a.identity}).success(function(result){}).error(function(){alert("Error From Server");});}};});}(angular,document));(function($a){'use strict';$a.module('ML').controller('Stats',function($scope,$rootScope,$routeParams,$http,$modal){var page=$routeParams.status;$scope.page=page;$rootScope.MLPageDetail='Statistics';$scope.showDaily=false;$scope.showMinutely=false;$scope.mode='Daily';$scope.start=0;$scope.endtime=new Date().getTime();$scope.errorCode=[];$scope.tableCode=[];var limit=30;$scope.statsData=[];var charts={};$scope.endDate=moment().valueOf();$scope.startDate=moment().subtract(15,'days').valueOf();$scope.chooseDate=function(){var modalInstance=$modal.open({templateUrl:'/partials/dashboard/set_date_range.html',controller:ctrlChooseDate,resolve:{startDate:function(){return $scope.startDate;},endDate:function(){return $scope.endDate;}}});modalInstance.result.then(function(date){$scope.startDate=moment(date.sd).valueOf();$scope.endDate=moment(date.ed).valueOf();});};function getPremiumStat(element){$http.post('/user/premium-count',{start:$scope.startDate,end:$scope.endDate}).success(function(data){if(!data.s)return console.log('Get premium chart data failed');if(!charts[element]){charts[element]=new Morris.Area({element:element,data:data.d,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['amount'],labels:['Total'],lineColors:['#379ca8']});}else charts[element].setData(data.d);}).error(console.log);}
var ctrlChooseDate=function($scope,$modalInstance,startDate,endDate){$scope.info={sd:startDate,ed:endDate};$scope.done=function(info){var s=new Date(info.sd),e=new Date(info.ed);if(s>e)alert("End Date must greater or equal than Start Date");else $modalInstance.close(info);};$scope.cancel=function(){$modalInstance.dismiss('cancel');}};var getStat=function(table,types,start,end,limit,callback){$http.post('/stats',{table:table,types:types,start:start,end:end,limit:limit}).success(function(data){callback(false,data);}).error(function(data){callback(true,data);});};var formatData=function(data){if(data.length>0){data.sort(function(a,b){var timestampA=moment(a.createAt).valueOf();var timestampB=moment(b.createAt).valueOf();return timestampA-timestampB;});var newData=[];data.forEach(function(stat){if(stat&&stat.createAt){var newCreateTime;if(page=='hourly'){newCreateTime=moment(stat.createAt).format('HH:mm DD/MM');}else{newCreateTime=moment(stat.createAt).subtract(1,'minutes').subtract(7,'hours').format('DD/MM');}
newData.push({counter:stat.counter,createAt:newCreateTime});}});return newData;}else{return[];}};var mergeTransaction=function(datas1,datas2){var newData=[];datas1.forEach(function(data,index){newData.push({create:data.counter,del:datas2[index].counter,createAt:data.createAt});});return newData;};var mergeData=function(object){var newData=[];var total=object.total.d;var objSize=Object.keys(object).length;var objKeys=Object.keys(object);total.forEach(function(data,index){var info={};info.createAt=data.createAt;for(var i=0;i<objSize;i++){var counter=object[objKeys[i]].d[index]||0;if(counter===0)
info[objKeys[i]]=counter;else
info[objKeys[i]]=counter.counter;}
newData.push(info);});return newData;};$scope.getStat=function(element,tableCode){var table=parseInt(tableCode,10);if(table==600){getTransactionStat(element);}else if(table===1000){getDeviceStat(element);}else if(table==1600){getPushNotificationDeviceStat(element);}else if(table==1610){getPushNotificationSessionStat(element);}else if(table===1500){getPremiumStat(element)}else{getStat(table,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)console.log(err);else{var newData=formatData(data.d);if(!charts[element]){charts[element]=new Morris.Area({element:element,data:newData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:true,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['counter'],labels:['Total'],lineColors:['#379ca8']});}else charts[element].setData(newData);}});}};function getTransactionStat(element){async.parallel({transaction:function(cb){getStat(600,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else cb(null,data);});},transactionDelete:function(cb){getStat(603,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else cb(null,data);});}},function(err,results){var newTransData=formatData(results.transaction.d);var newTransDelData=formatData(results.transactionDelete.d);var data=mergeTransaction(newTransData,newTransDelData);if(!charts[element]){charts[element]=new Morris.Area({element:element,data:data,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['create','del'],labels:['Create','Delete'],lineColors:['#379ca8','#ed5564']});}else charts[element].setData(data);});}
function getDeviceStat(element){async.parallel({total:function(cb){getStat(1000,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},android:function(cb){getStat(1010,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},ios:function(cb){getStat(1020,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},wp:function(cb){getStat(1034,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},windows:function(cb){getStat(1035,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},mac:function(cb){getStat(1060,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});},web:function(cb){getStat(1070,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);data.d=data.d.reverse();cb(null,data);}});}},function(err,results){var newData=mergeData(results);newData=newData.reverse();if(!charts[element]){charts[element]=new Morris.Area({element:element,data:newData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['android','ios','wp','windows','mac','web'],labels:['android','ios','wp','windows','mac','web'],lineColors:['#3EB249','#F44336','#FFEB3B','#2196F3','#607D8B','#8E24AA']});}else charts[element].setData(newData);});}
function getPushNotificationSessionStat(element){async.parallel({total:function(cb){getStat(1610,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);cb(null,data);}});},accepted:function(cb){getStat(1611,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);cb(null,data);}});},denied:function(cb){getStat(1612,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);cb(null,data);}});},pending:function(cb){getStat(1613,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);cb(null,data);}});}},function(error,results){var newData=mergeData(results);if(!charts[element]){charts[element]=new Morris.Area({element:element,data:newData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['accepted','denied','pending'],labels:['Accepted','Denied','pending'],lineColors:['#3EB249','#F44336','#3498db']});}else charts[element].setData(newData);});}
function getPushNotificationDeviceStat(element){async.parallel({total:function(cb){getStat(1600,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);cb(null,data);}});},sent:function(cb){getStat(1601,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);cb(null,data);}});},read:function(cb){getStat(1602,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);cb(null,data);}});},error:function(cb){getStat(1603,$scope.types,$scope.start,$scope.endtime,limit,function(err,data){if(err)cb(null,[]);else{data.d=formatData(data.d);cb(null,data);}});}},function(error,results){var newData=mergeData(results);if(!charts[element]){charts[element]=new Morris.Area({element:element,data:newData,grid:false,lineWidth:4,parseTime:false,pointSize:3,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'createAt',ykeys:['sent','read','error'],labels:['Sent','Read','Error'],lineColors:['#3EB249','#3498db','#F44336']});}else charts[element].setData(newData);});}
function getMode(){if(page=='daily'){$scope.types=1;$scope.mode='Daily';}else if(page=='hourly'){$scope.types=2;$scope.mode='Hourly';}else if(page=='monthly'){$scope.types=3;$scope.mode='Monthly';}}
getMode();$scope.selectMode=function(mode){if($scope.mode==mode)return;$scope.mode=mode;getStat();};})}(angular));(function($a){"use strict";$a.module('ML').controller('subscriptionCode',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Subscription Code';$scope.page=1;var limit=50;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.products=[];$scope.selectedProduct="All";$scope.filter={used:"All",expire:"All"};$scope.codeList=[];$scope.info={total:0,used:0};getProductList();getInfo($scope.selectedProduct);function getProductList(){$http.post('/subscription-code/product-list',{}).success(function(result){if(result.s){$scope.products=result.d;}else alert("Get Product List Failed");}).error(function(){alert("Error From Server");});}
function getCodeList(product){var postData={limit:limit,skip:limit*($scope.page-1),filter:$scope.filter};if(product!=='All')postData.product=product;$http.post('/subscription-code/get',postData).success(function(result){if(result.s){$scope.codeList=result.d;checkPage();}else alert("Get the codes failed");}).error(function(){alert("Error From Server");});}
function getInfo(product){var postData={};if(product!=='All')postData.productId=product;$http.post('/subscription-code/count',postData).success(function(result){if(result.s){$scope.info=result.d;}else alert("Get Info Failed");}).error(function(){alert("Error From Server");});}
function checkPage(){$scope.isFirstPage=($scope.page===1);$scope.isLastPage=($scope.codeList.length<limit);}
$scope.selectProduct=function(productId){$scope.selectedProduct=productId;getInfo($scope.selectedProduct);};$scope.selectFilter=function(key,value){$scope.filter[key]=value;};$scope.getList=function(){getCodeList($scope.selectedProduct);};$scope.addNew=function(){var modalInstance=$modal.open({templateUrl:'/partials/subscription-code/add.html',controller:ctrlAdd,resolve:{productList:function(){return $scope.products;}}});modalInstance.result.then(function(){$scope.getList();getInfo($scope.selectedProduct);});};$scope.delete=function(code_id){};var ctrlAdd=function($scope,$http,$modalInstance,productList){$scope.products=productList;$scope.genCodeOption={hasExpire:false,amount:10};function checkOption(option){if(!option.amount)return false;if(!option.productId)return false;if(option.hasExpire&&!option.expireDate)return false;return true;}
$scope.selectProduct=function(productId){$scope.genCodeOption.productId=productId;};$scope.datePicker=function(){this.showWeeks=false;this.minDate=(this.minDate)?null:new Date();};$scope.generate=function(){var ok=checkOption($scope.genCodeOption);if(ok){$http.post('/subscription-code/generate',$scope.genCodeOption).success(function(result){if(result.s){$modalInstance.close();}else alert("Generate new code failed");}).error(function(){alert("Error From Server");});}};$scope.cancel=function(){$modalInstance.dismiss("cancel");};};$scope.nextPage=function(value){$scope.page+=value;$scope.getList();};});}(angular));(function($a){$a.module('ML').controller('subscriptionLog',function($scope,$rootScope,$http,$routeParams,$location){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Subscription Log';$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.logs=[];var filter={};getFilter();function getFilter(){filter=$location.search();$scope.selectedPlatform=filter.platform||null;$scope.selectedProduct=filter.product||null;$scope.selectedMarket=filter.market||null;}
var limit=50;function checkPage(){$scope.isFirstPage=($scope.page===1);$scope.isLastPage=($scope.logs.length<limit);}
function getAll(){$scope.isLoading=true;var skip=limit*($scope.page-1);$http.post('/subscription-log/get-all',{skip:skip,limit:limit}).success(function(response){if(response.s){$scope.logs=response.d;$scope.isLoading=false;checkPage();}else{$scope.isLoading=false;alert("Get Log Failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");})}
function getByEmail(email){$scope.page=1;$http.post('/subscription-log/get-by-user-email',{skip:0,limit:0,email:email}).success(function(response){if(response.s){$scope.isLoading=false;$scope.logs=response.d;checkPage();}else{$scope.isLoading=false;alert("Get Log Failed or Email not exists");}}).error(function(){$scope.isLoading=false;alert("Error From Server");})}
$scope.getAll=getAll;$scope.search=getByEmail;$scope.searchKey=function(event,keyword){var keyCode=window.event?event.keyCode:event.which;if(keyCode===13)getByEmail(keyword);};$scope.selectQuery=function(category,value){if(value==='all'){if(filter[category])delete filter[category];}
else filter[category]=value;$location.path('/subscription-log').search(filter);};$scope.nextPage=function(value){$scope.page+=value;getAll();};});}(angular));(function($a){'use strict';$a.module('ML').controller('subscriptionProduct',function($scope,$http,$rootScope,$modal){$rootScope.tabSelect=8;$rootScope.MLPageDetail='Subscription Products';$scope.products=[];function getProduct(){$http.post('/subscription-products/get',{}).success(function(result){if(result.s){$scope.products=result.d;}else{alert("Get Subscription Product Failed");}}).error(function(){alert("Error From Server");});}
$scope.getProduct=getProduct;$scope.newProduct=function(){var modalInstance=$modal.open({templateUrl:'/partials/subscription-product/info.html',controller:ctrlAdd,resolve:{}});modalInstance.result.then(function(newItem){$scope.products.unshift(newItem);});};var ctrlAdd=function($scope,$http,$modalInstance){$scope.productInfo={isPublic:false,has_trial:false,metadata:{discount:0},android:false,ios:false,windows:false};$scope.mode='add';$scope.saveItem=function(){if($scope.productInfo.alias&&typeof $scope.productInfo.alias==='string'){$scope.productInfo.alias=$scope.productInfo.alias.split(',');}
if(!$scope.productInfo.metadata.type){return alert("Please select type of subscription");}
if(!$scope.productInfo.metadata.discount){$scope.productInfo.metadata.discount=0;}else if($scope.productInfo.metadata.discount>100){return alert('Discount value should equal or less than 100');}
$http.post('/subscription-products/add',$scope.productInfo).success(function(result){if(result.s){getProduct();$modalInstance.close();}else{alert("Create new product due to failed");}}).error(function(){alert('Error From Server');});};$scope.close=function(){$modalInstance.dismiss('cancel');};};$scope.edit=function(productIndex){var modalInstance=$modal.open({templateUrl:'/partials/subscription-product/info.html',controller:ctrlEdit,resolve:{productInfo:function(){return $scope.products[productIndex];}}});modalInstance.result.then(function(itemInfo){$scope.products[productIndex]=itemInfo;});};var ctrlEdit=function($scope,$http,$modalInstance,productInfo){$scope.productInfo=productInfo;$scope.mode='edit';if($scope.productInfo.metadata&&$scope.productInfo.metadata.platform){if($scope.productInfo.metadata.platform.indexOf('android')!=-1){$scope.productInfo.android=true;}
if($scope.productInfo.metadata.platform.indexOf('ios')!=-1){$scope.productInfo.ios=true;}
if($scope.productInfo.metadata.platform.indexOf('windows')!=-1){$scope.productInfo.windows=true;}}
$scope.saveItem=function(){if(productInfo.alias&&typeof productInfo.alias==='string'){productInfo.alias=productInfo.alias.split(',');}
if(!productInfo.metadata||!productInfo.metadata.type){return alert("Please select type of subscription");}
$http.post('/subscription-products/update-item',{item:productInfo}).success(function(result){if(result.s){getProduct();$modalInstance.close();}else{alert("Update product due to failed");}}).error(function(){alert("Error From Server");});};$scope.close=function(){$modalInstance.dismiss('cancel');}};$scope.delete=function(item,index){$http.post('/subscription-products/delete',{id:item._id}).success(function(result){if(result.s){getProduct();}else{alert("Delete item due to failed");}}).error(function(){alert("Error From Server");});};$scope.build=function(){$http.post('/subscription-products/build',{}).success(function(result){if(result.s)alert("Success");else alert("Save new product list failed");}).error(function(){alert("Error From Server");})};$scope.changePublic=function(product){product.isPublic=!product.isPublic;$http.post('/subscription-products/update-item',{item:product}).success(function(result){if(result.s){}else{alert("Update product due to failed");product.isPublic=!product.isPublic;}}).error(function(){alert("Error From Server");product.isPublic=!product.isPublic;});};$scope.changeTopDownload=function(product){product.isTopDownload=!product.isTopDownload;$http.post('/subscription-products/update-item',{item:product}).success(function(result){if(result.s){}else{alert("Update product due to failed");product.isTopDownload=!product.isTopDownload;}}).error(function(){alert("Error From Server");product.isTopDownload=!product.isTopDownload;});};$scope.changeMarkAsGiftState=function(product){$http.post('/subscription-products/change-mark-as-gift',{id:product._id}).success(function(result){if(result.s){product.markAsGift=!product.markAsGift;}else{alert("Update product due to failed");}}).error(function(){alert("Error From Server");});}});}(angular));(function($a){'use strict';$a.module('ML').controller('subscriptionRenewLogController',function($scope,$http,$rootScope,$modal){$rootScope.tabSelect=8;$rootScope.MLPageDetail='Subscription Renew Log';$scope.page=1;var limit=40;$scope.isFirstPage;$scope.isLastPage;$scope.noContent;$scope.subscription_renew_log=[];$scope.$on('$viewContentLoaded',function(){loadLog();});$scope.nextPage=function(num){$scope.page+=num;loadLog();};function excutePage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.subscription_renew_log.length<limit;};function loadLog(){var url="/subscription-renew-log/browse";var params={'skip':$scope.page,'limit':limit}
$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.subscription_renew_log=response.data.data;excutePage();if($scope.subscription_renew_log.length>0){$scope.noContent=false;}else{$scope.noContent=true;}}else{alert('Get list log error');}}},function errorCallback(response){alert(response.status);});}
$scope.searchKey=function(event,key){var url='/subscription-renew-log/searchByBill';if(event.keyCode===13){var params={searchKey:key}
$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.subscription_renew_log=response.data.data;excutePage();if($scope.subscription_renew_log.length>0){$scope.noContent=false;}else{$scope.noContent=true;}}else{alert('Get list log error');}}},function errorCallback(response){alert(response.status);});}}
$scope.search=function(key){var url='/subscription-renew-log/searchByBill';var params={searchKey:key}
$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.status==200){if(response.data.status){$scope.subscription_renew_log=response.data.data;excutePage();if($scope.subscription_renew_log.length>0){$scope.noContent=false;}else{$scope.noContent=true;}}else{alert('Get list log error');}}},function errorCallback(response){alert(response.status);});}});}(angular));(function($a){$a.module('ML').controller('subscriptionStats',function($scope,$rootScope,$http){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Subscription Stats';});}(angular));(function($a){"use strict";$a.module('ML').controller('SyncFailDetail',function($scope,$http,$rootScope,$routeParams){$rootScope.MLPageDetail='Sync Failed Detail';getItem($routeParams.id);function getItem(id){$http.post('/sync-fail-log/get-one',{errorId:id}).success(function(data){if(data.s){$scope.item=data.d;}else alert("Get Log Failed");}).error(function(){alert("Error From Server");})}})}(angular));(function($a){"use strict";$a.module('ML').controller('SyncFailLog',function($scope,$http,$rootScope){$rootScope.tabSelect=2;$rootScope.MLPageDetail='Sync Failed Items';var limit=100;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.platforms=[{id:0,text:"All"},{id:1,text:"Android"},{id:2,text:"iOS"},{id:3,text:"Windows"},{id:6,text:"Mac OSX"}];$scope.selectedPlatform=$scope.platforms[0];var errorTypeSelected=["all"];var platformSelected=[0];$scope.logs=[];function checkPage(){$scope.isFirstPage=($scope.page===1);$scope.isLastPage=($scope.logs.length<limit);}
function getList(){var skip=limit*($scope.page-1);var postData={limit:limit,skip:skip,platform:platformSelected,viewMode:errorTypeSelected};$http.post('/sync-fail-log/get',postData).success(function(data){$scope.isLoading=false;if(data.s){$scope.logs=data.d;checkPage();}else{alert("Get Logs failed");}}).error(function(){alert("Error From Server");})}
$scope.getList=function(){$scope.isLoading=true;if($scope.keyword)$scope.keyword=null;getList();};$scope.checkErrorSelected=function(type){return errorTypeSelected.indexOf(type);};$scope.checkErrorType=function(type){switch(type){case'all':if($scope.checkErrorSelected(type)===-1)errorTypeSelected=['all'];else errorTypeSelected=['duplicate','datetime'];break;case'other':if($scope.checkErrorSelected(type)===-1)errorTypeSelected=['other'];else errorTypeSelected=['duplicate','datetime'];break;default:var index=$scope.checkErrorSelected(type);if(index===-1)errorTypeSelected.push(type);else errorTypeSelected.splice(index,1);}};$scope.checkPlatformSelected=function(platformId){return platformSelected.indexOf(platformId);};$scope.checkPlatform=function(platformId){switch(platformId){case 0:if($scope.checkPlatformSelected(platformId)!=-1)platformSelected=[1];else platformSelected=[0];break;default:var index=$scope.checkPlatformSelected(platformId);if(index!=-1)platformSelected.splice(index,1);else{if(platformSelected.length===3)platformSelected=[0];else platformSelected.push(platformId);}
break;}};function searchByEmail(keyword){var postData={email:keyword,platform:platformSelected,viewMode:errorTypeSelected,limit:limit,skip:limit*($scope.page-1)};$http.post('/sync-fail-log/search-by-email',postData).success(function(data){if(data.s){$scope.logs=data.d;}else alert("Searching Failed");}).error(function(){alert("Error From Server");})}
$scope.clearLog=function(){var ok=confirm("Are you sure???");if(ok){$http.post('/sync-fail-log/clear',{}).success(function(result){if(!result.s)alert("Clear Log Failed");else $scope.logs=[];}).error(function(){alert("Error From Server");})}};$scope.isOnlyOneSelected=function(mode,value){var result=false;if(mode==='error'){result=(errorTypeSelected.length===1&&errorTypeSelected[0]===value);}else{result=(platformSelected.length===1&&platformSelected[0]===value);}
return result;};$scope.searchEnter=function(event,keyword){if(event.keyCode===13){$scope.page=1;searchByEmail(keyword);}};$scope.searchButton=function(keyword){$scope.page=1;searchByEmail(keyword);};$scope.nextPage=function(number){$scope.page+=number;if($scope.keyword&&$scope.keyword!="")searchByEmail($scope.keyword);else getList();};})}(angular));(function($a){'use strict';$a.module('ML').controller('systemsinfo',function($scope,$rootScope,$http,$timeout){var loadInfodata=function(){$http.post("/dbstats",{}).success(function(response){$scope.isLoading=false;if(response.s){$scope.info=response.stats;}
else alert('Get database info failed');}).error(function(){$scope.isLoading=false;alert('Error from server.');});};$rootScope.tabSelect=3;$rootScope.MLPageDetail='Systems Info';$scope.isLoading=true;loadInfodata();$scope.refreshInfo=function(){loadInfodata();$scope.rotationData=true;$timeout(function(){$scope.rotationData=false;},1600,true);};var getListProcess=function(){$http.post("/processesstats",{}).success(function(response){$scope.presentDate=(new Date).getTime();$scope.process=response.list;}).error(function(){alert('Error');});};getListProcess();$scope.presentDate=(new Date).getTime();var getServerInfo=function(){$http.post("/serverinfo",{}).success(function(response){$scope.serverinfo=response.data;}).error(function(){alert('Error');});};getServerInfo();$scope.refreshServer=function(){getServerInfo();$scope.rotationServer=true;$timeout(function(){$scope.rotationServer=false;},1600,true)};$scope.refreshProcess=function(){getListProcess();$scope.rotationProc=true;$timeout(function(){$scope.rotationProc=false;},1600,true)};$scope.refreshRedis=function(){getInfoRedis();$scope.rotationRedis=true;$timeout(function(){$scope.rotationRedis=false;},1600,true);};$scope.restartProcess=function(process){var confirmRestart=confirm('Do you really want to RESTART app '+process.name+'?');if(confirmRestart){$http.post("/restartprocess",{pm_id:process.pm_id}).success(function(response){if(response.s){$scope.presentDate=(new Date).getTime();getListProcess();$scope.orangeStatus=false;}else{alert(response.m||'Restart Error');}}).error(function(err){alert('Error: '+err);});}else return false;};$scope.stopProcess=function(process){var confirmStop=confirm('Do you really want to STOP app '+process.name+'?');if(confirmStop){$http.post("/stopprocess",{pm_id:process.pm_id}).success(function(response){if(response.s){getListProcess();$scope.orangeStatus=true;}else{alert(response.m||'Stop Error');}}).error(function(err){alert('Error: '+err);});}else return false;};var getInfoRedis=function(){$http.get("/redis-info").success(function(response){var everyInfo=response.d.replace(/\n/g," ").replace(/\r/g,"").split(" ");var childInfo=[];var infoRedis={};$scope.infoRedis=infoRedis;for(var i=0;i<everyInfo.length;i++){if(everyInfo[i].indexOf("redis_version:")>=0){infoRedis.redisVersion=everyInfo[i].replace("redis_version:","");}else if(everyInfo[i].indexOf("uptime_in_seconds:")>=0){infoRedis.uptime=everyInfo[i].replace("uptime_in_seconds:","");}else if(everyInfo[i].indexOf("used_memory_human:")>=0){infoRedis.memoryHuman=everyInfo[i].replace("used_memory_human:","");}else if(everyInfo[i].indexOf("rdb_last_save_time:")>=0){infoRedis.rdbLastSave=everyInfo[i].replace("rdb_last_save_time:","");}else if(everyInfo[i].indexOf("db")>=0&&everyInfo[i].indexOf("keys")>=0){infoRedis.database=everyInfo[i].replace("db","");var dbDetail=infoRedis.database.split(",");infoRedis.dbKeys=dbDetail[0].split("=")[1];infoRedis.dbExpires=dbDetail[1].split("=")[1];}}}).error(function(){alert('Error');});};getInfoRedis();});}(angular));(function($a){'use strict';$a.module('ML').controller('tags',function($scope,$rootScope,$modal,$http){$rootScope.tabSelect=7;$rootScope.MLPageDetail='TAGS';$scope.$on('$viewContentLoaded',function(){loadTag();});$scope.tags={};$scope.noContent=false;$scope.create=function(){var modalInstance=$modal.open({templateUrl:'/partials/tags/create.html',controller:ctrlCreate,resolve:{tags:function(){return $scope.tags;}}});modalInstance.result.then(function(data){});};function ctrlCreate($scope,$modalInstance){$scope.tag={};$scope.createTag=function(tag){var newTag={};newTag.name=tag.name;newTag.duplicate=tag.duplicate;newTag.description=tag.description;var url='/api/tags/create';$http({method:'POST',url:url,data:newTag}).then(function successCallback(response){if(response.data.status===1){loadTag();}else{alert(response.data.message);}},function errorCallback(response){alert(response);});$modalInstance.close();};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};$scope.edit=function(tag){var editTag=angular.copy(tag);var clonedTags=angular.copy(tag);var modalInstance=$modal.open({templateUrl:'/partials/tags/edit.html',controller:ctrlUpdate,resolve:{editTag:function(){return editTag;},clonedTags:function(){return clonedTags;}}});modalInstance.result.then(function(data){var clonedTags=data.clonedTags;var url='/api/tags/edit';var oldValue=clonedTags.name+'|'+clonedTags.duplicate+'|'+clonedTags.description;var newValue=data.newTag;var params={oldValue:oldValue,newValue:newValue};$http({method:'POST',url:url,data:params}).then(function successCallback(response){if(response.data.status==1){loadTag();}else{alert(response.data.message);}},function errorCallback(response){alert(response);});});};function ctrlUpdate($scope,$modalInstance,editTag,clonedTags){$scope.editTag=editTag;$scope.updateTag=function(tagEdit){var newValue=tagEdit.name+'|'+tagEdit.duplicate+'|'+tagEdit.description;$modalInstance.close({clonedTags:clonedTags,newTag:newValue});};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};function loadTag(){var url='/api/tags/browse';var tagArray=[];$http({method:'GET',url:url}).then(function successCallback(response){if(response.data.status===1){var string=response.data.data;for(var i=0;i<string.length;i++){var tags={};var temp=string[i].split('|');tags.name=temp[0].replace(/[^\w\s]/gi,'');tags.duplicate=temp[1].replace(/[^\w\s]/gi,'');tags.description=temp[2].replace(/[^\w\s]/gi,'');tagArray.push(tags);}
$scope.tags=tagArray;if(tagArray.length>0){$scope.noContent=false;}else{$scope.noContent=true;}}},function errorCallback(response){alert(response);});};$scope.delete=function(tag){var url='/api/tags/delete';var params={value:tag.name+'|'+tag.duplicate+'|'+tag.description};var ok=confirm("Tag "+tag.name+' will be deleted, are you sure?');if(ok){$http({method:'POST',url:url,data:params}).then(function successCallback(response){loadTag();},function errorCallback(response){alert(response.data.message);});}};})}(angular));'use strict';(function($a,async){$a.module('ML').controller('Transaction',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=2;$rootScope.MLPageDetail='Transactions';$scope.transaction_list=[];$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.page=1;$scope.isLoading=false;var limit=20;var list_device={};function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.page.length<limit;}
function getData(){$scope.isLoading=true;var skip=limit*($scope.page-1);$http.post('/transaction/list',{skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.transaction_list=result.d;checkPage();checkDevice($scope.transaction_list);}else{alert("Get transaction due to failed");}}).error(function(){$scope.isLoading=false;alert('Error From Server');});}
function getDevice(tokenDevice,callback){if(list_device[tokenDevice]){return callback(null,list_device[tokenDevice]);}
$http.post('/transaction/get-device',{tokenDevice:tokenDevice}).success(function(result){if(result.s){list_device[tokenDevice]=result.d;callback(null,result.d);}else{callback('Get device due to failed');}}).error(function(){callback('Error From Server');});}
function checkDevice(list_transaction){async.eachSeries(list_transaction,function(transaction,cb){getDevice(transaction.tokenDevice,function(err,device){if(err){return cb(err);}
transaction.device=device;cb();});},function(err){if(err)alert(err);});}
$scope.detail=function(transaction){var modalInstance=$modal.open({templateUrl:'transaction_detail.html',controller:ctrlDetail,resolve:{transaction_id:function(){return transaction._id;}}});};function ctrlDetail($scope,$modalInstance,transaction_id){$scope.transaction={};$scope.cancel=function(){$modalInstance.dismiss('cancel');};function getTransaction(transaction_id){$scope.isLoading=true;$http.post('/transaction/get-one',{id:transaction_id}).success(function(result){$scope.isLoading=false;if(result.s){$scope.transaction=result.d;}else{alert('Get transaction detail due to failed');}}).error(function(){$scope.isLoading=false;alert('Error From Server');});}
getTransaction(transaction_id);}
$scope.nextPage=function(value){$scope.page+=value;getData();};$scope.refresh=function(){$scope.page=1;getData();};function init(){getData();}
init();});}(angular,async));'use strict';(function($a){$a.module('ML').controller('UncategorizedTransaction',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=6;$rootScope.MLPageDetail='Uncategorized Transactions';$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.isLoading=false;var limit=50;$scope.transactions=[];getList(0);function getList(skip){$scope.isLoading=true;$http.post('/uncategorized-transaction/list',{skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.transactions=result.d;checkPage();}else{alert('Get list failed');}}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.transactions.length<limit;}
function getListCategory(wallet_id,callback){$http.get('/info/cate/'+wallet_id).success(function(result){callback(null,result);}).error(function(){callback("Error From Server");});}
$scope.detail=function(transaction){var modalInstance=$modal.open({templateUrl:'/partials/uncategorized_transaction/detail.html',controller:ctrlDetail,resolve:{transaction:function(){return transaction;}}});};function ctrlDetail($scope,$modalInstance,transaction){$scope.transaction=transaction;$scope.close=function(){$modalInstance.dismiss('cancel');};}
$scope.changeCategory=function(transaction,index){var modalInstance=$modal.open({templateUrl:'/partials/uncategorized_transaction/change_category.html',controller:ctrChangeCategory,resolve:{transaction:function(){return transaction;}}});modalInstance.result.then(function(){$scope.transactions.splice(index,1);});};function ctrChangeCategory($scope,$modalInstance,transaction){$scope.categories=[];$scope.old_category=transaction.category;getListCategory(transaction.account._id,function(err,result){if(err){return alert(err);}
$scope.categories=result;});$scope.change=function(){if(!this.new_category){return alert('Please select new category');}
this.new_category=JSON.parse(this.new_category);if(this.new_category._id===this.old_category._id){return alert('New category and old category should not match');}
$scope.isLoading=true;var postData={tr:transaction,nc:this.new_category._id};$http.post('/uncategorized-transaction/change_category',postData).success(function(result){$scope.isLoading=false;if(result.s){$modalInstance.close();}else{alert('Change category due to failed');}}).error(function(){$scope.isLoading=false;alert("Error From Server");});};$scope.cancel=function(){$modalInstance.dismiss('cancel');}}
$scope.nextPage=function(value){$scope.page+=value;var skip=limit*($scope.page-1);getList(skip);}});}(angular));'use strict';(function($a){$a.module('ML').controller('UseCredit',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=8;$rootScope.MLPageDetail='Use Credits';$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.isLoading=false;var limit=20;$scope.product_list=[];init();function init(){$scope.page=1;getList(0,limit,function(err,data){if(err){return alert(err);}
$scope.product_list=data;})}
function getList(skip,limit,callback){$scope.isLoading=true;$http.post('/use-credits/list',{skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){callback(null,result.d);}else{callback('Get list failed');}}).error(function(){$scope.isLoading=false;callback('Error From Server');});}
function validateItem(item){if(!item){alert('Please type product info');return false;}
if(!item.name){alert("Please type product name");return false;}
if(!item.product_id){alert("Please type product_id");return false;}
if(!item.metadata||!item.metadata.credit){alert("Please amount of credit");return false;}
if(!item.metadata||!item.metadata.credit_type){alert("Please type of credit");return false;}
return true;}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.product_list.length<limit;}
$scope.addProduct=function(){var modalInstance=$modal.open({templateUrl:'/partials/use_credit/info.html',controller:ctrlAddCredit,resolve:{}});modalInstance.result.then(function(){init();});};function ctrlAddCredit($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.save=function(){if(!validateItem(this.item)){return;}
$scope.isLoading=true;$http.post('/use-credits/create',{item:this.item}).success(function(result){$scope.isLoading=false;if(result.s){$modalInstance.close();}else{alert("Create new item failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});};}
$scope.edit=function(product,index){var modalInstance=$modal.open({templateUrl:'/partials/use_credit/info.html',controller:ctrlEditCreditProduct,resolve:{product:function(){return product;}}});modalInstance.result.then(function(){});};function ctrlEditCreditProduct($scope,$modalInstance,product){$scope.item=product;$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.save=function(){if(!validateItem(this.item)){return;}
$scope.isLoading=true;$http.post('/use-credits/update',{item:this.item}).success(function(result){$scope.isLoading=false;if(result.s){$modalInstance.close();}else{alert("Create new item failed");}}).error(function(){$scope.isLoading=false;alert("Error From Server");});};}
$scope.delete=function(product,index){$scope.isLoading=true;$http.post('/use-credits/delete',{id:product._id}).success(function(result){$scope.isLoading=false;if(result.s){$scope.product_list.splice(index,1);}else{alert('Delete product due to failed');}}).error(function(){alert('Error From Server');});};$scope.nextPage=function(value){$scope.page+=value;var skip=limit*($scope.page-1);getList(skip,limit,function(err,data){if(err){return alert(err);}
$scope.product_list=data;checkPage();});};});}(angular));(function($a){'use strict';$a.module('ML').controller('user_devices',function($scope,$rootScope,$http,$modal){$rootScope.tabSelect=2;$rootScope.MLPageDetail='Device Manager';$scope.isLoading=true;var limit=20;$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.devices=[];$scope.result={};getList();function getList(){var skip=limit*($scope.page-1);$scope.isLoading=true;$http.post('/devices/get-list',{skip:skip,limit:limit}).success(function(result){$scope.isLoading=false;if(result.s){$scope.result=result.d;$scope.devices=$scope.result.list;checkPaging();}else alert("Get device list failed");}).error(function(){$scope.isLoading=false;alert("Error From Server");});}
function checkPaging(){$scope.isFirstPage=($scope.page===1);$scope.isLastPage=($scope.devices.length<limit);}
$scope.nextPage=function(value){$scope.page+=value;getList();};$scope.notificationSelector=function(device){var modalInstance=$modal.open({templateUrl:'/partials/device/select_notification.html',controller:ctrlSelectNotification,resolve:{device:function(){return device}}});modalInstance.result.then(function(){});};var ctrlSelectNotification=function($scope,$modalInstance,device){$scope.device=device;$scope.notifications=[];function getNotification(){$http.post('/message/get',{}).success(function(result){if(!result.err){$scope.notifications=result.data;}else{alert(result.msg);}}).error(function(){alert("Error From Server");});}
getNotification();$scope.send=function(){if(this.selectedNotification){$modalInstance.close();}};$scope.cancel=function(){$modalInstance.dismiss('close');}};$scope.openDetailModal=function(id){var modalInstance=$modal.open({templateUrl:'/partials/device/device_info.html',controller:ctrlDeviceInfo,resolve:{deviceId:function(){return id;}}});};var ctrlDeviceInfo=function($scope,$modalInstance,deviceId){$scope.isLoading=false;$scope.device={};function getDevice(id){$scope.isLoading=true;$http.post('/devices/get-one',{id:id}).success(function(result){$scope.isLoading=false;if(result.s)$scope.device=result.d;else alert("Get device info error");}).error(function(){$scope.isLoading=false;alert("Error From Server");})}
getDevice(deviceId);$scope.cancel=function(){$modalInstance.dismiss('cancel');}}});}(angular));(function($a){'use strict';$a.module('ML').controller('userTagManager',function($scope,$rootScope,$http){$rootScope.tabSelect=3;$rootScope.MLPageDetail='User Tag Manager';function getTags(){$http.get('/user-tag-manager/get').success(function(data){$scope.tags=data.tags;}).error(function(data){alert('Error From Server');})}
getTags();$scope.getList=function(){getTags();};$scope.add=function(){var tag=prompt("Enter new tag");if(tag&&tag!==""){$scope.tags.push(tag);}};$scope.remove=function(tag){$scope.tags.forEach(function(element,index){if(element===tag){$scope.tags.splice(index,1);}});};$scope.save=function(){$http.post('/user-tag-manager/save',{taglist:$scope.tags}).success(function(data){if(data.s){getTags();}else{alert(data.msg);}}).error(function(data){alert('Error From Server');})};})}(angular));(function($a){'use strict';$a.module('ML').controller('userbankmsg',function($scope,$rootScope,$http,$modal,$routeParams){$rootScope.tabSelect=3;$rootScope.MLPageDetail='Bank Messages from User';$scope.page=1;$scope.isFirstPage=true;$scope.isLastPage=true;$scope.isLoading=false;var limit=20;$scope.listmess=[];function getData(){var skip=limit*($scope.page-1);$scope.isLoading=true;$http.post('/userbankmsg/get',{skip:skip,limit:limit}).success(function(data){$scope.isLoading=false;if(data.err){alert(data.msg);}else{$scope.listmess=data.data;checkPage();}}).error(function(data,err){$scope.isLoading=false;alert("Error From Server");});}
function checkPage(){$scope.isFirstPage=$scope.page===1;$scope.isLastPage=$scope.listmess.length>limit;}
$scope.getList=function(){getData();};$scope.nextPage=function(value){$scope.page+=value;getData();};$scope.downloadMessList=function(){location.href='/userbankmsg/download';};$scope.delete=function(msg){var ok=confirm("Are you sure?");if(!ok){return 0;}
$http.post('/userbankmsg/delete',{msgId:msg._id}).success(function(data){$scope.getList();alert(data.msg);}).error(function(data){alert('Error From Server');});};getData();});}(angular));(function($a,location){'use strict';$a.module('ML').controller('users',function($scope,$rootScope,$location,$http,$routeParams,$modal){var limit=20;var offset=0;$scope.env=env;$scope.isSearchPage=false;$scope.isFirstPage=true;$scope.isLastPage=false;$scope.totalUser=null;$scope.noResult=false;$scope.resultAmount=0;$scope.subscription=null;$scope.isLoading=true;var searchMode=[{value:0,title:"Tìm tương đối"},{value:1,title:"Tìm chính xác"}];$scope.searchMode=searchMode[1];$rootScope.tabSelect=2;$rootScope.MLPageDetail='User Manager';$scope.tableName='User list';$scope.displaySearch=false;$scope.listUser=[];$scope.page=1;$scope.indexList=offset;function checkFirstLastPage(){$scope.isFirstPage=$scope.page==1;$scope.isLastPage=$scope.listUser.length<limit;}
function searchController(condition,mode,limit,callback){$scope.isLoading=true;$http.post('/user/search',{mode:mode,condition:condition,limit:limit}).success(function(data){$scope.isLoading=false;if(data.error){alert(data.message);return;}else{callback(data);}}).error(function(data){$scope.isLoading=false;callback(data);});}
function getUserList(query,callback){var url='/user/list';var postData={limit:query};if(query.subscription==='no-linked-wallet'||query.subscription==='no-premium'){url='/user/list-no-subscription';postData={skip:query.skip,limit:query.limit,subscription:query.subscription};}else if(query.subscription){url='/user/list-subscription';postData={skip:query.skip,limit:query.limit,subscription:query.subscription};}
$scope.isLoading=true;$scope.listUser=[];$http.post(url,postData).success(function(data){$scope.isLoading=false;if(data.error){alert(data.message);return;}else{callback(data);}}).error(function(data){$scope.isLoading=false;callback(data);});}
function editUser(userInfo,callback){$http.post('/user/edit',userInfo).success(function(data){callback(data);}).error(function(data){callback(data);});}
$scope.selectSearchMode=function(mode){$scope.searchMode=searchMode[mode];};var getDevice=function(user){$http.get('/info/device/'+user._id).success(function(data){if(data&&data!==false&&data!=='false'){data.forEach(function(device){if(device.platform===1){if(!user.hasAndroid){user.hasAndroid=true;}}else if(device.platform===2){if(!user.hasIos){user.hasIos=true;}}else if(device.appId===5){if(!user.hasWindows){user.hasWindows=true;}}else if(device.appId===4){if(!user.hasWp){user.hasWp=true;}}else if(device.platform===6){if(!user.hasOsx){user.hasOsx=true;}}else if(device.platform===7){if(!user.hasWeb){user.hasWeb=true;}}});}}).error(function(){alert("Error from server");});};var getCountry=function(user){if(user.tags){user.tags.forEach(function(tag){if(tag){if(tag.indexOf('country')!==-1){user.flag=tag.split(':')[1];}}});}};$scope.findAndExportCsv=function(keyword){if(!keyword)return alert('Please type the keyword to search');var kw=keyword.trim();var ok=confirm("Confirm your keyword: '"+kw+"'. Are you sure?");if(!ok)return;if(kw.indexOf('tag ')!=-1){kw=kw.slice(4).toLowerCase();$http.post('/users/find-and-export-to-csv',{tags:kw}).success(function(result){if(!result.s)alert("Export failed");else{$scope.isWaitingFile=true;alertModal('The request is being processed. You will be notified whenever it done');}}).error(function(){alert("Error From Server");});}else return alert('Keyword invalid');};$scope.search=function(keyword){var url='/users?search='+encodeURIComponent(keyword);location.href=url;};$scope.searchKey=function(event,keyword){if(event.keyCode!=13){return;}
var url='/users?search='+encodeURIComponent(keyword);location.href=url;};function search(keyword,skip,limit){if(!keyword)return;$scope.isLoading=true;$scope.listUser=[];if(keyword.indexOf('tag ')!=-1){var kw=keyword.slice(4).toLowerCase();$http.post('/user/find-by-tag',{tags:kw,limit:limit,skip:skip}).success(function(result){$scope.isLoading=false;if(result.s){$scope.isSearchPage=true;$scope.noResult=result.d.length===0;$scope.listUser=result.d;$scope.listUser.forEach(function(user,index){if(user){getDevice(user);getCountry(user);}else $scope.listUser[index]={};});if(result.t)$scope.resultAmount=result.t;checkFirstLastPage();}}).error(function(){alert('Error From Server');});}else{var mode;if(validateEmail(keyword))mode=1;else mode=0;var condition={};if(keyword.toLowerCase().indexOf('userid:')!==-1){condition._id=keyword.split(":")[1].toLowerCase();mode=1;}else{condition.email=keyword.toLowerCase();}
var newLimit={limit:limit,offset:skip};searchController(condition,mode,newLimit,function(data){$scope.isLoading=false;if(data.error)$scope.errorMsg=data.error;else{$scope.isSearchPage=true;$scope.noResult=data.data.length===0;data.data.forEach(function(user){getDevice(user);getCountry(user);});$scope.listUser=data.data;$scope.resultAmount=data.total;checkFirstLastPage();}});}}
$scope.backToList=function(){location.href='/users';};$scope.getListUser=function(options){var query={limit:limit,offset:offset};if(options){if(options.subscription)query.subscription=options.subscription;}
getUserList(query,function(data){$scope.isSearchPage=false;$scope.noResult=data.data.length===0;data.data.forEach(function(user){getDevice(user);getCountry(user);});$scope.listUser=data.data;if(data.total){$scope.tableName+=" (total: "+data.total+")";}
checkFirstLastPage();});};$scope.nextPage=function(status){$scope.page+=status;offset=($scope.page-1)*limit;if($scope.isSearchPage){search(this.keyword,offset,limit);}else{$scope.getListUser({subscription:$scope.subscription});}};$scope.userDetailsPage=function(user){location.href="/info/user/"+user.email;};$scope.changePurchased=function(user){var purchased=user.purchased?false:true;var s=confirm('Bạn thực sự muốn thực hiện thay đổi này?');if(s){user.purchased=purchased;editUser(user,function(data){});}};$scope.changeCustomerSupport=function(user){var s=confirm("Do you want to enable Customer Support Mode for "+user.email+"?");if(s){$http.post('/user/set-customer-support',{userId:user._id,status:true}).success(function(result){if(result.s){user.customerSupport=true;}else alert("Setting customer support failed");}).error(function(){alert('Error From Server');});}};$scope.changeSync=function(user){var acceptSync=user.acceptSync?false:true;var s=confirm('Bạn thực sự muốn thực hiện thay đổi này?');if(s){user.acceptSync=acceptSync;user.sendMail=true;editUser(user,function(data){});}};$scope.showSearchMobile=function(){var modalInstance=$modal.open({templateUrl:'/partials/users/searchMobile.html',controller:modalController,});};var modalController=function($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss('cancel');};$scope.search=function(keyword){offset=0;search(keyword.trim(),offset,limit);$scope.cancel();};};$scope.acceptPurchased=function(userInfo){var modalInstance=$modal.open({templateUrl:'/partials/users/reason.html',controller:ctrlAcceptPurchased,resolve:{userInfo:function(){return userInfo;}}});modalInstance.result.then(function(user){userInfo=user;},function(){});};var ctrlAcceptPurchased=function($scope,Page,$modalInstance,userInfo){$scope.userInfo=userInfo;$scope.setPurchased=function(userInfo){var purchased=userInfo.purchased?false:true;var s=confirm('Bạn thực sự muốn thực hiện thay đổi này?');if(s){userInfo.purchased=purchased;editUser(userInfo,function(data){if(!data.err){var action="";if(purchased){action="free -> premium";}else{action="premium -> free";}
$http.post('/premiumlog/savelog',{email:userInfo.email,action:action}).success(function(data){if(data.s){$modalInstance.close(userInfo);}}).error(function(){alert("Error while save admin action");$modalInstance.close(userInfo);});}});}};$scope.cancel=function(){$modalInstance.dismiss('cancel');};};function alertModal(message){var modalInstance=$modal.open({templateUrl:'alert.html',controller:ctrlAlert,resolve:{message:function(){return message;}}});modalInstance.result.then(function(){});}
function ctrlAlert($scope,$modalInstance,message){$scope.message=message;$scope.cancel=function(){$modalInstance.dismiss('cancel');};}
function validateEmail(email){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return re.test(email);}
$scope.deleteUser=function(user,index){if($scope.env=='production')return 0;var ok=confirm("User "+user.email+'will be deleted, are you sure?');if(ok){$http.post('/user/delete-user',{userId:user._id}).success(function(result){if(result.s)$scope.listUser.splice(index,1);else alert("Delete user failed or you do not have permission to do this");}).error(function(){alert("Error From Server");});}};init();function init(){var params=$location.search();if(params.search){$scope.keyword=params.search;search(params.search,0,limit);}else if(params.subscription){if(['linked-wallet','premium','no-linked-wallet','no-premium'].indexOf(params.subscription)===-1){alert('Data not found');return $scope.getListUser();}
$scope.subscription=params.subscription;$scope.getListUser({subscription:params.subscription});}else{$scope.getListUser();}}})}(angular,location));(function($a){'use strict';$a.module('ML').controller('walletDiagnosis',function($scope,$rootScope,$routeParams,$http){$rootScope.tabSelect=2;$rootScope.MLPageDetail='Wallet Diagnosis';$scope.loadingPermission=false;$scope.loadingDiagnose=false;$scope.permissionInfo=[];$scope.totalCreate=0;$scope.totalDelete=0;$scope.walletInfo={};init();function init(){if(!$routeParams.walletid)return;getInfo($routeParams.walletid);getPermission($routeParams.walletid);getTransactionChart($routeParams.walletid);}
function getInfo(walletId){$http.post('/wallet-diagnosis/wallet-info',{walletId:walletId}).success(function(result){if(result.s)$scope.walletInfo=result.d;$rootScope.MLPageDetail=$scope.walletInfo.name+' '+$rootScope.MLPageDetail;}).error(function(){alert("Error From Server");});}
function getPermission(walletId){$scope.loadingPermission=true;$http.post('/wallet-diagnosis/wallet-permission',{walletId:walletId}).success(function(result){$scope.loadingPermission=false;if(result.s)$scope.permissionInfo=result.d;else alert('Get permission info due to error');}).error(function(){$scope.loadingPermission=true;alert("Error From Server");});}
function getTransactionChart(walletId){$scope.loadingDiagnose=true;$http.post('/wallet-diagnosis/transaction-count',{walletId:walletId}).success(function(result){if(!result.s){return alert('Get Transaction chart failed');}
if(!result.d){return console.log('no_data');}
$scope.totalCreate=result.d.totalAdd;$scope.totalDelete=result.d.totalDelete;var data=processData(result.d);new Morris.Area({element:'transactionCreateChart',data:data,grid:false,lineWidth:1,parseTime:false,pointSize:0,behaveLikeLine:false,fillOpacity:0.7,smooth:false,xkey:'date',ykeys:['transactionDelete','transaction'],labels:['Delete','Create'],lineColors:['#ed5564','#379ca8']});$scope.loadingDiagnose=false;}).error(function(){$scope.loadingDiagnose=false;alert("Error From Server");})}
function parseData(dataStats){var tmpStats={};dataStats.forEach(function(itemStats){var newItemStat=itemStats.stats.sort(function(obj1,obj2){return obj1.ngay-obj2.ngay;});newItemStat.forEach(function(dayStats){var date=itemStats._id.year+'-'+addZeroNumber(itemStats._id.month)+'-'+addZeroNumber(dayStats.ngay);tmpStats[date]=dayStats.count;});});return tmpStats;}
function processData(data){if(!data.time_range.first||!data.time_range.last){return[];}
var timeCell=generateTimeCell(data.time_range.first,data.time_range.last);var referenceDataCreate=parseData(data.add);var referenceDataDelete=parseData(data.delete);timeCell.forEach(function(cell){cell.transaction=referenceDataCreate[cell.date]||0;cell.transactionDelete=referenceDataDelete[cell.date]||0;});return timeCell;}
function addZeroNumber(num){if(num<10)return'0'+num;else return num;}
function generateTimeCell(start,end){var startDate=moment(start).startOf('day');var endDate=moment(end).startOf('day');var data=[];while(!startDate.isSame(endDate)){var date=startDate.format('DD/MM/YYYY');var item={date:date,transactionDelete:0,transaction:0};data.push(item);startDate.add(1,'days');}
data.push({date:endDate.format('DD/MM/YYYY'),transactionDelete:0,transaction:0});return data;}});}(angular));(function($a){'use strict';$a.module('ML').controller('walletstats',function($scope,$rootScope,$http){$rootScope.tabSelect=1;$rootScope.MLPageDetail='Wallet stats';var getWalletStats=function(element){$http.get('/stats/get-wallet-stats').success(function(data){if(data.s){Morris.Bar({element:element,data:data.d,xkey:'y',ykeys:['value'],labels:['Wallet']});}else{}}).error(function(data){alert("Error From Server");})};$scope.getWalletStats=function(element){getWalletStats(element);}})}(angular));