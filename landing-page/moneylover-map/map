<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Money Lover Sync Map</title>
  <link href='https://fonts.googleapis.com/css?family=Roboto:500,400,300,700&subset=latin,vietnamese' rel='stylesheet' type='text/css'>
  <style>
    html, body {
      height: 100%;
      margin: 0px;
      padding: 0px
    }

    #info {
      height: 176px;
      background-color: #2BAF2B;
      background-image: url("img_app_logo.png");
      background-repeat: no-repeat;
      background-position: center;
    }

    #content {
      margin-left: 32px;
      padding-top: 28px;
    }

    #map-canvas {
      height:80%;
    }

    #left-content {
      float: left;
      width: 50%;
      min-width: 640px;
    }

    .title{
      color: rgba(255,255,255,0.54);
      font-size: 34px;
      font-family: 'Roboto', sans-serif;
      font-weight: 400;
    }

    .stats {
      color: #FFF;
      font-size: 72px;
      font-family: 'Roboto', sans-serif;
      font-weight: 700;
      margin-top: -10px;
    }
  </style>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
  <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/src/markerclusterer.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
  <script type="text/javascript" src="jquery.countTo.js"></script>
  <script>
    var gmarkers = [];
    var skip = 0;
    var limit = 100;
    var map;
    var hostUrl = 'https://nsfw.moneylover.me';
    var iconBaseUrl = 'http://static.moneylover.me/img/icon/';
    var dataProcess = function(data){
      data.forEach(function(item){
        if(null == item.category) return;
        else {
          var marker = buildToMarker(item);
          marker.setMap(map);
          gmarkers.push(marker);
          google.maps.event.addListener(marker, 'click', function() {
            map.setZoom(9);
            map.panTo(marker.getPosition());
          });
        }
      });
    };

    var buildToMarker = function(item){
      var latlng = new google.maps.LatLng(item.latitude,item.longtitude);
      var category = item.category;
      var pinIcon = new google.maps.MarkerImage(
        buildCategoryIconLink(category.icon),
        null, /* size is determined at runtime */
        null, /* origin is 0,0 */
        null, /* anchor is bottom center of the scaled image */
        new google.maps.Size(40, 40)
        );  

      var title = item.address ? category.name + ' - ' + item.address : category.name;

      return new google.maps.Marker({
        position: latlng,
        title: title,
        icon: pinIcon,
        animation: google.maps.Animation.DROP
      });
    };

    var buildCategoryIconLink = function(icon){
      return iconBaseUrl + icon + '.png';
    };

    var startMap = function(){
      var callback = function(data){
        var size = data.length;
        // var audio = document.getElementsByTagName("audio")[0];
        // audio.play();

        if(gmarkers.length > 10000){
          gmarkers.splice(0, 10000);
        };


        if(size > 0) {
          skip += size;
          console.log(skip);
          getData(limit, skip, callback);
        } else {
          var mc = new MarkerClusterer(map, gmarkers); 
        }

        dataProcess(data);
      };

      if(skip > 0){
        setTimeout(getData(limit, skip, callback),2000);
      } else {
        getData(limit, skip, callback);
      }
    };

    var getData = function(limit, skip, callback){
      $.ajax({
        url: hostUrl + '/location/all/'+ limit +'/' + skip + '/abc',
        jsonp: "abc",
        crossDomain:true, 
        dataType: "jsonp",
        success: callback
      });
    };

    var getStats = function(callback){
      $.ajax({
        url: hostUrl + '/stats/count',
        jsonp: "abc",
        crossDomain:true, 
        dataType: "jsonp",
        success: callback
      });
    }


    $(document).ready(function(){
      var userStat = $('#userStat');
      var transactionStat = $('#transactionStat');
      var numUser = 0;
      var numTran = 0;
      var formatter = function (value, options) {
            return numeral(value).format('0,0');
        };

      var callback = function(data){
        console.log('load stats');
        
        userStat.countTo({
          from: numUser,
          to: data.data.users,
          formatter: formatter
        });

        transactionStat.countTo({
          from: numTran,
          to: data.data.transactions,
          formatter: formatter
        });
        
        numTran = data.data.transactions;
        numUser = data.data.users;
      };

      setInterval(function(){
        getStats(callback);
      }, 10000);

      var berlin = new google.maps.LatLng(24.046464, 7.954102);

      function initialize() {
        var mapOptions = {
          zoom: 3,
          center: berlin
        };

        map = new google.maps.Map(document.getElementById('map-canvas'),
          mapOptions);
        startMap();
      }


      google.maps.event.addDomListener(window, 'load', initialize);

    });
  </script>
</head>
<body>
	<div id="info">
   <div id="content">
     <div id="left-content" class="box-content">
       <div class="title">Users</div>
       <div id="userStat" class="stats">0</div>
     </div>
     <div id="right-content" class="box-content">
       <div class="title">Transactions</div>
       <div id="transactionStat" class="stats">0</div>
     </div>
   </div>
 </div>
 <div id="map-canvas"/>
 <audio id="notifSound" type="audio/mpeg">
  <source src="notification.mp3"></source>
</audio>
</body>
</html>